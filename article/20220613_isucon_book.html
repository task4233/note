<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ISUCON本のメモ | Note</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/imgs/icons/icon.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="shortcut icon" href="/imgs/icons/favicon.ico">
    <meta name="description" content="ISUCON本のメモ">
    <meta name="theme-color" content="#3eaf7c">
    
    <link rel="preload" href="/assets/css/0.styles.e16f9711.css" as="style"><link rel="preload" href="/assets/js/app.743ef69c.js" as="script"><link rel="preload" href="/assets/js/2.8c86708f.js" as="script"><link rel="preload" href="/assets/js/3.693800c4.js" as="script"><link rel="preload" href="/assets/js/44.cbe6deb9.js" as="script"><link rel="preload" href="/assets/js/4.cc429872.js" as="script"><link rel="prefetch" href="/assets/js/10.1831c564.js"><link rel="prefetch" href="/assets/js/11.e3cb858e.js"><link rel="prefetch" href="/assets/js/12.f691f405.js"><link rel="prefetch" href="/assets/js/13.e122abd7.js"><link rel="prefetch" href="/assets/js/14.bdabc596.js"><link rel="prefetch" href="/assets/js/15.3695a197.js"><link rel="prefetch" href="/assets/js/16.867ed167.js"><link rel="prefetch" href="/assets/js/17.9bd06323.js"><link rel="prefetch" href="/assets/js/18.4a5f8151.js"><link rel="prefetch" href="/assets/js/19.ded22c6d.js"><link rel="prefetch" href="/assets/js/20.29a3d5f9.js"><link rel="prefetch" href="/assets/js/21.c3aab69d.js"><link rel="prefetch" href="/assets/js/22.f19c35dc.js"><link rel="prefetch" href="/assets/js/23.58111946.js"><link rel="prefetch" href="/assets/js/24.71f4337e.js"><link rel="prefetch" href="/assets/js/25.9643d58f.js"><link rel="prefetch" href="/assets/js/26.18166fa0.js"><link rel="prefetch" href="/assets/js/27.e0c3d18b.js"><link rel="prefetch" href="/assets/js/28.54309732.js"><link rel="prefetch" href="/assets/js/29.8c3c77ec.js"><link rel="prefetch" href="/assets/js/30.eafc7451.js"><link rel="prefetch" href="/assets/js/31.cf50a740.js"><link rel="prefetch" href="/assets/js/32.de0580cd.js"><link rel="prefetch" href="/assets/js/33.9a4cb3ea.js"><link rel="prefetch" href="/assets/js/34.762a7aa9.js"><link rel="prefetch" href="/assets/js/35.797be974.js"><link rel="prefetch" href="/assets/js/36.47b6758d.js"><link rel="prefetch" href="/assets/js/37.eb6f6642.js"><link rel="prefetch" href="/assets/js/38.e780ee89.js"><link rel="prefetch" href="/assets/js/39.67063473.js"><link rel="prefetch" href="/assets/js/40.0c6c5764.js"><link rel="prefetch" href="/assets/js/41.1926a20f.js"><link rel="prefetch" href="/assets/js/42.f4f3ac7c.js"><link rel="prefetch" href="/assets/js/43.35d22cd8.js"><link rel="prefetch" href="/assets/js/45.f0551247.js"><link rel="prefetch" href="/assets/js/46.6dac12cb.js"><link rel="prefetch" href="/assets/js/47.5bc92527.js"><link rel="prefetch" href="/assets/js/48.2818f26e.js"><link rel="prefetch" href="/assets/js/49.b44c0060.js"><link rel="prefetch" href="/assets/js/5.a7b3795e.js"><link rel="prefetch" href="/assets/js/50.b5d1c090.js"><link rel="prefetch" href="/assets/js/51.bee0f371.js"><link rel="prefetch" href="/assets/js/52.862ad608.js"><link rel="prefetch" href="/assets/js/53.b897ea6f.js"><link rel="prefetch" href="/assets/js/54.e9b8553f.js"><link rel="prefetch" href="/assets/js/55.6d4c045b.js"><link rel="prefetch" href="/assets/js/56.4e40079d.js"><link rel="prefetch" href="/assets/js/57.0b43069c.js"><link rel="prefetch" href="/assets/js/58.a5d5286a.js"><link rel="prefetch" href="/assets/js/59.ab2ee1c1.js"><link rel="prefetch" href="/assets/js/6.7dcfc0df.js"><link rel="prefetch" href="/assets/js/60.442c6d22.js"><link rel="prefetch" href="/assets/js/61.0c16498f.js"><link rel="prefetch" href="/assets/js/62.07751717.js"><link rel="prefetch" href="/assets/js/63.dbaec0a5.js"><link rel="prefetch" href="/assets/js/64.5fc1b4f7.js"><link rel="prefetch" href="/assets/js/65.770f12f0.js"><link rel="prefetch" href="/assets/js/66.44223adc.js"><link rel="prefetch" href="/assets/js/67.0d43fb9d.js"><link rel="prefetch" href="/assets/js/68.53f059eb.js"><link rel="prefetch" href="/assets/js/69.5c775b20.js"><link rel="prefetch" href="/assets/js/7.c819681e.js"><link rel="prefetch" href="/assets/js/70.fad264db.js"><link rel="prefetch" href="/assets/js/71.c9bce44e.js"><link rel="prefetch" href="/assets/js/72.04a5e8d2.js"><link rel="prefetch" href="/assets/js/73.cb23c684.js"><link rel="prefetch" href="/assets/js/74.cc7436cf.js"><link rel="prefetch" href="/assets/js/75.80e4afd7.js"><link rel="prefetch" href="/assets/js/76.73de9d33.js"><link rel="prefetch" href="/assets/js/77.a6782b30.js"><link rel="prefetch" href="/assets/js/78.df1a2f88.js"><link rel="prefetch" href="/assets/js/79.35ed3b0a.js"><link rel="prefetch" href="/assets/js/8.8fb78f1d.js"><link rel="prefetch" href="/assets/js/80.40ceedcb.js"><link rel="prefetch" href="/assets/js/81.3157359e.js"><link rel="prefetch" href="/assets/js/82.9c0946ef.js"><link rel="prefetch" href="/assets/js/83.8751f0bf.js"><link rel="prefetch" href="/assets/js/84.be1a9ef9.js"><link rel="prefetch" href="/assets/js/85.19d7fbcd.js"><link rel="prefetch" href="/assets/js/86.05e80afb.js"><link rel="prefetch" href="/assets/js/87.9bf27c8f.js"><link rel="prefetch" href="/assets/js/88.51f8cda4.js"><link rel="prefetch" href="/assets/js/89.6bf98237.js"><link rel="prefetch" href="/assets/js/9.2941a322.js"><link rel="prefetch" href="/assets/js/90.279f66f1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e16f9711.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/#links" class="nav-link">Links</a></div><div class="nav-item"><a href="/tags/" class="nav-link">Articles</a></div><div class="nav-item"><a href="/chukapi_fun_art.html" class="nav-link">Chukapi-Fun-Art</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/#links" class="nav-link">Links</a></div><div class="nav-item"><a href="/tags/" class="nav-link">Articles</a></div><div class="nav-item"><a href="/chukapi_fun_art.html" class="nav-link">Chukapi-Fun-Art</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>ISUCON本のメモ</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/article/20220613_isucon_book.html#references" class="sidebar-link">References</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/article/20220613_isucon_book.html#_1章-チューニングの基礎知識" class="sidebar-link">1章 チューニングの基礎知識</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/article/20220613_isucon_book.html#パフォーマンスチューニングの基本のき" class="sidebar-link">パフォーマンスチューニングの基本のき</a></li><li class="sidebar-sub-header"><a href="/article/20220613_isucon_book.html#パフォーマンスチューニングの基本のほ" class="sidebar-link">パフォーマンスチューニングの基本のほ</a></li><li class="sidebar-sub-header"><a href="/article/20220613_isucon_book.html#パフォーマンスチューニングの基本のん" class="sidebar-link">パフォーマンスチューニングの基本のん</a></li></ul></li><li><a href="/article/20220613_isucon_book.html#_2章-モニタリング" class="sidebar-link">2章 モニタリング</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/article/20220613_isucon_book.html#_3-基礎的な負荷試験" class="sidebar-link">3. 基礎的な負荷試験</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/article/20220613_isucon_book.html#_4-シナリオを持った負荷試験" class="sidebar-link">4. シナリオを持った負荷試験</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/article/20220613_isucon_book.html#_5-データベースのチューニング" class="sidebar-link">5. データベースのチューニング</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/article/20220613_isucon_book.html#_6-リバースプロキシの利用" class="sidebar-link">6. リバースプロキシの利用</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/article/20220613_isucon_book.html#_7-キャッシュの活用" class="sidebar-link">7. キャッシュの活用</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/article/20220613_isucon_book.html#_8-押さえておきたい高速化手法" class="sidebar-link">8. 押さえておきたい高速化手法</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/article/20220613_isucon_book.html#_9-osの基礎知識とチューニング" class="sidebar-link">9. OSの基礎知識とチューニング</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/article/20220613_isucon_book.html#private-isuの攻略" class="sidebar-link">private-isuの攻略</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="isucon本のメモ"><a href="#isucon本のメモ" class="header-anchor">#</a> ISUCON本のメモ</h1> <p>💡
これはISUCON本を読んだ時に思ったことや新しく知ったことを言葉に起こすために使うメモです。雑多に書きます。</p> <h2 id="references"><a href="#references" class="header-anchor">#</a> References</h2> <ul><li>藤原 et al., &quot;達人が教えるWebパフォーマンスチューニング〜ISUCONから学ぶ高速化の実践&quot;, 2022, ISBN 978-4-297-12846-3.</li> <li><a href="https://github.com/task4233/private-isu" target="_blank" rel="noopener noreferrer">GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://gist.github.com/south37/d4a5a8158f49e067237c17d13ecab12a" target="_blank" rel="noopener noreferrer">ISUCON Cheat Sheet<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="_1章-チューニングの基礎知識"><a href="#_1章-チューニングの基礎知識" class="header-anchor">#</a> 1章 チューニングの基礎知識</h2> <ul><li>垂直スケーリング(スケールアップ/ダウン)
<ul><li>サーバの性能を向上/低下させること</li></ul></li> <li>水平スケーリング(スケールアウト/イン)
<ul><li>サーバの数を増加/減少させること</li></ul></li></ul> <h3 id="パフォーマンスチューニングの基本のき"><a href="#パフォーマンスチューニングの基本のき" class="header-anchor">#</a> <strong>パフォーマンスチューニングの基本のき</strong></h3> <ul><li><p><strong>いきなり手を動かさない</strong></p></li> <li><p><strong>勘で行動しない</strong></p></li> <li><p><strong>「基本のき」から「基本のん」まで読んでから、考えて、行動する</strong></p></li> <li><p>推測せず計測する</p> <ul><li>指標
<ul><li>システムリソース利用状況</li> <li>レイテンシ</li> <li>スループット</li></ul></li> <li>負荷試験をする際に、与負荷側のシステムのパフォーマンス不足が律速原因になることがある</li></ul></li> <li><p>公平に比較する</p> <ul><li>ネットワークの回線が原因でパフォーマンスが低下することもある</li></ul></li> <li><p>1つずつ比較する</p> <ul><li>まとめて施策を適用すると、どの施策が刺さったのかが分からなくなる</li> <li>PRは1つずつマージして指標を取る</li></ul></li></ul> <h3 id="パフォーマンスチューニングの基本のほ"><a href="#パフォーマンスチューニングの基本のほ" class="header-anchor">#</a> パフォーマンスチューニングの基本のほ</h3> <ul><li><p><strong>ボトルネックだけにアプローチする</strong></p> <ul><li>レジが混んでいるのに、入り口と店内を広くしても時間当たりの売り上げは上がらない</li> <li>最悪、パフォーマンスが落ちる</li></ul></li> <li><p><strong>ボトルネックの特定は外側から順番に</strong></p> <ul><li>Webサービスにおける入出力の一番外側から見る
<ul><li>所要時間が長い箇所</li> <li>システムリソースの利用率が高い箇所</li></ul></li> <li>ボトルネックになりがちな箇所
<ul><li>CPU</li> <li>メモリ</li> <li>ディスクI/O</li> <li>ネットワークI/O</li></ul></li></ul></li> <li><p><strong>ボトルネック対処の基本3パターン</strong></p> <ol><li><p>解決</p> <p>課題になっている事象を根本から解決する</p></li> <li><p>回避</p> <p>課題になっている事象がボトルネックにならないように迂回・省略する</p></li> <li><p>緩和</p> <p>課題になっている事象の影響を和らげる</p></li></ol> <ul><li>対応コストは回避 &lt; 緩和</li></ul></li></ul> <h3 id="パフォーマンスチューニングの基本のん"><a href="#パフォーマンスチューニングの基本のん" class="header-anchor">#</a> パフォーマンスチューニングの基本のん</h3> <ul><li>高速化の具体的な活動
<ol><li>負荷試験計画</li> <li>実施準備</li> <li>負荷試行→結果確認→改善→負荷試行→…</li></ol></li> <li>負荷試験の計画(項目はP19)
<ul><li><strong>必ず定めて！！！</strong></li> <li><strong>何のために(目的)？</strong></li> <li><strong>どのように(方法)？</strong></li> <li><strong>どの程度まで(ゴール)？</strong></li></ul></li> <li>被負荷環境の準備
<ul><li>負荷をかけながら手動で使用感を確かめるのもアリ</li> <li>実施時間・実施結果・メトリクス・ログをセットで自動で記録しておくと良い
<ul><li>ダッシュボードの日時指定機能でURLを生成する</li> <li>Slack/DiscordにPostするようにしておく</li></ul></li> <li>実施結果を都度解釈する
<ul><li>パフォーマンス: X並列でYユーザがN分間で操作完了</li> <li>異常の有無: エラーレスポンス、システムエラー、不審な挙動、不安定なレスポンスタイム</li> <li>ボトルネックの移動有無</li> <li>それぞれの値、リソースメトリクスの値が想定通り変化したか</li></ul></li></ul></li></ul> <h2 id="_2章-モニタリング"><a href="#_2章-モニタリング" class="header-anchor">#</a> 2章 モニタリング</h2> <ul><li><p>外形監視</p> <ul><li>Webサービスの外からモニタリングする手法</li> <li>ネットワーク的な接続トラブルの発見に有効だが、完全な再現は現実的ではない</li></ul></li> <li><p>内部監視</p> <ul><li>Webサービスのアプリケーションの内側からモニタリングする手法</li> <li>外部ユーザが見れない、リソースのメトリクス等を監視できる</li> <li>pull型(Prometheus)
<ul><li>モニタリングアプリケーション(以下MA)が各エージェントからメトリクスをpullしてくる</li> <li>メリット
<ul><li>MA側で取得間隔を管理できる</li> <li>エージェントの実装をシンプルにできる</li></ul></li></ul></li> <li>push型
<ul><li>各エージェントがモニタリングアプリケーションに対してメトリクスをpushする</li> <li>メリット
<ul><li>サーバ側のポートを開けずに済む</li> <li>エージェントの管理をせずに済む</li></ul></li></ul></li></ul></li> <li><p>使えるコマンド</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">:</span> マルチコアCPU使用率の収集
mpstat -P ALL

<span class="token builtin class-name">:</span> メモリ使用率上位5件のプロセスの収集
<span class="token function">ps</span> aux --sort -%mem <span class="token operator">|</span> <span class="token function">head</span> -5

<span class="token builtin class-name">:</span> メモリ使用率の収集
<span class="token function">free</span> -m
</code></pre></div></li> <li><p>割合(%)の変動具合を比較しないこと</p> <ul><li>15%増と10%増は、そもそもベースラインが異なる可能性があるので比較しても意味がない</li></ul></li> <li><p>同じサーバ内から負荷試験を行わないこと</p> <ul><li>検証対象のリソースを使うので、それはそう</li></ul></li></ul> <h2 id="_3-基礎的な負荷試験"><a href="#_3-基礎的な負荷試験" class="header-anchor">#</a> 3. 基礎的な負荷試験</h2> <ul><li>alp</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>alp json --file access.log
</code></pre></div><ul><li><p>ab</p></li> <li><p>abとalpの比較</p> <p>abの <code>Time per request</code> とalpの <code>avg</code> が同じくらいになっていることを確認する</p> <p>abの結果</p> <div class="language-bash extra-class"><pre class="language-bash"><code>% ab -c <span class="token number">1</span> -n <span class="token number">10</span> http://localhost/                                                                                                                                      <span class="token punctuation">[</span>~/work/private-isu/webapp<span class="token punctuation">]</span>+<span class="token punctuation">[</span>master<span class="token punctuation">]</span>
This is ApacheBench, Version <span class="token number">2.3</span> <span class="token operator">&lt;</span><span class="token variable">$Revision</span><span class="token builtin class-name">:</span> <span class="token number">1879490</span> $<span class="token operator">&gt;</span>
Copyright <span class="token number">1996</span> Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/

Benchmarking localhost <span class="token punctuation">(</span>be patient<span class="token punctuation">)</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.done

Server Software:        nginx/1.22.0
Server Hostname:        localhost
Server Port:            <span class="token number">80</span>

Document Path:          /
Document Length:        <span class="token number">35054</span> bytes

Concurrency Level:      <span class="token number">1</span>
Time taken <span class="token keyword">for</span> tests:   <span class="token number">23.625</span> seconds
Complete requests:      <span class="token number">10</span>
Failed requests:        <span class="token number">0</span>
Total transferred:      <span class="token number">354170</span> bytes
HTML transferred:       <span class="token number">350540</span> bytes
Requests per second:    <span class="token number">0.42</span> <span class="token punctuation">[</span><span class="token comment">#/sec] (mean)</span>
**Time per request:       <span class="token number">2362.545</span> <span class="token punctuation">[</span>ms<span class="token punctuation">]</span> <span class="token punctuation">(</span>mean<span class="token punctuation">)</span>**
Time per request:       <span class="token number">2362.545</span> <span class="token punctuation">[</span>ms<span class="token punctuation">]</span> <span class="token punctuation">(</span>mean, across all concurrent requests<span class="token punctuation">)</span>
Transfer rate:          <span class="token number">14.64</span> <span class="token punctuation">[</span>Kbytes/sec<span class="token punctuation">]</span> received

Connection Times <span class="token punctuation">(</span>ms<span class="token punctuation">)</span>
              min  mean<span class="token punctuation">[</span>+/-sd<span class="token punctuation">]</span> median   max
Connect:        <span class="token number">0</span>    <span class="token number">0</span>   <span class="token number">0.1</span>      <span class="token number">0</span>       <span class="token number">0</span>
Processing:  <span class="token number">1758</span> <span class="token number">2362</span> <span class="token number">982.9</span>   <span class="token number">1899</span>    <span class="token number">4597</span>
Waiting:     <span class="token number">1758</span> <span class="token number">2361</span> <span class="token number">982.4</span>   <span class="token number">1899</span>    <span class="token number">4595</span>
Total:       <span class="token number">1758</span> <span class="token number">2362</span> <span class="token number">982.9</span>   <span class="token number">1899</span>    <span class="token number">4597</span>

Percentage of the requests served within a certain <span class="token function">time</span> <span class="token punctuation">(</span>ms<span class="token punctuation">)</span>
  <span class="token number">50</span>%   <span class="token number">1899</span>
  <span class="token number">66</span>%   <span class="token number">2025</span>
  <span class="token number">75</span>%   <span class="token number">2378</span>
  <span class="token number">80</span>%   <span class="token number">3706</span>
  <span class="token number">90</span>%   <span class="token number">4597</span>
  <span class="token number">95</span>%   <span class="token number">4597</span>
  <span class="token number">98</span>%   <span class="token number">4597</span>
  <span class="token number">99</span>%   <span class="token number">4597</span>
 <span class="token number">100</span>%   <span class="token number">4597</span> <span class="token punctuation">(</span>longest request<span class="token punctuation">)</span>
</code></pre></div><p>alpの結果</p> <div class="language-bash extra-class"><pre class="language-bash"><code>% <span class="token function">tail</span> -n <span class="token number">10</span> logs/nginx/access.log<span class="token operator">|</span> alp json -o count,method,uri,min,avg,max
+-------+--------+-----+-------+-------+-------+
<span class="token operator">|</span> COUNT <span class="token operator">|</span> METHOD <span class="token operator">|</span> URI <span class="token operator">|</span>  MIN  <span class="token operator">|</span>  AVG  <span class="token operator">|</span>  MAX  <span class="token operator">|</span>
+-------+--------+-----+-------+-------+-------+
<span class="token operator">|</span>    <span class="token number">10</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /   <span class="token operator">|</span> <span class="token number">1.755</span> <span class="token operator">|</span> **2.357** <span class="token operator">|</span> <span class="token number">4.590</span> <span class="token operator">|</span>
+-------+--------+-----+-------+-------+-------+
</code></pre></div></li> <li><p>mysqldumpslowとpt-query-digestの比較</p></li> <li><p>mysqldumpslow</p> <div class="language-bash extra-class"><pre class="language-bash"><code>% mysqldumpslow logs/mysql/mysql-slow.log                       <span class="token punctuation">[</span>~/work/private-isu/webapp<span class="token punctuation">]</span>+<span class="token punctuation">[</span>master<span class="token punctuation">]</span>

Reading mysql slow query log from logs/mysql/mysql-slow.log
Count: <span class="token number">1</span>  <span class="token assign-left variable">Time</span><span class="token operator">=</span><span class="token number">0</span>.08s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Lock</span><span class="token operator">=</span><span class="token number">0</span>.00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Rows</span><span class="token operator">=</span><span class="token number">10001.0</span> <span class="token punctuation">(</span><span class="token number">10001</span><span class="token punctuation">)</span>, root<span class="token punctuation">[</span>root<span class="token punctuation">]</span>@webapp_app_1.webapp_default
  SELECT <span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span>, <span class="token variable"><span class="token variable">`</span>user_id<span class="token variable">`</span></span>, <span class="token variable"><span class="token variable">`</span>body<span class="token variable">`</span></span>, <span class="token variable"><span class="token variable">`</span>created_at<span class="token variable">`</span></span>, <span class="token variable"><span class="token variable">`</span>mime<span class="token variable">`</span></span> FROM <span class="token variable"><span class="token variable">`</span>posts<span class="token variable">`</span></span> ORDER BY <span class="token variable"><span class="token variable">`</span>created_at<span class="token variable">`</span></span> DESC

Count: <span class="token number">22</span>  <span class="token assign-left variable">Time</span><span class="token operator">=</span><span class="token number">0</span>.06s <span class="token punctuation">(</span>1s<span class="token punctuation">)</span>  <span class="token assign-left variable">Lock</span><span class="token operator">=</span><span class="token number">0</span>.00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Rows</span><span class="token operator">=</span><span class="token number">2.9</span> <span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span>, root<span class="token punctuation">[</span>root<span class="token punctuation">]</span>@webapp_app_1.webapp_default
  SELECT * FROM <span class="token variable"><span class="token variable">`</span>comments<span class="token variable">`</span></span> WHERE <span class="token variable"><span class="token variable">`</span>post_id<span class="token variable">`</span></span> <span class="token operator">=</span> N ORDER BY <span class="token variable"><span class="token variable">`</span>created_at<span class="token variable">`</span></span> DESC LIMIT N

Count: <span class="token number">22</span>  <span class="token assign-left variable">Time</span><span class="token operator">=</span><span class="token number">0</span>.02s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Lock</span><span class="token operator">=</span><span class="token number">0</span>.00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Rows</span><span class="token operator">=</span><span class="token number">1.0</span> <span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span>, root<span class="token punctuation">[</span>root<span class="token punctuation">]</span>@webapp_app_1.webapp_default
  SELECT COUNT<span class="token punctuation">(</span>*<span class="token punctuation">)</span> AS <span class="token variable"><span class="token variable">`</span>count<span class="token variable">`</span></span> FROM <span class="token variable"><span class="token variable">`</span>comments<span class="token variable">`</span></span> WHERE <span class="token variable"><span class="token variable">`</span>post_id<span class="token variable">`</span></span> <span class="token operator">=</span> N

Count: <span class="token number">20</span>  <span class="token assign-left variable">Time</span><span class="token operator">=</span><span class="token number">0</span>.00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Lock</span><span class="token operator">=</span><span class="token number">0</span>.00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Rows</span><span class="token operator">=</span><span class="token number">1.0</span> <span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>, root<span class="token punctuation">[</span>root<span class="token punctuation">]</span>@webapp_app_1.webapp_default
  SELECT * FROM <span class="token variable"><span class="token variable">`</span>posts<span class="token variable">`</span></span> WHERE <span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span> <span class="token operator">=</span> N

Count: <span class="token number">86</span>  <span class="token assign-left variable">Time</span><span class="token operator">=</span><span class="token number">0</span>.00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Lock</span><span class="token operator">=</span><span class="token number">0</span>.00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Rows</span><span class="token operator">=</span><span class="token number">1.0</span> <span class="token punctuation">(</span><span class="token number">86</span><span class="token punctuation">)</span>, root<span class="token punctuation">[</span>root<span class="token punctuation">]</span>@webapp_app_1.webapp_default
  SELECT * FROM <span class="token variable"><span class="token variable">`</span><span class="token function">users</span><span class="token variable">`</span></span> WHERE <span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span> <span class="token operator">=</span> N

Count: <span class="token number">305</span>  <span class="token assign-left variable">Time</span><span class="token operator">=</span><span class="token number">0</span>.00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Lock</span><span class="token operator">=</span><span class="token number">0</span>.00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Rows</span><span class="token operator">=</span><span class="token number">0.4</span> <span class="token punctuation">(</span><span class="token number">133</span><span class="token punctuation">)</span>, 2users@2hosts
  <span class="token comment">#</span>

Count: <span class="token number">150</span>  <span class="token assign-left variable">Time</span><span class="token operator">=</span><span class="token number">0</span>.00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Lock</span><span class="token operator">=</span><span class="token number">0</span>.00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Rows</span><span class="token operator">=</span><span class="token number">0.0</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>, 0users@0hosts
  administrator command: Prepare

Count: <span class="token number">133</span>  <span class="token assign-left variable">Time</span><span class="token operator">=</span><span class="token number">0</span>.00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Lock</span><span class="token operator">=</span><span class="token number">0</span>.00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Rows</span><span class="token operator">=</span><span class="token number">0.0</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>, 0users@0hosts
  administrator command: Close stmt

Count: <span class="token number">11</span>  <span class="token assign-left variable">Time</span><span class="token operator">=</span><span class="token number">0</span>.00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Lock</span><span class="token operator">=</span><span class="token number">0</span>.00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Rows</span><span class="token operator">=</span><span class="token number">0.0</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>, 0users@0hosts
  administrator command: Ping

Count: <span class="token number">11</span>  <span class="token assign-left variable">Time</span><span class="token operator">=</span><span class="token number">0</span>.00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Lock</span><span class="token operator">=</span><span class="token number">0</span>.00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Rows</span><span class="token operator">=</span><span class="token number">0.0</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>, 0users@0hosts
  administrator command: Quit
</code></pre></div></li> <li><p>pt-query-digest</p> <div class="language-bash extra-class"><pre class="language-bash"><code>pt-query-digest ./logs/mysql/mysql-slow.log                   <span class="token punctuation">[</span>~/work/private-isu/webapp<span class="token punctuation">]</span>+<span class="token punctuation">[</span>master<span class="token punctuation">]</span>

<span class="token comment"># A software update is available:</span>
<span class="token comment">#   * The current version for Percona::Toolkit is 3.0.5</span>

<span class="token comment"># 360ms user time, 140ms system time, 34.92M rss, 4.13G vsz</span>
<span class="token comment"># Current date: Wed Jun  8 23:22:35 2022</span>
<span class="token comment"># Hostname: deadbeef.local</span>
<span class="token comment"># Files: ./logs/mysql/mysql-slow.log</span>
<span class="token comment"># Overall: 460 total, 9 unique, 1.27 QPS, 0.01x concurrency ______________</span>
<span class="token comment"># Time range: 2022-06-08T14:16:23 to 2022-06-08T14:22:24</span>
<span class="token comment"># Attribute          total     min     max     avg     95%  stddev  median</span>
<span class="token comment"># ============     ======= ======= ======= ======= ======= ======= =======</span>
<span class="token comment"># Exec time             2s     4us    88ms     5ms    59ms    15ms   236us</span>
<span class="token comment"># Lock time          465us       0    17us     1us     2us     1us       0</span>
<span class="token comment"># Rows sent          9.95k       0   9.77k   22.16    0.99  444.93       0</span>
<span class="token comment"># Rows examine       4.22M       0  97.66k   9.38k  97.04k  28.54k       0</span>
<span class="token comment"># Query size        16.57k      27      92   36.88   65.89   12.74   31.70</span>

<span class="token comment"># Profile</span>
<span class="token comment"># Rank Query ID           Response time Calls R/Call V/M   Item</span>
<span class="token comment"># ==== ================== ============= ===== ====== ===== ===============</span>
<span class="token comment">#    1 0x16849282195BE09F  1.4162 66.5%    22 0.0644  0.00 SELECT comments</span>
<span class="token comment">#    2 0x7539A5F45EB76A80  0.5197 24.4%    22 0.0236  0.01 SELECT comments</span>
<span class="token comment">#    3 0x44D0B06948A2E5CC  0.0825  3.9%     1 0.0825  0.00 SELECT posts</span>
<span class="token comment">#    4 0x99AA0165670CE848  0.0513  2.4%   150 0.0003  0.00 ADMIN PREPARE</span>
<span class="token comment"># MISC 0xMISC              0.0600  2.8%   265 0.0002   0.0 &lt;5 ITEMS&gt;</span>

<span class="token comment"># Query 1: 11 QPS, 0.71x concurrency, ID 0x16849282195BE09F at byte 20337</span>
<span class="token comment"># This item is included in the report because it matches --limit.</span>
<span class="token comment"># Scores: V/M = 0.00</span>
<span class="token comment"># Time range: 2022-06-08T14:17:38 to 2022-06-08T14:17:40</span>
<span class="token comment"># Attribute    pct   total     min     max     avg     95%  stddev  median</span>
<span class="token comment"># ============ === ======= ======= ======= ======= ======= ======= =======</span>
<span class="token comment"># Count          4      22</span>
<span class="token comment"># Exec time     66      1s    60ms    81ms    64ms    68ms     5ms    61ms</span>
<span class="token comment"># Lock time     12    57us     2us     4us     2us     2us       0     2us</span>
<span class="token comment"># Rows sent      0      64       1       3    2.91    2.90    0.40    2.90</span>
<span class="token comment"># Rows examine  49   2.10M  97.66k  97.66k  97.66k  97.04k       0  97.04k</span>
<span class="token comment"># Query size    10   1.76k      82      83   82.09   80.10    0.00   80.10</span>
<span class="token comment"># String:</span>
<span class="token comment"># Databases    isuconp</span>
<span class="token comment"># Hosts        webapp_app_1.webapp_default</span>
<span class="token comment"># Users        root</span>
<span class="token comment"># Query_time distribution</span>
<span class="token comment">#   1us</span>
<span class="token comment">#  10us</span>
<span class="token comment"># 100us</span>
<span class="token comment">#   1ms</span>
<span class="token comment">#  10ms  ################################################################</span>
<span class="token comment"># 100ms</span>
<span class="token comment">#    1s</span>
<span class="token comment">#  10s+</span>
<span class="token comment"># Tables</span>
<span class="token comment">#    SHOW TABLE STATUS FROM `isuconp` LIKE 'comments'\G</span>
<span class="token comment">#    SHOW CREATE TABLE `isuconp`.`comments`\G</span>
<span class="token comment"># EXPLAIN /*!50100 PARTITIONS*/</span>
SELECT * FROM <span class="token variable"><span class="token variable">`</span>comments<span class="token variable">`</span></span> WHERE <span class="token variable"><span class="token variable">`</span>post_id<span class="token variable">`</span></span> <span class="token operator">=</span> <span class="token number">9995</span> ORDER BY <span class="token variable"><span class="token variable">`</span>created_at<span class="token variable">`</span></span> DESC LIMIT <span class="token number">3</span><span class="token punctuation">\</span>G

<span class="token comment"># Query 2: 11 QPS, 0.26x concurrency, ID 0x7539A5F45EB76A80 at byte 2174 _</span>
<span class="token comment"># This item is included in the report because it matches --limit.</span>
<span class="token comment"># Scores: V/M = 0.01</span>
<span class="token comment"># Time range: 2022-06-08T14:17:38 to 2022-06-08T14:17:40</span>
<span class="token comment"># Attribute    pct   total     min     max     avg     95%  stddev  median</span>
<span class="token comment"># ============ === ======= ======= ======= ======= ======= ======= =======</span>
<span class="token comment"># Count          4      22</span>
<span class="token comment"># Exec time     24   520ms    19ms    88ms    24ms    21ms    14ms    20ms</span>
<span class="token comment"># Lock time     11    55us     2us     4us     2us     2us       0     1us</span>
<span class="token comment"># Rows sent      0      22       1       1       1       1       0       1</span>
<span class="token comment"># Rows examine  49   2.10M  97.66k  97.66k  97.66k  97.66k       0  97.66k</span>
<span class="token comment"># Query size     8   1.40k      65      66   65.09   62.76    0.50   62.76</span>
<span class="token comment"># String:</span>
<span class="token comment"># Databases    isuconp</span>
<span class="token comment"># Hosts        webapp_app_1.webapp_default</span>
<span class="token comment"># Users        root</span>
<span class="token comment"># Query_time distribution</span>
<span class="token comment">#   1us</span>
<span class="token comment">#  10us</span>
<span class="token comment"># 100us</span>
<span class="token comment">#   1ms</span>
<span class="token comment">#  10ms  ################################################################</span>
<span class="token comment"># 100ms</span>
<span class="token comment">#    1s</span>
<span class="token comment">#  10s+</span>
<span class="token comment"># Tables</span>
<span class="token comment">#    SHOW TABLE STATUS FROM `isuconp` LIKE 'comments'\G</span>
<span class="token comment">#    SHOW CREATE TABLE `isuconp`.`comments`\G</span>
<span class="token comment"># EXPLAIN /*!50100 PARTITIONS*/</span>
SELECT COUNT<span class="token punctuation">(</span>*<span class="token punctuation">)</span> AS <span class="token variable"><span class="token variable">`</span>count<span class="token variable">`</span></span> FROM <span class="token variable"><span class="token variable">`</span>comments<span class="token variable">`</span></span> WHERE <span class="token variable"><span class="token variable">`</span>post_id<span class="token variable">`</span></span> <span class="token operator">=</span> <span class="token number">10001</span><span class="token punctuation">\</span>G

<span class="token comment"># Query 3: 0 QPS, 0x concurrency, ID 0x44D0B06948A2E5CC at byte 1595 _____</span>
<span class="token comment"># This item is included in the report because it matches --limit.</span>
<span class="token comment"># Scores: V/M = 0.00</span>
<span class="token comment"># Time range: all events occurred at 2022-06-08T14:17:38</span>
<span class="token comment"># Attribute    pct   total     min     max     avg     95%  stddev  median</span>
<span class="token comment"># ============ === ======= ======= ======= ======= ======= ======= =======</span>
<span class="token comment"># Count          0       1</span>
<span class="token comment"># Exec time      3    82ms    82ms    82ms    82ms    82ms       0    82ms</span>
<span class="token comment"># Lock time      3    17us    17us    17us    17us    17us       0    17us</span>
<span class="token comment"># Rows sent     98   9.77k   9.77k   9.77k   9.77k   9.77k       0   9.77k</span>
<span class="token comment"># Rows examine   0  19.53k  19.53k  19.53k  19.53k  19.53k       0  19.53k</span>
<span class="token comment"># Query size     0      92      92      92      92      92       0      92</span>
<span class="token comment"># String:</span>
<span class="token comment"># Databases    isuconp</span>
<span class="token comment"># Hosts        webapp_app_1.webapp_default</span>
<span class="token comment"># Users        root</span>
<span class="token comment"># Query_time distribution</span>
<span class="token comment">#   1us</span>
<span class="token comment">#  10us</span>
<span class="token comment"># 100us</span>
<span class="token comment">#   1ms</span>
<span class="token comment">#  10ms  ################################################################</span>
<span class="token comment"># 100ms</span>
<span class="token comment">#    1s</span>
<span class="token comment">#  10s+</span>
<span class="token comment"># Tables</span>
<span class="token comment">#    SHOW TABLE STATUS FROM `isuconp` LIKE 'posts'\G</span>
<span class="token comment">#    SHOW CREATE TABLE `isuconp`.`posts`\G</span>
<span class="token comment"># EXPLAIN /*!50100 PARTITIONS*/</span>
SELECT <span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span>, <span class="token variable"><span class="token variable">`</span>user_id<span class="token variable">`</span></span>, <span class="token variable"><span class="token variable">`</span>body<span class="token variable">`</span></span>, <span class="token variable"><span class="token variable">`</span>created_at<span class="token variable">`</span></span>, <span class="token variable"><span class="token variable">`</span>mime<span class="token variable">`</span></span> FROM <span class="token variable"><span class="token variable">`</span>posts<span class="token variable">`</span></span> ORDER BY <span class="token variable"><span class="token variable">`</span>created_at<span class="token variable">`</span></span> DESC<span class="token punctuation">\</span>G

<span class="token comment"># Query 4: 37.50 QPS, 0.01x concurrency, ID 0x99AA0165670CE848 at byte 1926</span>
<span class="token comment"># This item is included in the report because it matches --limit.</span>
<span class="token comment"># Scores: V/M = 0.00</span>
<span class="token comment"># Time range: 2022-06-08T14:17:38 to 2022-06-08T14:17:42</span>
<span class="token comment"># Attribute    pct   total     min     max     avg     95%  stddev  median</span>
<span class="token comment"># ============ === ======= ======= ======= ======= ======= ======= =======</span>
<span class="token comment"># Count         32     150</span>
<span class="token comment"># Exec time      2    51ms   140us     5ms   341us   467us   419us   260us</span>
<span class="token comment"># Lock time      5    25us       0    16us       0       0     1us       0</span>
<span class="token comment"># Rows sent      0       0       0       0       0       0       0       0</span>
<span class="token comment"># Rows examine   0       0       0       0       0       0       0       0</span>
<span class="token comment"># Query size    26   4.39k      30      30      30      30       0      30</span>
<span class="token comment"># String:</span>
<span class="token comment"># Databases    isuconp</span>
<span class="token comment"># Hosts        webapp_app_1.webapp_default</span>
<span class="token comment"># Users        root</span>
<span class="token comment"># Query_time distribution</span>
<span class="token comment">#   1us</span>
<span class="token comment">#  10us</span>
<span class="token comment"># 100us  ################################################################</span>
<span class="token comment">#   1ms  #</span>
<span class="token comment">#  10ms</span>
<span class="token comment"># 100ms</span>
<span class="token comment">#    1s</span>
<span class="token comment">#  10s+</span>
administrator command: Prepare<span class="token punctuation">\</span>G
</code></pre></div></li> <li><p>CPU使用率の履歴を残したい場合は <code>$ dstat</code></p></li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>dstat --cpu
</code></pre></div><h2 id="_4-シナリオを持った負荷試験"><a href="#_4-シナリオを持った負荷試験" class="header-anchor">#</a> 4. シナリオを持った負荷試験</h2> <ul><li><p>k6</p> <ul><li>HTTP/1.1, 2, WebSocket, gRPCでシナリオベースの負荷試験を行えるツール</li> <li>MacOSなら <code>$ brew install k6</code></li> <li>他OSなら<a href="https://k6.io/docs/getting-started/installation/" target="_blank" rel="noopener noreferrer">ドキュメント<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>を参照して</li></ul></li> <li><p>並列度1で30秒間実行する場合</p> <ul><li><code>$ k6 run --vus 1 --duration 30s ab.js</code></li> <li><code>vus</code> はVirtual Usersの略</li></ul></li> <li><p>単一URLにリクエストを送信するシナリオ</p> <div class="language-bash extra-class"><pre class="language-bash"><code>% <span class="token function">cat</span> ab.js                                                                                                                                                        <span class="token punctuation">[</span>~/work/private-isu/k6<span class="token punctuation">]</span>+<span class="token punctuation">[</span>master<span class="token punctuation">]</span>
<span class="token function">import</span> http from <span class="token string">&quot;k6/http&quot;</span>

const BASE_URL <span class="token operator">=</span> <span class="token string">&quot;http://localhost&quot;</span><span class="token punctuation">;</span>

<span class="token builtin class-name">export</span> default <span class="token function-name function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  http.get<span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span>$<span class="token punctuation">{</span>BASE_URL<span class="token punctuation">}</span>/<span class="token variable">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
% k6 run --vus <span class="token number">1</span> --duration 30s ab.js                                                                                                                              <span class="token punctuation">[</span>~/work/private-isu/k6<span class="token punctuation">]</span>+<span class="token punctuation">[</span>master<span class="token punctuation">]</span>

          /<span class="token punctuation">\</span>      <span class="token operator">|</span>‾‾<span class="token operator">|</span> /‾‾/   /‾‾/   
     /<span class="token punctuation">\</span>  /  <span class="token punctuation">\</span>     <span class="token operator">|</span>  <span class="token operator">|</span>/  /   /  /    
    /  <span class="token punctuation">\</span>/    <span class="token punctuation">\</span>    <span class="token operator">|</span>     <span class="token punctuation">(</span>   /   ‾‾<span class="token punctuation">\</span>  
   /          <span class="token punctuation">\</span>   <span class="token operator">|</span>  <span class="token operator">|</span><span class="token punctuation">\</span>  <span class="token punctuation">\</span> <span class="token operator">|</span>  <span class="token punctuation">(</span>‾<span class="token punctuation">)</span>  <span class="token operator">|</span> 
  / __________ <span class="token punctuation">\</span>  <span class="token operator">|</span>__<span class="token operator">|</span> <span class="token punctuation">\</span>__<span class="token punctuation">\</span> <span class="token punctuation">\</span>_____/ .io

  execution: <span class="token builtin class-name">local</span>
     script: ab.js
     output: -

  scenarios: <span class="token punctuation">(</span><span class="token number">100.00</span>%<span class="token punctuation">)</span> <span class="token number">1</span> scenario, <span class="token number">1</span> max VUs, 1m0s max duration <span class="token punctuation">(</span>incl. graceful stop<span class="token punctuation">)</span>:
           * default: <span class="token number">1</span> looping VUs <span class="token keyword">for</span> 30s <span class="token punctuation">(</span>gracefulStop: 30s<span class="token punctuation">)</span>

running <span class="token punctuation">(</span>0m31.5s<span class="token punctuation">)</span>, <span class="token number">0</span>/1 VUs, <span class="token number">13</span> complete and <span class="token number">0</span> interrupted iterations
default ✓ <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token punctuation">]</span> <span class="token number">1</span> VUs  30s

     data_received<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">461</span> kB <span class="token number">15</span> kB/s
     data_sent<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">975</span> B  <span class="token number">31</span> B/s
     http_req_blocked<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">51.46</span>µs <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">2</span>µs   <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">4</span>µs   <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">620</span>µs  p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">6</span>µs     p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">251.59</span>µs
     http_req_connecting<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">13.15</span>µs <span class="token assign-left variable">min</span><span class="token operator">=</span>0s    <span class="token assign-left variable">med</span><span class="token operator">=</span>0s    <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">171</span>µs  p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span>0s      p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">68.39</span>µs 
     http_req_duration<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">2</span>.42s   <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">2</span>.29s <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">2</span>.33s <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">3</span>.32s  p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">2</span>.58s   p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">2</span>.91s   
       <span class="token punctuation">{</span> expected_response:true <span class="token punctuation">}</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">2</span>.42s   <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">2</span>.29s <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">2</span>.33s <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">3</span>.32s  p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">2</span>.58s   p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">2</span>.91s   
     http_req_failed<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">0.00</span>%  ✓ <span class="token number">0</span>        ✗ <span class="token number">13</span> 
     http_req_receiving<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">424.3</span>µs <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">89</span>µs  <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">129</span>µs <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">3</span>.54ms p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">554.6</span>µs p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span>.8ms   
     http_req_sending<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">28.92</span>µs <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">13</span>µs  <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">16</span>µs  <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">173</span>µs  p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">24.6</span>µs  p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">84.19</span>µs 
     http_req_tls_handshaking<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span>0s      <span class="token assign-left variable">min</span><span class="token operator">=</span>0s    <span class="token assign-left variable">med</span><span class="token operator">=</span>0s    <span class="token assign-left variable">max</span><span class="token operator">=</span>0s     p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span>0s      p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span>0s      
     http_req_waiting<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">2</span>.42s   <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">2</span>.28s <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">2</span>.33s <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">3</span>.32s  p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">2</span>.58s   p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">2</span>.91s   
     http_reqs<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">13</span>     <span class="token number">0.412203</span>/s
     iteration_duration<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">2</span>.42s   <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">2</span>.29s <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">2</span>.33s <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">3</span>.32s  p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">2</span>.58s   p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">2</span>.91s   
     iterations<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token number">13</span>     <span class="token number">0.412203</span>/s
     vus<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">1</span>      <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">1</span>      <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">1</span>
     vus_max<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">1</span>      <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">1</span>      <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">1</span>
</code></pre></div></li> <li><p>ISUCONでは初期化のために <code>GET /initialize</code> というURLにアクセスする</p></li> <li><p>新しいシナリオ</p> <ol><li>Webアプリケーションの初期化</li> <li>ログインしてコメントを投稿する処理</li> <li>ログインして画像を投稿する処理</li></ol> <ul><li><p>URLの共有用JS</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// config.js</span>
<span class="token keyword">const</span> <span class="token constant">BASE_URL</span> <span class="token operator">=</span> <span class="token string">&quot;http://localhost&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">url</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">BASE_URL</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>初期化処理用JS</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// initialize.js</span>
<span class="token keyword">import</span> http <span class="token keyword">from</span> <span class="token string">&quot;k6/http&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> sleep <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;k6&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> url <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./config.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">&quot;/initialize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token string">&quot;10s&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>初期化の負荷実行</p> <div class="language-bash extra-class"><pre class="language-bash"><code>% k6 run --vus <span class="token number">1</span> initialize.js                                                                                                               <span class="token punctuation">[</span>~/work/private-isu/k6/scinario-base-request<span class="token punctuation">]</span>+<span class="token punctuation">[</span>master<span class="token punctuation">]</span>

          /<span class="token punctuation">\</span>      <span class="token operator">|</span>‾‾<span class="token operator">|</span> /‾‾/   /‾‾/   
     /<span class="token punctuation">\</span>  /  <span class="token punctuation">\</span>     <span class="token operator">|</span>  <span class="token operator">|</span>/  /   /  /    
    /  <span class="token punctuation">\</span>/    <span class="token punctuation">\</span>    <span class="token operator">|</span>     <span class="token punctuation">(</span>   /   ‾‾<span class="token punctuation">\</span>  
   /          <span class="token punctuation">\</span>   <span class="token operator">|</span>  <span class="token operator">|</span><span class="token punctuation">\</span>  <span class="token punctuation">\</span> <span class="token operator">|</span>  <span class="token punctuation">(</span>‾<span class="token punctuation">)</span>  <span class="token operator">|</span> 
  / __________ <span class="token punctuation">\</span>  <span class="token operator">|</span>__<span class="token operator">|</span> <span class="token punctuation">\</span>__<span class="token punctuation">\</span> <span class="token punctuation">\</span>_____/ .io

  execution: <span class="token builtin class-name">local</span>
     script: initialize.js
     output: -

  scenarios: <span class="token punctuation">(</span><span class="token number">100.00</span>%<span class="token punctuation">)</span> <span class="token number">1</span> scenario, <span class="token number">1</span> max VUs, 10m30s max duration <span class="token punctuation">(</span>incl. graceful stop<span class="token punctuation">)</span>:
           * default: <span class="token number">1</span> iterations <span class="token keyword">for</span> each of <span class="token number">1</span> VUs <span class="token punctuation">(</span>maxDuration: 10m0s, gracefulStop: 30s<span class="token punctuation">)</span>

running <span class="token punctuation">(</span>00m01.1s<span class="token punctuation">)</span>, <span class="token number">0</span>/1 VUs, <span class="token number">1</span> complete and <span class="token number">0</span> interrupted iterations
default ✓ <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token punctuation">]</span> <span class="token number">1</span> VUs  00m01.1s/10m0s  <span class="token number">1</span>/1 iters, <span class="token number">1</span> per VU

     data_received<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">255</span> B <span class="token number">241</span> B/s
     data_sent<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">85</span> B  <span class="token number">80</span> B/s
     http_req_blocked<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">1</span>.18ms  <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">1</span>.18ms  <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">1</span>.18ms  <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">1</span>.18ms  p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span>.18ms  p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span>.18ms 
     http_req_connecting<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">198</span>µs   <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">198</span>µs   <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">198</span>µs   <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">198</span>µs   p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">198</span>µs   p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">198</span>µs  
     http_req_duration<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">52</span>.12ms <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">52</span>.12ms <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">52</span>.12ms <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">52</span>.12ms p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">52</span>.12ms p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">52</span>.12ms
       <span class="token punctuation">{</span> expected_response:true <span class="token punctuation">}</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">52</span>.12ms <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">52</span>.12ms <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">52</span>.12ms <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">52</span>.12ms p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">52</span>.12ms p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">52</span>.12ms
     http_req_failed<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">0.00</span>% ✓ <span class="token number">0</span>        ✗ <span class="token number">1</span>  
     http_req_receiving<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">169</span>µs   <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">169</span>µs   <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">169</span>µs   <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">169</span>µs   p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">169</span>µs   p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">169</span>µs  
     http_req_sending<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">706</span>µs   <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">706</span>µs   <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">706</span>µs   <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">706</span>µs   p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">706</span>µs   p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">706</span>µs  
     http_req_tls_handshaking<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span>0s      <span class="token assign-left variable">min</span><span class="token operator">=</span>0s      <span class="token assign-left variable">med</span><span class="token operator">=</span>0s      <span class="token assign-left variable">max</span><span class="token operator">=</span>0s      p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span>0s      p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span>0s     
     http_req_waiting<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">51</span>.25ms <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">51</span>.25ms <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">51</span>.25ms <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">51</span>.25ms p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">51</span>.25ms p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">51</span>.25ms
     http_reqs<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">1</span>     <span class="token number">0.945969</span>/s
     iteration_duration<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">1</span>.05s   <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">1</span>.05s   <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">1</span>.05s   <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">1</span>.05s   p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span>.05s   p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span>.05s  
     iterations<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token number">1</span>     <span class="token number">0.945969</span>/s
     vus<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">1</span>     <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">1</span>      <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">1</span>
     vus_max<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">1</span>     <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">1</span>      <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">1</span>
</code></pre></div></li> <li><p>コメント投稿するJS</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// comment.js</span>
<span class="token keyword">import</span> http <span class="token keyword">from</span> <span class="token string">&quot;k6/http&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> check <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;k6&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> parseHTML <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;k6/html&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> url <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./config.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// login</span>
  <span class="token keyword">const</span> login_res <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">account_name</span><span class="token operator">:</span> <span class="token string">&quot;terra&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">&quot;terraterra&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">check</span><span class="token punctuation">(</span>login_res<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;is status 200&quot;</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">&quot;/@terra&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> doc <span class="token operator">=</span> <span class="token function">parseHTML</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> token <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'input[name=&quot;csrf_token&quot;]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> post_id <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'input[name=&quot;post_id&quot;]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// comment</span>
  <span class="token keyword">const</span> comment_res <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">&quot;/comment&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">post_id</span><span class="token operator">:</span> post_id<span class="token punctuation">,</span>
    <span class="token literal-property property">csrf_token</span><span class="token operator">:</span> token<span class="token punctuation">,</span>
    <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&quot;Hello k6!&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">check</span><span class="token punctuation">(</span>comment_res<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;is status 200&quot;</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>コメント投稿の負荷実行</p> <div class="language-bash extra-class"><pre class="language-bash"><code>% k6 run --vus <span class="token number">1</span> comment.js                                                                                                                  <span class="token punctuation">[</span>~/work/private-isu/k6/scinario-base-request<span class="token punctuation">]</span>+<span class="token punctuation">[</span>master<span class="token punctuation">]</span>

          /<span class="token punctuation">\</span>      <span class="token operator">|</span>‾‾<span class="token operator">|</span> /‾‾/   /‾‾/   
     /<span class="token punctuation">\</span>  /  <span class="token punctuation">\</span>     <span class="token operator">|</span>  <span class="token operator">|</span>/  /   /  /    
    /  <span class="token punctuation">\</span>/    <span class="token punctuation">\</span>    <span class="token operator">|</span>     <span class="token punctuation">(</span>   /   ‾‾<span class="token punctuation">\</span>  
   /          <span class="token punctuation">\</span>   <span class="token operator">|</span>  <span class="token operator">|</span><span class="token punctuation">\</span>  <span class="token punctuation">\</span> <span class="token operator">|</span>  <span class="token punctuation">(</span>‾<span class="token punctuation">)</span>  <span class="token operator">|</span> 
  / __________ <span class="token punctuation">\</span>  <span class="token operator">|</span>__<span class="token operator">|</span> <span class="token punctuation">\</span>__<span class="token punctuation">\</span> <span class="token punctuation">\</span>_____/ .io

  execution: <span class="token builtin class-name">local</span>
     script: comment.js
     output: -

  scenarios: <span class="token punctuation">(</span><span class="token number">100.00</span>%<span class="token punctuation">)</span> <span class="token number">1</span> scenario, <span class="token number">1</span> max VUs, 10m30s max duration <span class="token punctuation">(</span>incl. graceful stop<span class="token punctuation">)</span>:
           * default: <span class="token number">1</span> iterations <span class="token keyword">for</span> each of <span class="token number">1</span> VUs <span class="token punctuation">(</span>maxDuration: 10m0s, gracefulStop: 30s<span class="token punctuation">)</span>

running at file:///Users/takashimima/work/private-isu/k6/scinario-base-request/comment.js:18:24<span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span>
default at native  <span class="token assign-left variable">executor</span><span class="token operator">=</span>per-vu-iterations <span class="token assign-left variable">scenario</span><span class="token operator">=</span>default <span class="token assign-left variable">source</span><span class="token operator">=</span>stacktrace

running <span class="token punctuation">(</span>00m06.8s<span class="token punctuation">)</span>, <span class="token number">0</span>/1 VUs, <span class="token number">1</span> complete and <span class="token number">0</span> interrupted iterations
default ✓ <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token punctuation">]</span> <span class="token number">1</span> VUs  00m06.8s/10m0s  <span class="token number">1</span>/1 iters, <span class="token number">1</span> per VU

     ✓ is status <span class="token number">200</span>

     checks<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token number">100.00</span>% ✓ <span class="token number">1</span>        ✗ <span class="token number">0</span>  
     data_received<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">72</span> kB   <span class="token number">11</span> kB/s
     data_sent<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">600</span> B   <span class="token number">89</span> B/s
     http_req_blocked<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">568.66</span>µs <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">2</span>µs     <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">4</span>µs   <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">1</span>.7ms p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span>.36ms  p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span>.53ms 
     http_req_connecting<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">62.33</span>µs  <span class="token assign-left variable">min</span><span class="token operator">=</span>0s      <span class="token assign-left variable">med</span><span class="token operator">=</span>0s    <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">187</span>µs p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">149.6</span>µs p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">168.3</span>µs
     http_req_duration<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">2</span>.25s    <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">44</span>.9ms  <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">2</span>.88s <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">3</span>.84s p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">3</span>.65s   p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">3</span>.75s  
       <span class="token punctuation">{</span> expected_response:true <span class="token punctuation">}</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">2</span>.25s    <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">44</span>.9ms  <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">2</span>.88s <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">3</span>.84s p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">3</span>.65s   p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">3</span>.75s  
     http_req_failed<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">0.00</span>%   ✓ <span class="token number">0</span>        ✗ <span class="token number">3</span>  
     http_req_receiving<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">260</span>µs    <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">175</span>µs   <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">213</span>µs <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">392</span>µs p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">356.2</span>µs p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">374.1</span>µs
     http_req_sending<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">148.66</span>µs <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">14</span>µs    <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">18</span>µs  <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">414</span>µs p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">334.8</span>µs p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">374.4</span>µs
     http_req_tls_handshaking<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span>0s       <span class="token assign-left variable">min</span><span class="token operator">=</span>0s      <span class="token assign-left variable">med</span><span class="token operator">=</span>0s    <span class="token assign-left variable">max</span><span class="token operator">=</span>0s    p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span>0s      p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span>0s     
     http_req_waiting<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">2</span>.25s    <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">44</span>.09ms <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">2</span>.87s <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">3</span>.84s p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">3</span>.65s   p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">3</span>.75s  
     http_reqs<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">3</span>       <span class="token number">0.442368</span>/s
     iteration_duration<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">6</span>.77s    <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">6</span>.77s   <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">6</span>.77s <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">6</span>.77s p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">6</span>.77s   p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">6</span>.77s  
     iterations<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token number">1</span>       <span class="token number">0.147456</span>/s
     vus<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">1</span>       <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">1</span>      <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">1</span>
     vus_max<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">1</span>       <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">1</span>      <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">1</span>
</code></pre></div></li> <li><p>画像をアップロードするJS</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// postimage.js</span>
<span class="token keyword">import</span> http <span class="token keyword">from</span> <span class="token string">&quot;k6/http&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> parseHTML <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;k6/html&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> url <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./config.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> testImage <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;testImage.jpg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// login</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">account_name</span><span class="token operator">:</span> <span class="token string">&quot;terra&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">&quot;terraterra&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> doc <span class="token operator">=</span> <span class="token function">parseHTML</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'input[name=&quot;csrf_token&quot;]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// post image</span>
  http<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">file</span><span class="token operator">:</span> http<span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span>testImage<span class="token punctuation">,</span> <span class="token string">&quot;testimage.jpg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;image/jpeg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token string">&quot;Posted by k6&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">csrf_token</span><span class="token operator">:</span> token<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>JSONを読み込むモジュールのJS</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token property">&quot;account_name&quot;</span><span class="token operator">:</span><span class="token string">&quot;terra&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;password&quot;</span><span class="token operator">:</span><span class="token string">&quot;terraterra&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token property">&quot;account_name&quot;</span><span class="token operator">:</span><span class="token string">&quot;sheri&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;password&quot;</span><span class="token operator">:</span><span class="token string">&quot;sherisheri&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token property">&quot;account_name&quot;</span><span class="token operator">:</span><span class="token string">&quot;janelle&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;password&quot;</span><span class="token operator">:</span><span class="token string">&quot;janellejanelle&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token property">&quot;account_name&quot;</span><span class="token operator">:</span><span class="token string">&quot;chasity&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;password&quot;</span><span class="token operator">:</span><span class="token string">&quot;chasitychasity&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// account.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> SharedArray <span class="token punctuation">}</span> <span class="token keyword">import</span> <span class="token string">&quot;k6/data&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> accounts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedArray</span><span class="token punctuation">(</span><span class="token string">'accounts'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'./account.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> accounts<span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> accounts<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

</code></pre></div><div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> getAccount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./account.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">commentScenario</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> account <span class="token operator">=</span> <span class="token function">getAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> login_res <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">account_name</span><span class="token operator">:</span> account_name<span class="token punctuation">,</span>
    <span class="token literal-property property">password</span><span class="token operator">:</span> account<span class="token punctuation">.</span>password<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>複数のシナリオを組み合わせた統合シナリオ用JS</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// integrated.js</span>
<span class="token keyword">import</span> initialize <span class="token keyword">from</span> <span class="token string">&quot;./initialize.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> comment <span class="token keyword">from</span> <span class="token string">&quot;./comment.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> postimage <span class="token keyword">from</span> <span class="token string">&quot;./postimage.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span>
    initialize<span class="token punctuation">,</span>
    comment<span class="token punctuation">,</span>
    postimage
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// The scinario is </span>
<span class="token comment">// 1.   initialize    (0[s] ~10[s])</span>
<span class="token comment">// 2-1. leave comments(12[s]~42[s])</span>
<span class="token comment">// 2-2. post images   (12[s]~42[s])</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">scenarios</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">initialize</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">executor</span><span class="token operator">:</span> <span class="token string">&quot;shared-iterations&quot;</span><span class="token punctuation">,</span> <span class="token comment">// multiple virtual users</span>
            <span class="token literal-property property">vus</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token literal-property property">iterations</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token literal-property property">exec</span><span class="token operator">:</span> <span class="token string">&quot;initialize&quot;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">maxDuration</span><span class="token operator">:</span> <span class="token string">&quot;10s&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">executor</span><span class="token operator">:</span> <span class="token string">&quot;constant-vus&quot;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">vus</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
            <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token string">&quot;30s&quot;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">exec</span><span class="token operator">:</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">startTime</span><span class="token operator">:</span> <span class="token string">&quot;12s&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">postImage</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">executor</span><span class="token operator">:</span> <span class="token string">&quot;constant-vus&quot;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">vus</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token string">&quot;30s&quot;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">exec</span><span class="token operator">:</span> <span class="token string">&quot;postimage&quot;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">startTime</span><span class="token operator">:</span> <span class="token string">&quot;12s&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div></li> <li><p>複数のシナリオを組み合わせた統合シナリオの負荷実行</p> <div class="language-bash extra-class"><pre class="language-bash"><code>% k6 run integrated.js                                                                                                                       <span class="token punctuation">[</span>~/work/private-isu/k6/scinario-base-request<span class="token punctuation">]</span>+<span class="token punctuation">[</span>master<span class="token punctuation">]</span>

          /<span class="token punctuation">\</span>      <span class="token operator">|</span>‾‾<span class="token operator">|</span> /‾‾/   /‾‾/   
     /<span class="token punctuation">\</span>  /  <span class="token punctuation">\</span>     <span class="token operator">|</span>  <span class="token operator">|</span>/  /   /  /    
    /  <span class="token punctuation">\</span>/    <span class="token punctuation">\</span>    <span class="token operator">|</span>     <span class="token punctuation">(</span>   /   ‾‾<span class="token punctuation">\</span>  
   /          <span class="token punctuation">\</span>   <span class="token operator">|</span>  <span class="token operator">|</span><span class="token punctuation">\</span>  <span class="token punctuation">\</span> <span class="token operator">|</span>  <span class="token punctuation">(</span>‾<span class="token punctuation">)</span>  <span class="token operator">|</span> 
  / __________ <span class="token punctuation">\</span>  <span class="token operator">|</span>__<span class="token operator">|</span> <span class="token punctuation">\</span>__<span class="token punctuation">\</span> <span class="token punctuation">\</span>_____/ .io

  execution: <span class="token builtin class-name">local</span>
     script: integrated.js
     output: -

  scenarios: <span class="token punctuation">(</span><span class="token number">100.00</span>%<span class="token punctuation">)</span> <span class="token number">3</span> scenarios, <span class="token number">7</span> max VUs, 1m12s max duration <span class="token punctuation">(</span>incl. graceful stop<span class="token punctuation">)</span>:
           * initialize: <span class="token number">1</span> iterations shared among <span class="token number">1</span> VUs <span class="token punctuation">(</span>maxDuration: 10s, exec: initialize, gracefulStop: 30s<span class="token punctuation">)</span>
           * comment: <span class="token number">4</span> looping VUs <span class="token keyword">for</span> 30s <span class="token punctuation">(</span>exec: comment, startTime: 12s, gracefulStop: 30s<span class="token punctuation">)</span>
           * postImage: <span class="token number">2</span> looping VUs <span class="token keyword">for</span> 30s <span class="token punctuation">(</span>exec: postimage, startTime: 12s, gracefulStop: 30s<span class="token punctuation">)</span>

running <span class="token punctuation">(</span>0m44.4s<span class="token punctuation">)</span>, <span class="token number">0</span>/7 VUs, <span class="token number">7</span> complete and <span class="token number">0</span> interrupted iterations
initialize ✓ <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token punctuation">]</span> <span class="token number">1</span> VUs  01.1s/10s  <span class="token number">1</span>/1 shared iters
comment    ✓ <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token punctuation">]</span> <span class="token number">4</span> VUs  30s       
postImage  ✓ <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token punctuation">]</span> <span class="token number">2</span> VUs  30s       

     ✓ is status <span class="token number">200</span>

     checks<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token number">100.00</span>% ✓ <span class="token number">8</span>        ✗ <span class="token number">0</span>  
     data_received<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">382</span> kB  <span class="token number">8.6</span> kB/s
     data_sent<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">32</span> kB   <span class="token number">716</span> B/s
     http_req_blocked<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">374.06</span>µs <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">2</span>µs     <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">4</span>µs    <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">5</span>.99ms p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">979</span>µs    p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span>.01ms  
     http_req_connecting<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">141</span>µs    <span class="token assign-left variable">min</span><span class="token operator">=</span>0s      <span class="token assign-left variable">med</span><span class="token operator">=</span>0s     <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">878</span>µs  p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">609.59</span>µs p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">844.4</span>µs 
     http_req_duration<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">6</span>.61s    <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">35</span>.72ms <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">3</span>.29s  <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">21</span>.16s p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">16</span>.82s   p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">19</span>.67s  
       <span class="token punctuation">{</span> expected_response:true <span class="token punctuation">}</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">6</span>.61s    <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">35</span>.72ms <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">3</span>.29s  <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">21</span>.16s p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">16</span>.82s   p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">19</span>.67s  
     http_req_failed<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">0.00</span>%   ✓ <span class="token number">0</span>        ✗ <span class="token number">29</span> 
     http_req_receiving<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">224.86</span>µs <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">69</span>µs    <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">99</span>µs   <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">2</span>.15ms p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">271.99</span>µs p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">693.39</span>µs
     http_req_sending<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">57.79</span>µs  <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">14</span>µs    <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">22</span>µs   <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">194</span>µs  p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">167.8</span>µs  p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">183.59</span>µs
     http_req_tls_handshaking<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span>0s       <span class="token assign-left variable">min</span><span class="token operator">=</span>0s      <span class="token assign-left variable">med</span><span class="token operator">=</span>0s     <span class="token assign-left variable">max</span><span class="token operator">=</span>0s     p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span>0s       p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span>0s      
     http_req_waiting<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">6</span>.61s    <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">35</span>.52ms <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">3</span>.29s  <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">21</span>.16s p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">16</span>.82s   p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">19</span>.67s  
     http_reqs<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">29</span>      <span class="token number">0.653619</span>/s
     iteration_duration<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token assign-left variable">avg</span><span class="token operator">=</span><span class="token number">27</span>.54s   <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">1</span>.1s    <span class="token assign-left variable">med</span><span class="token operator">=</span><span class="token number">31</span>.94s <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">32</span>.36s p<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">32</span>.25s   p<span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">32</span>.3s   
     iterations<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.: <span class="token number">7</span>       <span class="token number">0.15777</span>/s
     vus<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">3</span>       <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">0</span>      <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">6</span>
     vus_max<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>: <span class="token number">7</span>       <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token number">7</span>      <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">7</span>
</code></pre></div></li> <li><p>alpの実行結果</p> <div class="language-bash extra-class"><pre class="language-bash"><code>% alp json --sort <span class="token function">sum</span> -r -m <span class="token string">&quot;/posts/[0-9]+,/@\w+&quot;</span> -o count,method,uri,min,avg,max,sum --file ./access.log.20220610-135211                           <span class="token punctuation">[</span>~/work/private-isu/webapp/logs/nginx<span class="token punctuation">]</span>+<span class="token punctuation">[</span>master<span class="token punctuation">]</span>
+-------+--------+---------------+--------+--------+--------+---------+
<span class="token operator">|</span> COUNT <span class="token operator">|</span> METHOD <span class="token operator">|</span>      URI      <span class="token operator">|</span>  MIN   <span class="token operator">|</span>  AVG   <span class="token operator">|</span>  MAX   <span class="token operator">|</span>   SUM   <span class="token operator">|</span>
+-------+--------+---------------+--------+--------+--------+---------+
<span class="token operator">|</span>    <span class="token number">12</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /             <span class="token operator">|</span>  <span class="token number">2.451</span> <span class="token operator">|</span>  <span class="token number">8.737</span> <span class="token operator">|</span> <span class="token number">15.176</span> <span class="token operator">|</span> <span class="token number">104.846</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">8</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /@<span class="token punctuation">\</span>w+         <span class="token operator">|</span> <span class="token number">11.055</span> <span class="token operator">|</span> <span class="token number">12.770</span> <span class="token operator">|</span> <span class="token number">14.676</span> <span class="token operator">|</span> <span class="token number">102.158</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">4</span> <span class="token operator">|</span> POST   <span class="token operator">|</span> /             <span class="token operator">|</span>  <span class="token number">2.214</span> <span class="token operator">|</span>  <span class="token number">9.666</span> <span class="token operator">|</span> <span class="token number">12.875</span> <span class="token operator">|</span>  <span class="token number">38.665</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">12</span> <span class="token operator">|</span> POST   <span class="token operator">|</span> /login        <span class="token operator">|</span>  <span class="token number">0.047</span> <span class="token operator">|</span>  <span class="token number">1.971</span> <span class="token operator">|</span>  <span class="token number">7.830</span> <span class="token operator">|</span>  <span class="token number">23.649</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">4</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /posts/<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>+ <span class="token operator">|</span>  <span class="token number">0.120</span> <span class="token operator">|</span>  <span class="token number">3.518</span> <span class="token operator">|</span> <span class="token number">11.152</span> <span class="token operator">|</span>  <span class="token number">14.073</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /initialize   <span class="token operator">|</span>  <span class="token number">0.027</span> <span class="token operator">|</span>  <span class="token number">0.027</span> <span class="token operator">|</span>  <span class="token number">0.027</span> <span class="token operator">|</span>   <span class="token number">0.027</span> <span class="token operator">|</span>
+-------+--------+---------------+--------+--------+--------+---------+
</code></pre></div><p>※<code>-m</code> で絞り込めないのは、そもそもそのログが残ってないから</p> <div class="language-bash extra-class"><pre class="language-bash"><code>% alp json --sort <span class="token function">sum</span> -r -m <span class="token string">&quot;/posts/[0-9]+,/@\w+&quot;</span> -o count,method,uri,min,avg,max,sum --file ./access.log.20220610-125756                           <span class="token punctuation">[</span>~/work/private-isu/webapp/logs/nginx<span class="token punctuation">]</span>+<span class="token punctuation">[</span>master<span class="token punctuation">]</span>
+-------+--------+----------------------+-------+-------+-------+--------+
<span class="token operator">|</span> COUNT <span class="token operator">|</span> METHOD <span class="token operator">|</span>         URI          <span class="token operator">|</span>  MIN  <span class="token operator">|</span>  AVG  <span class="token operator">|</span>  MAX  <span class="token operator">|</span>  SUM   <span class="token operator">|</span>
+-------+--------+----------------------+-------+-------+-------+--------+
<span class="token operator">|</span>    <span class="token number">15</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /                    <span class="token operator">|</span> <span class="token number">2.288</span> <span class="token operator">|</span> <span class="token number">2.498</span> <span class="token operator">|</span> <span class="token number">3.502</span> <span class="token operator">|</span> <span class="token number">37.466</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /js/timeago.min.js   <span class="token operator">|</span> <span class="token number">0.473</span> <span class="token operator">|</span> <span class="token number">1.472</span> <span class="token operator">|</span> <span class="token number">2.471</span> <span class="token operator">|</span>  <span class="token number">2.944</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /js/main.js          <span class="token operator">|</span> <span class="token number">0.460</span> <span class="token operator">|</span> <span class="token number">1.459</span> <span class="token operator">|</span> <span class="token number">2.458</span> <span class="token operator">|</span>  <span class="token number">2.918</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /image/9998.jpg      <span class="token operator">|</span> <span class="token number">0.408</span> <span class="token operator">|</span> <span class="token number">1.320</span> <span class="token operator">|</span> <span class="token number">2.232</span> <span class="token operator">|</span>  <span class="token number">2.640</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /image/9999.jpg      <span class="token operator">|</span> <span class="token number">0.120</span> <span class="token operator">|</span> <span class="token number">1.302</span> <span class="token operator">|</span> <span class="token number">2.485</span> <span class="token operator">|</span>  <span class="token number">2.605</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /css/style.css       <span class="token operator">|</span> <span class="token number">2.454</span> <span class="token operator">|</span> <span class="token number">2.454</span> <span class="token operator">|</span> <span class="token number">2.454</span> <span class="token operator">|</span>  <span class="token number">2.454</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /image/10000.png     <span class="token operator">|</span> <span class="token number">0.205</span> <span class="token operator">|</span> <span class="token number">0.258</span> <span class="token operator">|</span> <span class="token number">0.311</span> <span class="token operator">|</span>  <span class="token number">0.516</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /image/9997.jpg      <span class="token operator">|</span> <span class="token number">0.013</span> <span class="token operator">|</span> <span class="token number">0.238</span> <span class="token operator">|</span> <span class="token number">0.462</span> <span class="token operator">|</span>  <span class="token number">0.475</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /image/9987.jpg      <span class="token operator">|</span> <span class="token number">0.431</span> <span class="token operator">|</span> <span class="token number">0.431</span> <span class="token operator">|</span> <span class="token number">0.431</span> <span class="token operator">|</span>  <span class="token number">0.431</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /image/9986.jpg      <span class="token operator">|</span> <span class="token number">0.425</span> <span class="token operator">|</span> <span class="token number">0.425</span> <span class="token operator">|</span> <span class="token number">0.425</span> <span class="token operator">|</span>  <span class="token number">0.425</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /image/9996.jpg      <span class="token operator">|</span> <span class="token number">0.422</span> <span class="token operator">|</span> <span class="token number">0.211</span> <span class="token operator">|</span> <span class="token number">0.422</span> <span class="token operator">|</span>  <span class="token number">0.422</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /image/9981.jpg      <span class="token operator">|</span> <span class="token number">0.367</span> <span class="token operator">|</span> <span class="token number">0.367</span> <span class="token operator">|</span> <span class="token number">0.367</span> <span class="token operator">|</span>  <span class="token number">0.367</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /image/9991.jpg      <span class="token operator">|</span> <span class="token number">0.366</span> <span class="token operator">|</span> <span class="token number">0.366</span> <span class="token operator">|</span> <span class="token number">0.366</span> <span class="token operator">|</span>  <span class="token number">0.366</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /image/9982.jpg      <span class="token operator">|</span> <span class="token number">0.365</span> <span class="token operator">|</span> <span class="token number">0.365</span> <span class="token operator">|</span> <span class="token number">0.365</span> <span class="token operator">|</span>  <span class="token number">0.365</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /image/9983.jpg      <span class="token operator">|</span> <span class="token number">0.357</span> <span class="token operator">|</span> <span class="token number">0.357</span> <span class="token operator">|</span> <span class="token number">0.357</span> <span class="token operator">|</span>  <span class="token number">0.357</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /image/9990.jpg      <span class="token operator">|</span> <span class="token number">0.346</span> <span class="token operator">|</span> <span class="token number">0.346</span> <span class="token operator">|</span> <span class="token number">0.346</span> <span class="token operator">|</span>  <span class="token number">0.346</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /image/9988.jpg      <span class="token operator">|</span> <span class="token number">0.342</span> <span class="token operator">|</span> <span class="token number">0.342</span> <span class="token operator">|</span> <span class="token number">0.342</span> <span class="token operator">|</span>  <span class="token number">0.342</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /image/9989.jpg      <span class="token operator">|</span> <span class="token number">0.340</span> <span class="token operator">|</span> <span class="token number">0.340</span> <span class="token operator">|</span> <span class="token number">0.340</span> <span class="token operator">|</span>  <span class="token number">0.340</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /image/9985.jpg      <span class="token operator">|</span> <span class="token number">0.323</span> <span class="token operator">|</span> <span class="token number">0.323</span> <span class="token operator">|</span> <span class="token number">0.323</span> <span class="token operator">|</span>  <span class="token number">0.323</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /image/9995.jpg      <span class="token operator">|</span> <span class="token number">0.306</span> <span class="token operator">|</span> <span class="token number">0.306</span> <span class="token operator">|</span> <span class="token number">0.306</span> <span class="token operator">|</span>  <span class="token number">0.306</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /image/9993.jpg      <span class="token operator">|</span> <span class="token number">0.267</span> <span class="token operator">|</span> <span class="token number">0.267</span> <span class="token operator">|</span> <span class="token number">0.267</span> <span class="token operator">|</span>  <span class="token number">0.267</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /image/9980.jpg      <span class="token operator">|</span> <span class="token number">0.267</span> <span class="token operator">|</span> <span class="token number">0.267</span> <span class="token operator">|</span> <span class="token number">0.267</span> <span class="token operator">|</span>  <span class="token number">0.267</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /image/9994.jpg      <span class="token operator">|</span> <span class="token number">0.255</span> <span class="token operator">|</span> <span class="token number">0.255</span> <span class="token operator">|</span> <span class="token number">0.255</span> <span class="token operator">|</span>  <span class="token number">0.255</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /img/ajax-loader.gif <span class="token operator">|</span> <span class="token number">0.253</span> <span class="token operator">|</span> <span class="token number">0.253</span> <span class="token operator">|</span> <span class="token number">0.253</span> <span class="token operator">|</span>  <span class="token number">0.253</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /image/10001.png     <span class="token operator">|</span> <span class="token number">0.023</span> <span class="token operator">|</span> <span class="token number">0.056</span> <span class="token operator">|</span> <span class="token number">0.090</span> <span class="token operator">|</span>  <span class="token number">0.113</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> GET    <span class="token operator">|</span> /favicon.ico         <span class="token operator">|</span> <span class="token number">0.004</span> <span class="token operator">|</span> <span class="token number">0.004</span> <span class="token operator">|</span> <span class="token number">0.004</span> <span class="token operator">|</span>  <span class="token number">0.004</span> <span class="token operator">|</span>
+-------+--------+----------------------+-------+-------+-------+--------+
deadbeef<span class="token punctuation">(</span><span class="token number">23</span>:05:24<span class="token punctuation">)</span> ~/work/private-isu/webapp/logs/nginx
</code></pre></div></li></ul></li></ul> <h2 id="_5-データベースのチューニング"><a href="#_5-データベースのチューニング" class="header-anchor">#</a> 5. データベースのチューニング</h2> <ul><li><p>RDBMS</p> <ul><li>強い一貫性を持つ
<ul><li>一貫性とは、いくつもの表にわたり処理を行わなければならない場合でも生合成を保つ性質</li></ul></li> <li>MySQL, MariaDB, PostgreSQL, SQLite</li></ul></li> <li><p>NoSQL</p> <ul><li>強い一貫性を持たない代わりに高速な処理を実現する</li> <li>ソフトウェアによっては、複数のサーバに分散して高いスケーラビリティを持つ</li> <li>memcached, Redis, DynamoDB, Firebase Realtime Database, Cloud Firestore</li></ul></li> <li><p>NewSQL</p> <ul><li>強い一貫性と高いスケーラビリティおよび可用性を持つ</li> <li>代わりにサーバコストやレイテンシの部分で劣る</li> <li>Cloud Spanner, TiDB, Cockroach DB</li></ul></li> <li><p>スロークエリの可視化</p> <ul><li>pt-query-digest
<ul><li><p>Installation</p> <p><a href="https://www.percona.com/doc/percona-toolkit/LATEST/installation.html" target="_blank" rel="noopener noreferrer">Installing Percona Toolkit<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-bash extra-class"><pre class="language-bash"><code>// Debian系
<span class="token function">sudo</span> <span class="token function">apt</span> update
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> percona-toolkit
</code></pre></div><p>Slow Log Queryの有効化</p> <div class="language-bash extra-class"><pre class="language-bash"><code>// /etc/my.cnf
slow_query_log <span class="token operator">=</span> <span class="token number">1</span>
slow_query_log_file <span class="token operator">=</span> /var/log/mysql/mysql-slow.log
long_query_time <span class="token operator">=</span> <span class="token number">0</span>
</code></pre></div></li></ul></li></ul></li> <li><p>インデックス</p> <ul><li><strong>よく条件の絞り込みに使われる場合はインデックスを貼れ</strong> <ul><li>判断するにはEXPLAINを先頭につけて実行しろ</li> <li>複合インデックスも可能だが、可能な限り単一のインデックスにすべき</li></ul></li> <li><strong>何でもかんでもインデックスを貼るな！！！</strong> <ul><li>インデックスの追加、削除には時間がかかる</li> <li>データの追加・更新にも時間がかかる</li></ul></li> <li>プライマリインデックス
<ul><li>主キー(PRIMARY KEY)に貼られるインデックス</li> <li>1テーブルに1つしか存在できない</li></ul></li> <li>セカンダリインデックス
<ul><li>プライマリインデックス以外のインデックス</li> <li>プライマリインデックスを参照しないで結果が返せる高速化をCovering Indexと呼ぶ</li> <li>以下の例はプライマリインデックスを参照せずに結果が返せるため、 <code>user_id</code>にインデックスを貼ることで高速化が期待できる</li></ul></li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> comments WH
E user_id <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><p>LIKE句を用いている場合は全文検索インデックスが使える</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> comments <span class="token keyword">WHERE</span> <span class="token keyword">comment</span> <span class="token operator">LIKE</span> <span class="token string">'%hoge%'</span>
</code></pre></div><ul><li>BTree Indexの性質上、前方一致にしかインデックスを利用できない</li> <li>MySQLでは全文検索インデックスを適用できる</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> comments <span class="token keyword">ADD</span> FULLTEXT <span class="token keyword">INDEX</span> comments_full_idx <span class="token punctuation">(</span><span class="token keyword">comment</span><span class="token punctuation">)</span> <span class="token keyword">WITH</span> PARSER ngram<span class="token punctuation">;</span>
</code></pre></div></li></ul></li> <li><p>N+1問題</p> <ul><li>とりあえず <code>JOIN</code> 句で書き直すと解消されることがある
<ul><li>QueryがPreloadされるため</li></ul></li> <li>Cacheする
<ul><li>1度目のリクエストが遅くなる問題は解消されない</li> <li>起動時にCacheを登録することでN+1の問題を小さくする</li></ul></li> <li>Index
<ul><li><code>ORDER BY</code> 狙いのIndexは <code>FORCE INDEX</code> にしないと機能しないことがある</li></ul></li> <li><code>SELECT *</code> 系のクエリは無駄に多くのデータを取得することに繋がる場合もある
<ul><li>Columnの宣言時に <code>INVISIBLE</code> を付与する</li></ul></li> <li>Prepared Statementは効率が落ちがち
<ul><li>準備および開放(CLOSE)時にリソースを要するため</li> <li>Goなら <code>[sql.Open](http://sql.Open)</code> の時に、 <code>interpolateParams=true</code> にする</li></ul></li></ul></li> <li><p>DBとクライアントとのTCPコネクション</p> <ul><li>Client
<ul><li>MaxIdleConnection(default value: 2)
<ul><li>idle時に保持しておくコネクション数</li></ul></li> <li>MaxOpenConnection(default value: 0: inf)
<ul><li>最大接続数</li></ul></li></ul></li> <li>DB
<ul><li>max_connections
<ul><li><code>my.cnf</code> で設定できる</li></ul></li></ul></li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
max_connections <span class="token operator">=</span> <span class="token number">65535</span>
</code></pre></div></li> <li><p>innodbの設定(P162)</p></li></ul> <h2 id="_6-リバースプロキシの利用"><a href="#_6-リバースプロキシの利用" class="header-anchor">#</a> 6. リバースプロキシの利用</h2> <ul><li>静的ファイルをNginxサーバからサーブするとき</li></ul> <div class="language- extra-class"><pre class="language-text"><code>server {
  listen 80;

  # (snip)
  
	# js, jpg, png, css の拡張子を持つファイルを全てNginxから返す
	root /home/isucon/webapp/public/;

  location ~ .*\.(htm|html|css|js|jpg|png|gif|ico) {
    expires 24h;
    add_header Cache-Control public;
      
    open_file_cache max=100  # file descriptor などを cache

    gzip on;  # cpu 使うのでメリット・デメリット見極める必要あり。gzip_static 使えるなら事前にgzip圧縮した上でそちらを使う。
    gzip_types text/css application/javascript application/json application/font-woff application/font-tff image/gif image/png image/jpeg image/svg+xml image/x-icon application/octet-stream;
    gzip_disable &quot;msie6&quot;;
    gzip_static on;  # nginx configure時に --with-http_gzip_static_module 必要
    gzip_vary on;
    gzip_min_length 1k; # gzip圧縮すると元のファイルよりも大きくなることがある
  }

  location / {
    proxy_set_header Host $host;
    proxy_pass http://localhost:8080;
  }
}
</code></pre></div><ul><li><strong>application側でもgzip圧縮した方が良い</strong> <ul><li>ネットワークコストはパフォーマンス的にも金銭的にも高く、高い確率でボトルネックになるため</li> <li>gzip圧縮する前提でサーバのCPUを考慮した方が良い</li></ul></li> <li>keepaliveにするためには(P179)
<ul><li>メリットはコネクションの作り直しによるパフォーマンス低下や負荷の増加が減ること</li> <li>デメリットはkeepaliveを無効にしているときよりもコネクション数が増えれば増えるほどサーバ側に負荷がかかること</li> <li>HTTP/2の利用
<ul><li>Nginxで <code>listen 443 ssl http2</code> としておけば良い</li></ul></li></ul></li></ul> <h2 id="_7-キャッシュの活用"><a href="#_7-キャッシュの活用" class="header-anchor">#</a> 7. キャッシュの活用</h2> <ul><li>Thundering herd problem
<ul><li>キャッシュがない場合、大量のリクエストがappに来た場合、キャッシュを作成するためにOriginに大量のリクエストがいくこと</li></ul></li></ul> <h2 id="_8-押さえておきたい高速化手法"><a href="#_8-押さえておきたい高速化手法" class="header-anchor">#</a> 8. 押さえておきたい高速化手法</h2> <ul><li><strong>外部コマンドではなくライブラリを利用する</strong> <ul><li>opensslコマンドをshで実行するのではなく、言語側のライブラリを利用した方がオーバーヘッドが小さくなる</li></ul></li> <li>アプリケーション側で冗長なログを出力しない
<ul><li>ログ出力はディスクリプタをロックする上に時間がかかる</li></ul></li> <li>GoのHTTPクライアントについて
<ul><li><strong><strong><a href="https://qiita.com/ono_matope/items/60e96c01b43c64ed1d18" target="_blank" rel="noopener noreferrer">Goでnet/httpを使う時のこまごまとした注意<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong></strong></li></ul></li> <li>静的ファイル配信をリバースプロキシから直接配信する
<ul><li>ネットワーク帯域が逼迫しないようにするため</li> <li>アプリケーションサーバのメモリを食い潰さないようにするため</li></ul></li> <li>HTTPヘッダを用いてクライアント側にキャッシュさせる
<ul><li><code>Cache-Control: max-age=86400</code> のようなヘッダ</li> <li>Nginxであれば <code>expires</code> を設定しておけば 🆗</li></ul></li> <li>CDN……はISUCONにおいては多分気にしなくて良さそう</li></ul> <h2 id="_9-osの基礎知識とチューニング"><a href="#_9-osの基礎知識とチューニング" class="header-anchor">#</a> 9. OSの基礎知識とチューニング</h2> <ul><li>LinuxはOSとしてのコア機能をLinux Kernelと呼ばれるソフトウェアが担っている</li> <li>OS上で動作するアプリケーションはシステムコールと呼ばれる命令を用いてLinux Kernelの機能を利用している</li> <li>アプリケーションとOSのコア部分の間にインタフェースを設けて実装を分割することで、<strong>様々なハードウェアごとの違いをOS上で動作するアプリケーションがOSのレイヤーにおける違いを意識することなく利用できるようになっている</strong></li> <li>読み書きするファイルがどのようなハードウェアで書き込まれていて、どのようなファイルシステム上で読み書きが行われるのかを指定するものではない
<ul><li>システムコールを用いることで、ハードウェアやOSレイヤのシステムを隠蔽していることによる恩恵</li></ul></li> <li>open(2)の2はセクションの番号
<ul><li><a href="https://t.co/RyLxxLmS6u" target="_blank" rel="noopener noreferrer">https://atmarkit.itmedia.co.jp/flinux/rensai/linuxtips/073mannum.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li> <li>Linux Kernel側をカーネル空間</li> <li>システムコールを利用するLinuxOS上のアプリケーションが動作する部分をユーザ空間と呼ぶ</li> <li>カーネル空間で処理が完結する場合は、ユーザ空間と比較してオーバーヘッドが少なく、より高速に動作する傾向にある</li> <li>ミドルウェアなど、速度が要求されるアプリケーションは直接カーネル空間で処理を行うよう実装する例もたくさんある</li> <li>スループット
<ul><li>一定時間で処理できるパケットの量</li></ul></li> <li>レイテンシ
<ul><li>通信を開始してから終了するまでの所要時間</li></ul></li> <li>HDD
<ul><li>シーケンシャルリード/ライト &gt; ランダムリード/ライト</li></ul></li> <li>仮想ディスク
<ul><li>ランダムリード/ライト &gt; シーケンシャルリード/ライト</li></ul></li></ul> <hr> <ul><li>Linuxカーネルパラメータ
<ul><li><code>net.core.somaxconn</code> <ul><li>HTTPリクエストを受け取れるソケットの最大数</li></ul></li> <li><code>net.ipv4.ip_local_port_range</code> <ul><li>Ephemeral Portsの幅</li></ul></li></ul></li></ul> <h2 id="private-isuの攻略"><a href="#private-isuの攻略" class="header-anchor">#</a> private-isuの攻略</h2> <ol><li>commentsテーブルにインデックスを追加する</li> <li>静的ファイルをNginxで配信する</li> <li>アップロード画像を静的ファイル化する</li> <li>N+1の解決(JOINを利用する)</li> <li>prepared statementを除去する</li> <li>commentsテーブルへインデックスを追加する</li> <li>N+1結果をキャッシュする</li> <li>適切なインデックスを利用できないクエリを書き換える</li> <li>外部コマンドの呼び出しを止める</li> <li>MySQLのログを残さないようにする</li> <li>memcachedへのN+1の修正</li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">1ヶ月前</span></div></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.743ef69c.js" defer></script><script src="/assets/js/2.8c86708f.js" defer></script><script src="/assets/js/3.693800c4.js" defer></script><script src="/assets/js/44.cbe6deb9.js" defer></script><script src="/assets/js/4.cc429872.js" defer></script>
  </body>
</html>
