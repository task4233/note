<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>coreutilsのecho.cを読んでみた | Note</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/imgs/icons/icon.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="shortcut icon" href="/imgs/icons/favicon.ico">
    <meta name="description" content="coreutilsのecho.cを読んでみた">
    <meta name="theme-color" content="#3eaf7c">
    
    <link rel="preload" href="/assets/css/0.styles.e16f9711.css" as="style"><link rel="preload" href="/assets/js/app.a33662be.js" as="script"><link rel="preload" href="/assets/js/2.b8499f1b.js" as="script"><link rel="preload" href="/assets/js/39.3f037682.js" as="script"><link rel="preload" href="/assets/js/3.31e57b96.js" as="script"><link rel="prefetch" href="/assets/js/10.0dd0d291.js"><link rel="prefetch" href="/assets/js/11.a5a9905c.js"><link rel="prefetch" href="/assets/js/12.5d1e3edd.js"><link rel="prefetch" href="/assets/js/13.adfdc913.js"><link rel="prefetch" href="/assets/js/14.f02a189f.js"><link rel="prefetch" href="/assets/js/15.9af68a45.js"><link rel="prefetch" href="/assets/js/16.90c98123.js"><link rel="prefetch" href="/assets/js/17.34bd8f98.js"><link rel="prefetch" href="/assets/js/18.5ea8b8bc.js"><link rel="prefetch" href="/assets/js/19.8bf6995a.js"><link rel="prefetch" href="/assets/js/20.0e296bc9.js"><link rel="prefetch" href="/assets/js/21.b2738c76.js"><link rel="prefetch" href="/assets/js/22.774093c3.js"><link rel="prefetch" href="/assets/js/23.67d416eb.js"><link rel="prefetch" href="/assets/js/24.b5e37ced.js"><link rel="prefetch" href="/assets/js/25.3333e41a.js"><link rel="prefetch" href="/assets/js/26.ec36989c.js"><link rel="prefetch" href="/assets/js/27.6a7165c8.js"><link rel="prefetch" href="/assets/js/28.848f037e.js"><link rel="prefetch" href="/assets/js/29.06883845.js"><link rel="prefetch" href="/assets/js/30.b22580a5.js"><link rel="prefetch" href="/assets/js/31.c12ab2ca.js"><link rel="prefetch" href="/assets/js/32.477c0f3c.js"><link rel="prefetch" href="/assets/js/33.315baaed.js"><link rel="prefetch" href="/assets/js/34.d6ea7706.js"><link rel="prefetch" href="/assets/js/35.ea3e0e7d.js"><link rel="prefetch" href="/assets/js/36.bebf569c.js"><link rel="prefetch" href="/assets/js/37.a791948c.js"><link rel="prefetch" href="/assets/js/38.9f371b2a.js"><link rel="prefetch" href="/assets/js/4.00d6b6ad.js"><link rel="prefetch" href="/assets/js/40.ca3f59db.js"><link rel="prefetch" href="/assets/js/41.8a2d0c92.js"><link rel="prefetch" href="/assets/js/42.3bb2a14f.js"><link rel="prefetch" href="/assets/js/43.8ba63612.js"><link rel="prefetch" href="/assets/js/44.a3bafe91.js"><link rel="prefetch" href="/assets/js/45.7f1963c9.js"><link rel="prefetch" href="/assets/js/46.4756ce20.js"><link rel="prefetch" href="/assets/js/47.4bf95fae.js"><link rel="prefetch" href="/assets/js/48.464d51fa.js"><link rel="prefetch" href="/assets/js/49.deaca69c.js"><link rel="prefetch" href="/assets/js/5.69cbed0c.js"><link rel="prefetch" href="/assets/js/50.6da7e7e1.js"><link rel="prefetch" href="/assets/js/51.e913c7f1.js"><link rel="prefetch" href="/assets/js/52.ed54f3db.js"><link rel="prefetch" href="/assets/js/53.e5220f9b.js"><link rel="prefetch" href="/assets/js/54.b8f80eac.js"><link rel="prefetch" href="/assets/js/55.212e10e0.js"><link rel="prefetch" href="/assets/js/56.88f97d6e.js"><link rel="prefetch" href="/assets/js/57.d00ecba6.js"><link rel="prefetch" href="/assets/js/58.2e749948.js"><link rel="prefetch" href="/assets/js/59.fefcc1b3.js"><link rel="prefetch" href="/assets/js/6.5a204597.js"><link rel="prefetch" href="/assets/js/60.cbc945c0.js"><link rel="prefetch" href="/assets/js/61.10b6060f.js"><link rel="prefetch" href="/assets/js/62.c580d7bf.js"><link rel="prefetch" href="/assets/js/63.cc3c53a8.js"><link rel="prefetch" href="/assets/js/64.275452b6.js"><link rel="prefetch" href="/assets/js/65.87921f56.js"><link rel="prefetch" href="/assets/js/66.7a72ee1c.js"><link rel="prefetch" href="/assets/js/67.a503819c.js"><link rel="prefetch" href="/assets/js/68.04d66054.js"><link rel="prefetch" href="/assets/js/69.fae46257.js"><link rel="prefetch" href="/assets/js/7.0b1e9a07.js"><link rel="prefetch" href="/assets/js/70.6227bc86.js"><link rel="prefetch" href="/assets/js/71.90266fd1.js"><link rel="prefetch" href="/assets/js/72.2d81a560.js"><link rel="prefetch" href="/assets/js/73.228df1de.js"><link rel="prefetch" href="/assets/js/74.fd0856fb.js"><link rel="prefetch" href="/assets/js/75.aa40e419.js"><link rel="prefetch" href="/assets/js/76.e9c4dac0.js"><link rel="prefetch" href="/assets/js/77.a29bda43.js"><link rel="prefetch" href="/assets/js/78.89cda41a.js"><link rel="prefetch" href="/assets/js/79.c59b38e5.js"><link rel="prefetch" href="/assets/js/8.7d241289.js"><link rel="prefetch" href="/assets/js/80.4cb116ce.js"><link rel="prefetch" href="/assets/js/81.2fff5633.js"><link rel="prefetch" href="/assets/js/82.4a86d5e8.js"><link rel="prefetch" href="/assets/js/83.588944ea.js"><link rel="prefetch" href="/assets/js/84.df86302f.js"><link rel="prefetch" href="/assets/js/85.56799bdc.js"><link rel="prefetch" href="/assets/js/86.bb881330.js"><link rel="prefetch" href="/assets/js/87.54a91557.js"><link rel="prefetch" href="/assets/js/9.d5e50345.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e16f9711.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/#links" class="nav-link">Links</a></div><div class="nav-item"><a href="/tags/" class="nav-link">Articles</a></div><div class="nav-item"><a href="/chukapi_fun_art.html" class="nav-link">Chukapi-Fun-Art</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/#links" class="nav-link">Links</a></div><div class="nav-item"><a href="/tags/" class="nav-link">Articles</a></div><div class="nav-item"><a href="/chukapi_fun_art.html" class="nav-link">Chukapi-Fun-Art</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>coreutilsのecho.cを読んでみた</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/article/20200306.html#文字が表示されるまでの過程" class="sidebar-link">文字が表示されるまでの過程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/article/20200306.html#前処理部" class="sidebar-link">前処理部</a></li><li class="sidebar-sub-header"><a href="/article/20200306.html#引数処理部" class="sidebar-link">引数処理部</a></li><li class="sidebar-sub-header"><a href="/article/20200306.html#文字列出力部" class="sidebar-link">文字列出力部</a></li><li class="sidebar-sub-header"><a href="/article/20200306.html#backslashを解釈する場合または環境変数posixly-correctが存在している場合-以外の場合の処理" class="sidebar-link">(backslashを解釈する場合または環境変数POSIXLY_CORRECTが存在している場合) 以外の場合の処理</a></li></ul></li><li><a href="/article/20200306.html#references" class="sidebar-link">References</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="coreutilsのecho-cを読んでみた"><a href="#coreutilsのecho-cを読んでみた" class="header-anchor">#</a> coreutilsのecho.cを読んでみた</h1> <p>今回, coreutilsのソースコードとして, <a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c" target="_blank" rel="noopener noreferrer">GitHubで公開されているGNUのecho.c<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>を参照しました.</p> <p>今後用いる引数として, 第1引数を<code>echo</code>, それ以降に続くi番目の引数を第(i+1)引数とします.例えば, <code>echo -e &quot;hoge\nfuga\npiyo&quot; &quot;spam&quot;</code>の場合, <code>&quot;spam&quot;</code>は第4引数でたり, コマンド引数の数は4です.</p> <h2 id="文字が表示されるまでの過程"><a href="#文字が表示されるまでの過程" class="header-anchor">#</a> 文字が表示されるまでの過程</h2> <p>main関数内で文字が表示されるまでの過程は, 変数宣言等を行う前処理部, 引数をパースする引数処理部, 出力を行う文字列出力部の3部に分けられます.</p> <p>echoの想定入力は, <code>echo [-neE] [args...]</code> です. これらの内, <code>[-neE]</code>を処理するのが引数処理部, <code>[args...]</code>を処理するのが文字出力部です.</p> <p>それぞれ順番に説明します.</p> <h3 id="前処理部"><a href="#前処理部" class="header-anchor">#</a> 前処理部</h3> <p><a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L110-L127" target="_blank" rel="noopener noreferrer">前処理部<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>は, 変数宣言処理および前処理関数呼び出し処理の2つの処理によって構成されています.</p> <h4 id="変数宣言処理"><a href="#変数宣言処理" class="header-anchor">#</a> 変数宣言処理</h4> <p>変数宣言処理では, main関数内で必要とされている変数を宣言します.宣言された変数は以下の通りです.</p> <ul><li><a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L110" target="_blank" rel="noopener noreferrer"><code>bool display_return</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li>末尾の改行を出力するか否かを保持する変数</li> <li>初期値は<code>true</code> <ul><li>藤原によると, 互換性維持のために<a href="https://github.com/coreutils/gnulib/blob/master/lib/stdbool.in.h" target="_blank" rel="noopener noreferrer">lib/stdbool.in.h<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>で実装されているとのこと[1]</li></ul></li></ul></li> <li><a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L111" target="_blank" rel="noopener noreferrer"><code>bool posixly_correct</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li>環境変数<code>POSIXLY_CORRECT</code>の値を保持する変数</li> <li><a href="https://pubs.opengroup.org/onlinepubs/9699919799/functions/getenv.html" target="_blank" rel="noopener noreferrer">POSIX specification<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>によると, 環境変数が設定されていない場合はNULLポインタが返る仕様なのでfalse</li></ul></li> <li><a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L112-L114" target="_blank" rel="noopener noreferrer"><code>bool allow_options</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li><p>コマンドライン引数に含まれるオプションを許可するか否かを保持する変数</p></li> <li><p><code>DEFAULT_ECHO_TO_XPG</code>はデフォルトでエスケープシーケンスの解釈をするかを保持する変数</p> <ul><li><a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L30-L33" target="_blank" rel="noopener noreferrer">echo.c#L30-L33<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>で, この変数が定義されていない場合はfalseで初期化される</li></ul></li> <li><p><a href="https://github.com/coreutils/gnulib/blob/master/lib/fnmatch.c#L96" target="_blank" rel="noopener noreferrer"><code>STREQ()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>はgnulibで実装されているstrcmp()用のマクロ</p> <ul><li><a href="https://www2.cs.arizona.edu/~mccann/cstyle.html" target="_blank" rel="noopener noreferrer">Recommended C Style and Coding Standards<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>によると, strcmp()は正常系の帰り値が0なのでバグの原因になりやすいため, このマクロを紹介している[4]</li></ul></li></ul></li> <li><a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L119" target="_blank" rel="noopener noreferrer"><code>bool do_v9</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li><code>\n</code>のようなエスケープシーケンスを解釈するか否かを保持する変数</li> <li>先述した<code>DEFAULT_ECHO_TO_XPG</code>の値で初期化される</li></ul></li></ul> <h4 id="前処理関数呼び出し処理"><a href="#前処理関数呼び出し処理" class="header-anchor">#</a> 前処理関数呼び出し処理</h4> <p>前処理関数呼び出し処理では, main関数内の処理で必要とされている関数を実行します.実行する関数は以下の通りです.</p> <ul><li><a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L121" target="_blank" rel="noopener noreferrer"><code>initialize_main(&amp;amp;argc, &amp;amp;argv)</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li><a href="https://github.com/coreutils/coreutils/blob/master/src/system.h#L127-L136" target="_blank" rel="noopener noreferrer"><code>coreutils/src/system.h</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>でマクロが書かれている</li> <li><a href="https://stackoverflow.com/questions/19276701/what-does-initialize-main-argc-argv-do" target="_blank" rel="noopener noreferrer">What does initialize_main (&amp;argc, &amp;argv) do?<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>によると, 以前Linuxと競合していたOpenVMSというOSのためのマクロ
<ul><li>OpenVMSではリダイレクト(<code>&amp;gt;</code>)やワイルドカード(<code>*</code>)を認識しないため, これらを認識するように初期化するための関数と考えられる</li></ul></li></ul></li> <li><a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L122" target="_blank" rel="noopener noreferrer"><code>set_program_name(argv[0])</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li>argv[0]から実行されたコマンド名のみを抽出して、<code>program_name</code>というグローバル変数に格納[7]</li></ul></li> <li><a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L123" target="_blank" rel="noopener noreferrer"><code>setlocale(LC_ALL, &amp;quot;&amp;quot;)</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li><a href="http://www.c-tipsref.com/reference/locale/setlocale.html" target="_blank" rel="noopener noreferrer">setlocale in locale.h<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>ロケール (locale) 情報の設定を行う</li> <li>この場合, 全てのカテゴリで処理系依存の設定としている</li></ul></li> <li><a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L124" target="_blank" rel="noopener noreferrer"><code>bindtextdomain(PACKAGE, LOCALEDIR)</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li>ドメイン名&quot;PACKAGE&quot;のカタログディレクトリを&quot;LOCALEDIR&quot;に設定[9]</li> <li>具体的には, 変数PACKAGEはMakefile中に&quot;coreutils&quot;と定義され、変数LOCALEDIRはlib/configmake.h中に&quot;/usr/share/locale&quot;と定義されている</li></ul></li> <li><a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L125" target="_blank" rel="noopener noreferrer"><code>textdomain(PACKAGE)</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li>ドメイン名を&quot;PACKAGE=coreutils&quot;に設定[9]</li></ul></li> <li><a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L126" target="_blank" rel="noopener noreferrer"><code>atexit(close_stdout)</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li><a href="https://linuxjm.osdn.jp/html/LDP_man-pages/man3/atexit.3.html" target="_blank" rel="noopener noreferrer">atexit(3)システムコール<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>[8]</li> <li>プロセスが正常終了した時に呼び出される関数を登録</li></ul></li></ul> <h3 id="引数処理部"><a href="#引数処理部" class="header-anchor">#</a> 引数処理部</h3> <p><a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L129-L189" target="_blank" rel="noopener noreferrer">引数処理部<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>では略語の受け入れを避けるために, parse_long_optionsを使用するのではなく, 直接オプションをパースします.</p> <p>この部分は, (<code>allow_options</code>が<code>true</code>) かつ コマンド引数が2つの場合の処理, 見ているコマンドライン引数の更新 および <code>allow_options</code>が<code>true</code>の場合の処理がの3つの処理によって構成されています.</p> <h4 id="allow-optionsがtrue-かつ-コマンド引数が2つの場合の処理"><a href="#allow-optionsがtrue-かつ-コマンド引数が2つの場合の処理" class="header-anchor">#</a> (<code>allow_options</code>が<code>true</code>) かつ コマンド引数が2つの場合の処理</h4> <p>第2引数が<code>--help</code>ならば<code>usage(EXIT_SUCCESS)</code>を実行します.
<a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L35-L85" target="_blank" rel="noopener noreferrer"><code>usage()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>はfputs()を用いてコマンドのusageを表示します.この関数では, <a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L40" target="_blank" rel="noopener noreferrer"><code>assert()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>によって, それ以降のstatusが<code>EXIT_SUCCESS</code>であることを保証しています.</p> <p>第2引数が<code>--version</code>ならば, <code>version_etc(stdout, PROGRAM_NAME, PACKAGE_NAME, Version, AUTHORS, (char *)NULL)</code>を実行します.
<code>version_etc()</code>は<a href="https://github.com/coreutils/gnulib/blob/master/lib/version-etc.c" target="_blank" rel="noopener noreferrer">gnulib<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>で実装されています.</p> <p>これらの処理は単に<code>echo --help</code>や<code>echo --version</code>を実行するだけでは実行されません.<a href="https://qiita.com/YumaInaura/items/9dc68da0fac5a2703b25" target="_blank" rel="noopener noreferrer">こちらの記事<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>によると, builtinを無効化しないとこれらは実行されないとされています[6].</p> <p>確認用の実行ログは次の通りです.</p> <div class="language- extra-class"><pre class="language-text"><code>$ echo --help
--help
$ enable -n echo
$ echo --help
Usage: echo [SHORT-OPTION]... [STRING]...
  or:  echo LONG-OPTION
Echo the STRING(s) to standard output.

  -n             do not output the trailing newline
  -e             enable interpretation of backslash escapes
  -E             disable interpretation of backslash escapes (default)
      --help     display this help and exit
      --version  output version information and exit

If -e is in effect, the following sequences are recognized:

  \\      backslash
  \a      alert (BEL)
  \b      backspace
  \c      produce no further output
  \e      escape
  \f      form feed
  \n      new line
  \r      carriage return
  \t      horizontal tab
  \v      vertical tab
  \0NNN   byte with octal value NNN (1 to 3 digits)
  \xHH    byte with hexadecimal value HH (1 to 2 digits)

NOTE: your shell may have its own version of echo, which usually supersedes
the version described here.  Please refer to your shell's documentation
for details about the options it supports.

GNU coreutils online help: &lt;https://www.gnu.org/software/coreutils/&gt;
Full documentation at: &lt;https://www.gnu.org/software/coreutils/echo&gt;
or available locally via: info '(coreutils) echo invocation'
</code></pre></div><h4 id="見ているコマンドライン引数の更新"><a href="#見ているコマンドライン引数の更新" class="header-anchor">#</a> 見ているコマンドライン引数の更新</h4> <p>その後, <a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L144-L145" target="_blank" rel="noopener noreferrer">echo.c#L144-L145<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>で見ているコマンドライン引数を1つ次に進めます.具体的には, 残りのコマンドライン引数の数を保持している<code>argc</code>を1減らして, コマンドライン引数のデータが格納されている先頭アドレスのポインタが格納されている先頭アドレスが格納されているポインタである<code>argv</code>を1つ次に進めます.</p> <h4 id="allow-optionsがtrueの場合の処理"><a href="#allow-optionsがtrueの場合の処理" class="header-anchor">#</a> <code>allow_options</code>が<code>true</code>の場合の処理</h4> <p>残りのコマンドライン引数の数である<code>argc</code>が正 かつ 見ているコマンドライン引数の最初の文字が<code>-</code>である場合, 次の処理を繰り返し行います.1ループ処理が終了すると, <a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L187-L188" target="_blank" rel="noopener noreferrer">echo.c#L187-#L188<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>で, 先述した見ているコマンドライン引数の更新を随時行います.</p> <p><a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L150" target="_blank" rel="noopener noreferrer">echo.c#L150<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>でオプションと考えられる文字列の1文字目を取得します.<code>-e</code>の場合, <code>e</code>を取得します.</p> <p>その後, オプションを処理している場合は指定された全てのオプションが有効かどうかを確認します.具体的には, <a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L153-L167" target="_blank" rel="noopener noreferrer">echo.c#L153-L167<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>で<code>e</code>, <code>E</code>, <code>n</code>以外の文字が来た場合は, ラベル<code>just_echo</code>にジャンプし, それ以外はジャンプしません.このラベルは後述しますが, 一言でいうと文字列出力の直前に置かれているラベルです.例えば, <code>echo -eEEEeEEeeeEeenEEee &quot;hoge&quot;</code>はの<code>-</code>以降は有効ですが, <code>echo -abcdefghijdklmn &quot;hoge&quot;</code>の<code>-</code>以降は無効と判断され, ラベル<code>just_echo</code>にジャンプします.</p> <p>そして, <a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L169-L185" target="_blank" rel="noopener noreferrer">echo.c#L169-185<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>で, オプションが有効と判断された場合は, <code>e</code>ならば<code>do_v9</code>を<code>true</code>に, <code>E</code>ならば<code>do_v9</code>を<code>false</code>に, <code>n</code>ならば<code>display_return</code>を<code>false</code>にします.</p> <p>確認用の実行ログは以下の通りです.</p> <div class="language- extra-class"><pre class="language-text"><code>$ echo -eEEEeEEeeeEeenEEee &quot;hoge&quot;
hoge$ echo -abcdefghijdklmn &quot;hoge&quot;
-abcdefghijdklmn hoge
$ 
</code></pre></div><h3 id="文字列出力部"><a href="#文字列出力部" class="header-anchor">#</a> 文字列出力部</h3> <p><a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L191-L271" target="_blank" rel="noopener noreferrer">文字列出力部<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>は, 前処理部および引数処理部で設定された情報を用いてechoコマンドにおける出力部分を行います.</p> <p>この部分は, (backslashを解釈する場合または環境変数POSIXLY_CORRECTが存在している場合)の処理 および それ以外の場合処理, 末尾の改行処理の3つによって構成されています.</p> <h4 id="backslashを解釈する場合または環境変数posixly-correctが存在している場合-の処理"><a href="#backslashを解釈する場合または環境変数posixly-correctが存在している場合-の処理" class="header-anchor">#</a> (backslashを解釈する場合または環境変数POSIXLY_CORRECTが存在している場合)の処理</h4> <p>残りのコマンドライン引数が正の場合, 次の処理を繰り返し行います.</p> <p>今見ているコマンドライン引数の先頭アドレスを保持します.そして, 出力用のバッファのための<code>unsigned char</code>型の<code>c</code>を宣言します.その後, 先頭アドレスから格納されているデータの1文字目がバックスラッシュ(<code>\\</code>)である場合, その次のデータに応じて次の通りオプションを解釈します.これらの意味は, 先述した<code>usage()</code>に記載されています.</p> <table><thead><tr><th style="text-align:center;">オプションの引数</th> <th style="text-align:center;"><code>c</code>に格納される値</th> <th style="text-align:center;">意味</th></tr></thead> <tbody><tr><td style="text-align:center;"><code>a</code></td> <td style="text-align:center;"><code>\a</code></td> <td style="text-align:center;">alert(BEL)</td></tr> <tr><td style="text-align:center;"><code>b</code></td> <td style="text-align:center;"><code>\b</code></td> <td style="text-align:center;">backspace</td></tr> <tr><td style="text-align:center;"><code>c</code></td> <td style="text-align:center;">-</td> <td style="text-align:center;">強制終了(それ以上表示しない)</td></tr> <tr><td style="text-align:center;"><code>e</code></td> <td style="text-align:center;"><code>\x1B</code></td> <td style="text-align:center;">escape</td></tr> <tr><td style="text-align:center;"><code>f</code></td> <td style="text-align:center;"><code>\f</code></td> <td style="text-align:center;">form feedを作る</td></tr> <tr><td style="text-align:center;"><code>n</code></td> <td style="text-align:center;"><code>\n</code></td> <td style="text-align:center;">改行(new line)</td></tr> <tr><td style="text-align:center;"><code>r</code></td> <td style="text-align:center;"><code>\r</code></td> <td style="text-align:center;">改行(carriage return)</td></tr> <tr><td style="text-align:center;"><code>t</code></td> <td style="text-align:center;"><code>\t</code></td> <td style="text-align:center;">horizontal tab</td></tr> <tr><td style="text-align:center;"><code>v</code></td> <td style="text-align:center;"><code>\v</code></td> <td style="text-align:center;">vertical tab</td></tr> <tr><td style="text-align:center;"><code>x</code></td> <td style="text-align:center;"><code>\xnn</code></td> <td style="text-align:center;">interpreting in hexadecimal(詳細は後述)</td></tr> <tr><td style="text-align:center;"><code>0-9</code></td> <td style="text-align:center;"><code>\0nnn</code></td> <td style="text-align:center;">the charactor whose ASCII code is NNN(octal)</td></tr> <tr><td style="text-align:center;"><code>\\</code></td> <td style="text-align:center;">-</td> <td style="text-align:center;"><a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L247" target="_blank" rel="noopener noreferrer">そのまま<code>\\</code>を出力<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr></tbody></table> <p>ここで, <code>\x</code>および<code>\0-9</code>の処理を深堀りします.</p> <p><code>\x</code>の処理では, まず<a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L218-L219" target="_blank" rel="noopener noreferrer">echo.c#L218-L219<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>で続く文字列が<a href="http://www.c-tipsref.com/reference/ctype/isxdigit.html" target="_blank" rel="noopener noreferrer"><code>isxdigit()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>で16進数であることを確認し, 異なる場合はバックスラッシュ(<code>\\</code>)を単体とみなします.その後, 16進数のchar型を10進数に変換する<a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L87-L101" target="_blank" rel="noopener noreferrer">hextobin()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>を介して16進数の文字が1桁ならばそのまま<code>c</code>に格納し, 2桁ならば16倍する処理を挟んで<code>c</code>に格納します.ここで, <code>c</code>は<code>unsigned char</code>型ですが, サイズは1バイトであるため2桁までの16進数なら値を保持できます.</p> <p><code>\0-9</code>の処理では, 8進数の範囲を超えていないか確認する処理を挟みつつ, <code>\x</code>の時と同様に<code>c</code>に値を格納します.</p> <p>最後に, <a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L250" target="_blank" rel="noopener noreferrer">echo.c#L250<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>の<code>putchar()</code>で<code>c</code>に格納したデータを出力します.</p> <p>1ループ処理が終了すると, <a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L252-L253" target="_blank" rel="noopener noreferrer">echo.c#L252-#L253<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>で, 先述した見ているコマンドライン引数の更新を随時行います.同時に, <code>putchar()</code>を用いたスペース(<code></code>)の出力も行います.</p> <h3 id="backslashを解釈する場合または環境変数posixly-correctが存在している場合-以外の場合の処理"><a href="#backslashを解釈する場合または環境変数posixly-correctが存在している場合-以外の場合の処理" class="header-anchor">#</a> (backslashを解釈する場合または環境変数POSIXLY_CORRECTが存在している場合) 以外の場合の処理</h3> <p>残りのコマンドライン引数が正の場合, <code>fputs()</code>を用いて, 見ているコマンドライン引数をそのまま出力します.</p> <p>1ループ処理が終了すると, <a href="https://github.com/coreutils/coreutils/blob/master/src/echo.c#L263-L264" target="_blank" rel="noopener noreferrer">echo.c#L263-#L264<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>で, 先述した見ているコマンドライン引数の更新を随時行います.同時に, <code>putchar()</code>を用いたスペース(<code></code>)の出力も行います.</p> <h4 id="末尾の改行処理"><a href="#末尾の改行処理" class="header-anchor">#</a> 末尾の改行処理</h4> <p>先述した<code>display_return</code>が<code>true</code>ならば<code>putchar('\n')</code>を実行します.
それが終了後, <code>EXIT_SUCCESS</code>を返します.</p> <h2 id="references"><a href="#references" class="header-anchor">#</a> References</h2> <ul><li>[0] Ryo Ezoe (2013)「様々なUNIX環境のecho.cの比較」,
[online] https://cpplover.blogspot.com/2013/04/unixechoc.html (2020-03-01参照).</li> <li>[1] 藤原克則 (2013) 「lsを読まずにプログラマを名乗るな！」, 秀和システム.</li> <li>[2] coreutils 「coreutils / coreutils」,
[online] https://github.com/coreutils/coreutils (2020-03-01参照).</li> <li>[3] gnulib 「coreutils / gnulib」,
[online] https://github.com/coreutils/gnulib (2020-03-01参照).</li> <li>[4] Spencer, Keppel, Brader他 (1990)「Recommended C Style and Coding Standards」,
[online] https://www2.cs.arizona.edu/~mccann/cstyle.html (2020-03-01参照).</li> <li>[5] 「What does initialize_main (&amp;argc, &amp;argv) do?」,
[online] https://stackoverflow.com/questions/19276701/what-does-initialize-main-argc-argv-do (2020-03-01参照).</li> <li>[6] YumaInaura (2018) 「Bash — echo --help でヘルプが表示されない理由から考える シェルの bultin コマンドなどなど」,
[online] https://qiita.com/YumaInaura/items/9dc68da0fac5a2703b25 (2020-03-01参照).</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">3ヶ月前</span></div></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.a33662be.js" defer></script><script src="/assets/js/2.b8499f1b.js" defer></script><script src="/assets/js/39.3f037682.js" defer></script><script src="/assets/js/3.31e57b96.js" defer></script>
  </body>
</html>
