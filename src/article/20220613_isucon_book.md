---
date: 2022-06-13
description: 'ISUCONæœ¬ã®ãƒ¡ãƒ¢'
tags:
 - è¨˜éŒ²
---

# ISUCONæœ¬ã®ãƒ¡ãƒ¢

ğŸ’¡
ã“ã‚Œã¯ISUCONæœ¬ã‚’èª­ã‚“ã æ™‚ã«æ€ã£ãŸã“ã¨ã‚„æ–°ã—ãçŸ¥ã£ãŸã“ã¨ã‚’è¨€è‘‰ã«èµ·ã“ã™ãŸã‚ã«ä½¿ã†ãƒ¡ãƒ¢ã§ã™ã€‚é›‘å¤šã«æ›¸ãã¾ã™ã€‚

## References

- è—¤åŸ et al., "é”äººãŒæ•™ãˆã‚‹Webãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã€œISUCONã‹ã‚‰å­¦ã¶é«˜é€ŸåŒ–ã®å®Ÿè·µ", 2022, ISBN 978-4-297-12846-3.
- [GitHub](https://github.com/task4233/private-isu)
- [ISUCON Cheat Sheet](https://gist.github.com/south37/d4a5a8158f49e067237c17d13ecab12a)

## 1ç«  ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã®åŸºç¤çŸ¥è­˜

- å‚ç›´ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°(ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—/ãƒ€ã‚¦ãƒ³)
    - ã‚µãƒ¼ãƒã®æ€§èƒ½ã‚’å‘ä¸Š/ä½ä¸‹ã•ã›ã‚‹ã“ã¨
- æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°(ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ/ã‚¤ãƒ³)
    - ã‚µãƒ¼ãƒã®æ•°ã‚’å¢—åŠ /æ¸›å°‘ã•ã›ã‚‹ã“ã¨

### **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã®åŸºæœ¬ã®ã**

- **ã„ããªã‚Šæ‰‹ã‚’å‹•ã‹ã•ãªã„**
- **å‹˜ã§è¡Œå‹•ã—ãªã„**
- **ã€ŒåŸºæœ¬ã®ãã€ã‹ã‚‰ã€ŒåŸºæœ¬ã®ã‚“ã€ã¾ã§èª­ã‚“ã§ã‹ã‚‰ã€è€ƒãˆã¦ã€è¡Œå‹•ã™ã‚‹**

- æ¨æ¸¬ã›ãšè¨ˆæ¸¬ã™ã‚‹
    - æŒ‡æ¨™
        - ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹åˆ©ç”¨çŠ¶æ³
        - ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·
        - ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ
    - è² è·è©¦é¨“ã‚’ã™ã‚‹éš›ã«ã€ä¸è² è·å´ã®ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä¸è¶³ãŒå¾‹é€ŸåŸå› ã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹
- å…¬å¹³ã«æ¯”è¼ƒã™ã‚‹
    - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®å›ç·šãŒåŸå› ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒä½ä¸‹ã™ã‚‹ã“ã¨ã‚‚ã‚ã‚‹
- 1ã¤ãšã¤æ¯”è¼ƒã™ã‚‹
    - ã¾ã¨ã‚ã¦æ–½ç­–ã‚’é©ç”¨ã™ã‚‹ã¨ã€ã©ã®æ–½ç­–ãŒåˆºã•ã£ãŸã®ã‹ãŒåˆ†ã‹ã‚‰ãªããªã‚‹
    - PRã¯1ã¤ãšã¤ãƒãƒ¼ã‚¸ã—ã¦æŒ‡æ¨™ã‚’å–ã‚‹

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã®åŸºæœ¬ã®ã»

- **ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã ã‘ã«ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã™ã‚‹**
    - ãƒ¬ã‚¸ãŒæ··ã‚“ã§ã„ã‚‹ã®ã«ã€å…¥ã‚Šå£ã¨åº—å†…ã‚’åºƒãã—ã¦ã‚‚æ™‚é–“å½“ãŸã‚Šã®å£²ã‚Šä¸Šã’ã¯ä¸ŠãŒã‚‰ãªã„
    - æœ€æ‚ªã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒè½ã¡ã‚‹
- **ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã®ç‰¹å®šã¯å¤–å´ã‹ã‚‰é †ç•ªã«**
    - Webã‚µãƒ¼ãƒ“ã‚¹ã«ãŠã‘ã‚‹å…¥å‡ºåŠ›ã®ä¸€ç•ªå¤–å´ã‹ã‚‰è¦‹ã‚‹
        - æ‰€è¦æ™‚é–“ãŒé•·ã„ç®‡æ‰€
        - ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ã®åˆ©ç”¨ç‡ãŒé«˜ã„ç®‡æ‰€
    - ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã«ãªã‚ŠãŒã¡ãªç®‡æ‰€
        - CPU
        - ãƒ¡ãƒ¢ãƒª
        - ãƒ‡ã‚£ã‚¹ã‚¯I/O
        - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯I/O
- **ãƒœãƒˆãƒ«ãƒãƒƒã‚¯å¯¾å‡¦ã®åŸºæœ¬3ãƒ‘ã‚¿ãƒ¼ãƒ³**
    1. è§£æ±º
        
        èª²é¡Œã«ãªã£ã¦ã„ã‚‹äº‹è±¡ã‚’æ ¹æœ¬ã‹ã‚‰è§£æ±ºã™ã‚‹
        
    2. å›é¿
        
        èª²é¡Œã«ãªã£ã¦ã„ã‚‹äº‹è±¡ãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã«ãªã‚‰ãªã„ã‚ˆã†ã«è¿‚å›ãƒ»çœç•¥ã™ã‚‹
        
    3. ç·©å’Œ
        
        èª²é¡Œã«ãªã£ã¦ã„ã‚‹äº‹è±¡ã®å½±éŸ¿ã‚’å’Œã‚‰ã’ã‚‹
        
    - å¯¾å¿œã‚³ã‚¹ãƒˆã¯å›é¿ < ç·©å’Œ

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã®åŸºæœ¬ã®ã‚“

- é«˜é€ŸåŒ–ã®å…·ä½“çš„ãªæ´»å‹•
    1. è² è·è©¦é¨“è¨ˆç”»
    2. å®Ÿæ–½æº–å‚™
    3. è² è·è©¦è¡Œâ†’çµæœç¢ºèªâ†’æ”¹å–„â†’è² è·è©¦è¡Œâ†’â€¦
- è² è·è©¦é¨“ã®è¨ˆç”»(é …ç›®ã¯P19)
    - **å¿…ãšå®šã‚ã¦ï¼ï¼ï¼**
    - **ä½•ã®ãŸã‚ã«(ç›®çš„)ï¼Ÿ**
    - **ã©ã®ã‚ˆã†ã«(æ–¹æ³•)ï¼Ÿ**
    - **ã©ã®ç¨‹åº¦ã¾ã§(ã‚´ãƒ¼ãƒ«)ï¼Ÿ**
- è¢«è² è·ç’°å¢ƒã®æº–å‚™
    - è² è·ã‚’ã‹ã‘ãªãŒã‚‰æ‰‹å‹•ã§ä½¿ç”¨æ„Ÿã‚’ç¢ºã‹ã‚ã‚‹ã®ã‚‚ã‚¢ãƒª
    - å®Ÿæ–½æ™‚é–“ãƒ»å®Ÿæ–½çµæœãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ»ãƒ­ã‚°ã‚’ã‚»ãƒƒãƒˆã§è‡ªå‹•ã§è¨˜éŒ²ã—ã¦ãŠãã¨è‰¯ã„
        - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®æ—¥æ™‚æŒ‡å®šæ©Ÿèƒ½ã§URLã‚’ç”Ÿæˆã™ã‚‹
        - Slack/Discordã«Postã™ã‚‹ã‚ˆã†ã«ã—ã¦ãŠã
    - å®Ÿæ–½çµæœã‚’éƒ½åº¦è§£é‡ˆã™ã‚‹
        - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: Xä¸¦åˆ—ã§Yãƒ¦ãƒ¼ã‚¶ãŒNåˆ†é–“ã§æ“ä½œå®Œäº†
        - ç•°å¸¸ã®æœ‰ç„¡: ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã€ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ã€ä¸å¯©ãªæŒ™å‹•ã€ä¸å®‰å®šãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ 
        - ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã®ç§»å‹•æœ‰ç„¡
        - ãã‚Œãã‚Œã®å€¤ã€ãƒªã‚½ãƒ¼ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®å€¤ãŒæƒ³å®šé€šã‚Šå¤‰åŒ–ã—ãŸã‹

## 2ç«  ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

- å¤–å½¢ç›£è¦–
    - Webã‚µãƒ¼ãƒ“ã‚¹ã®å¤–ã‹ã‚‰ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹æ‰‹æ³•
    - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çš„ãªæ¥ç¶šãƒˆãƒ©ãƒ–ãƒ«ã®ç™ºè¦‹ã«æœ‰åŠ¹ã ãŒã€å®Œå…¨ãªå†ç¾ã¯ç¾å®Ÿçš„ã§ã¯ãªã„
- å†…éƒ¨ç›£è¦–
    - Webã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å†…å´ã‹ã‚‰ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹æ‰‹æ³•
    - å¤–éƒ¨ãƒ¦ãƒ¼ã‚¶ãŒè¦‹ã‚Œãªã„ã€ãƒªã‚½ãƒ¼ã‚¹ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç­‰ã‚’ç›£è¦–ã§ãã‚‹
    - pullå‹(Prometheus)
        - ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³(ä»¥ä¸‹MA)ãŒå„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‹ã‚‰ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’pullã—ã¦ãã‚‹
        - ãƒ¡ãƒªãƒƒãƒˆ
            - MAå´ã§å–å¾—é–“éš”ã‚’ç®¡ç†ã§ãã‚‹
            - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè£…ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«ã§ãã‚‹
    - pushå‹
        - å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’pushã™ã‚‹
        - ãƒ¡ãƒªãƒƒãƒˆ
            - ã‚µãƒ¼ãƒå´ã®ãƒãƒ¼ãƒˆã‚’é–‹ã‘ãšã«æ¸ˆã‚€
            - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ç®¡ç†ã‚’ã›ãšã«æ¸ˆã‚€
- ä½¿ãˆã‚‹ã‚³ãƒãƒ³ãƒ‰
    
    ```bash
    : ãƒãƒ«ãƒã‚³ã‚¢CPUä½¿ç”¨ç‡ã®åé›†
    mpstat -P ALL
    
    : ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ä¸Šä½5ä»¶ã®ãƒ—ãƒ­ã‚»ã‚¹ã®åé›†
    ps aux --sort -%mem | head -5
    
    : ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ã®åé›†
    free -m
    ```
    
- å‰²åˆ(%)ã®å¤‰å‹•å…·åˆã‚’æ¯”è¼ƒã—ãªã„ã“ã¨
    - 15%å¢—ã¨10%å¢—ã¯ã€ãã‚‚ãã‚‚ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ãŒç•°ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§æ¯”è¼ƒã—ã¦ã‚‚æ„å‘³ãŒãªã„
- åŒã˜ã‚µãƒ¼ãƒå†…ã‹ã‚‰è² è·è©¦é¨“ã‚’è¡Œã‚ãªã„ã“ã¨
    - æ¤œè¨¼å¯¾è±¡ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½¿ã†ã®ã§ã€ãã‚Œã¯ãã†

## 3. åŸºç¤çš„ãªè² è·è©¦é¨“

- alp

```bash
alp json --file access.log
```

- ab
- abã¨alpã®æ¯”è¼ƒ
    
    abã® `Time per request` ã¨alpã® `avg` ãŒåŒã˜ãã‚‰ã„ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
    
    abã®çµæœ
    
    ```bash
    % ab -c 1 -n 10 http://localhost/                                                                                                                                      [~/work/private-isu/webapp]+[master]
    This is ApacheBench, Version 2.3 <$Revision: 1879490 $>
    Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
    Licensed to The Apache Software Foundation, http://www.apache.org/
    
    Benchmarking localhost (be patient).....done
    
    Server Software:        nginx/1.22.0
    Server Hostname:        localhost
    Server Port:            80
    
    Document Path:          /
    Document Length:        35054 bytes
    
    Concurrency Level:      1
    Time taken for tests:   23.625 seconds
    Complete requests:      10
    Failed requests:        0
    Total transferred:      354170 bytes
    HTML transferred:       350540 bytes
    Requests per second:    0.42 [#/sec] (mean)
    **Time per request:       2362.545 [ms] (mean)**
    Time per request:       2362.545 [ms] (mean, across all concurrent requests)
    Transfer rate:          14.64 [Kbytes/sec] received
    
    Connection Times (ms)
                  min  mean[+/-sd] median   max
    Connect:        0    0   0.1      0       0
    Processing:  1758 2362 982.9   1899    4597
    Waiting:     1758 2361 982.4   1899    4595
    Total:       1758 2362 982.9   1899    4597
    
    Percentage of the requests served within a certain time (ms)
      50%   1899
      66%   2025
      75%   2378
      80%   3706
      90%   4597
      95%   4597
      98%   4597
      99%   4597
     100%   4597 (longest request)
    ```
    
    alpã®çµæœ
    
    ```bash
    % tail -n 10 logs/nginx/access.log| alp json -o count,method,uri,min,avg,max
    +-------+--------+-----+-------+-------+-------+
    | COUNT | METHOD | URI |  MIN  |  AVG  |  MAX  |
    +-------+--------+-----+-------+-------+-------+
    |    10 | GET    | /   | 1.755 | **2.357** | 4.590 |
    +-------+--------+-----+-------+-------+-------+
    ```
    

- mysqldumpslowã¨pt-query-digestã®æ¯”è¼ƒ
- mysqldumpslow
    
    ```bash
    % mysqldumpslow logs/mysql/mysql-slow.log                       [~/work/private-isu/webapp]+[master]
    
    Reading mysql slow query log from logs/mysql/mysql-slow.log
    Count: 1  Time=0.08s (0s)  Lock=0.00s (0s)  Rows=10001.0 (10001), root[root]@webapp_app_1.webapp_default
      SELECT `id`, `user_id`, `body`, `created_at`, `mime` FROM `posts` ORDER BY `created_at` DESC
    
    Count: 22  Time=0.06s (1s)  Lock=0.00s (0s)  Rows=2.9 (64), root[root]@webapp_app_1.webapp_default
      SELECT * FROM `comments` WHERE `post_id` = N ORDER BY `created_at` DESC LIMIT N
    
    Count: 22  Time=0.02s (0s)  Lock=0.00s (0s)  Rows=1.0 (22), root[root]@webapp_app_1.webapp_default
      SELECT COUNT(*) AS `count` FROM `comments` WHERE `post_id` = N
    
    Count: 20  Time=0.00s (0s)  Lock=0.00s (0s)  Rows=1.0 (20), root[root]@webapp_app_1.webapp_default
      SELECT * FROM `posts` WHERE `id` = N
    
    Count: 86  Time=0.00s (0s)  Lock=0.00s (0s)  Rows=1.0 (86), root[root]@webapp_app_1.webapp_default
      SELECT * FROM `users` WHERE `id` = N
    
    Count: 305  Time=0.00s (0s)  Lock=0.00s (0s)  Rows=0.4 (133), 2users@2hosts
      #
    
    Count: 150  Time=0.00s (0s)  Lock=0.00s (0s)  Rows=0.0 (0), 0users@0hosts
      administrator command: Prepare
    
    Count: 133  Time=0.00s (0s)  Lock=0.00s (0s)  Rows=0.0 (0), 0users@0hosts
      administrator command: Close stmt
    
    Count: 11  Time=0.00s (0s)  Lock=0.00s (0s)  Rows=0.0 (0), 0users@0hosts
      administrator command: Ping
    
    Count: 11  Time=0.00s (0s)  Lock=0.00s (0s)  Rows=0.0 (0), 0users@0hosts
      administrator command: Quit
    ```
    
- pt-query-digest
    
    ```bash
    pt-query-digest ./logs/mysql/mysql-slow.log                   [~/work/private-isu/webapp]+[master]
    
    # A software update is available:
    #   * The current version for Percona::Toolkit is 3.0.5
    
    # 360ms user time, 140ms system time, 34.92M rss, 4.13G vsz
    # Current date: Wed Jun  8 23:22:35 2022
    # Hostname: deadbeef.local
    # Files: ./logs/mysql/mysql-slow.log
    # Overall: 460 total, 9 unique, 1.27 QPS, 0.01x concurrency ______________
    # Time range: 2022-06-08T14:16:23 to 2022-06-08T14:22:24
    # Attribute          total     min     max     avg     95%  stddev  median
    # ============     ======= ======= ======= ======= ======= ======= =======
    # Exec time             2s     4us    88ms     5ms    59ms    15ms   236us
    # Lock time          465us       0    17us     1us     2us     1us       0
    # Rows sent          9.95k       0   9.77k   22.16    0.99  444.93       0
    # Rows examine       4.22M       0  97.66k   9.38k  97.04k  28.54k       0
    # Query size        16.57k      27      92   36.88   65.89   12.74   31.70
    
    # Profile
    # Rank Query ID           Response time Calls R/Call V/M   Item
    # ==== ================== ============= ===== ====== ===== ===============
    #    1 0x16849282195BE09F  1.4162 66.5%    22 0.0644  0.00 SELECT comments
    #    2 0x7539A5F45EB76A80  0.5197 24.4%    22 0.0236  0.01 SELECT comments
    #    3 0x44D0B06948A2E5CC  0.0825  3.9%     1 0.0825  0.00 SELECT posts
    #    4 0x99AA0165670CE848  0.0513  2.4%   150 0.0003  0.00 ADMIN PREPARE
    # MISC 0xMISC              0.0600  2.8%   265 0.0002   0.0 <5 ITEMS>
    
    # Query 1: 11 QPS, 0.71x concurrency, ID 0x16849282195BE09F at byte 20337
    # This item is included in the report because it matches --limit.
    # Scores: V/M = 0.00
    # Time range: 2022-06-08T14:17:38 to 2022-06-08T14:17:40
    # Attribute    pct   total     min     max     avg     95%  stddev  median
    # ============ === ======= ======= ======= ======= ======= ======= =======
    # Count          4      22
    # Exec time     66      1s    60ms    81ms    64ms    68ms     5ms    61ms
    # Lock time     12    57us     2us     4us     2us     2us       0     2us
    # Rows sent      0      64       1       3    2.91    2.90    0.40    2.90
    # Rows examine  49   2.10M  97.66k  97.66k  97.66k  97.04k       0  97.04k
    # Query size    10   1.76k      82      83   82.09   80.10    0.00   80.10
    # String:
    # Databases    isuconp
    # Hosts        webapp_app_1.webapp_default
    # Users        root
    # Query_time distribution
    #   1us
    #  10us
    # 100us
    #   1ms
    #  10ms  ################################################################
    # 100ms
    #    1s
    #  10s+
    # Tables
    #    SHOW TABLE STATUS FROM `isuconp` LIKE 'comments'\G
    #    SHOW CREATE TABLE `isuconp`.`comments`\G
    # EXPLAIN /*!50100 PARTITIONS*/
    SELECT * FROM `comments` WHERE `post_id` = 9995 ORDER BY `created_at` DESC LIMIT 3\G
    
    # Query 2: 11 QPS, 0.26x concurrency, ID 0x7539A5F45EB76A80 at byte 2174 _
    # This item is included in the report because it matches --limit.
    # Scores: V/M = 0.01
    # Time range: 2022-06-08T14:17:38 to 2022-06-08T14:17:40
    # Attribute    pct   total     min     max     avg     95%  stddev  median
    # ============ === ======= ======= ======= ======= ======= ======= =======
    # Count          4      22
    # Exec time     24   520ms    19ms    88ms    24ms    21ms    14ms    20ms
    # Lock time     11    55us     2us     4us     2us     2us       0     1us
    # Rows sent      0      22       1       1       1       1       0       1
    # Rows examine  49   2.10M  97.66k  97.66k  97.66k  97.66k       0  97.66k
    # Query size     8   1.40k      65      66   65.09   62.76    0.50   62.76
    # String:
    # Databases    isuconp
    # Hosts        webapp_app_1.webapp_default
    # Users        root
    # Query_time distribution
    #   1us
    #  10us
    # 100us
    #   1ms
    #  10ms  ################################################################
    # 100ms
    #    1s
    #  10s+
    # Tables
    #    SHOW TABLE STATUS FROM `isuconp` LIKE 'comments'\G
    #    SHOW CREATE TABLE `isuconp`.`comments`\G
    # EXPLAIN /*!50100 PARTITIONS*/
    SELECT COUNT(*) AS `count` FROM `comments` WHERE `post_id` = 10001\G
    
    # Query 3: 0 QPS, 0x concurrency, ID 0x44D0B06948A2E5CC at byte 1595 _____
    # This item is included in the report because it matches --limit.
    # Scores: V/M = 0.00
    # Time range: all events occurred at 2022-06-08T14:17:38
    # Attribute    pct   total     min     max     avg     95%  stddev  median
    # ============ === ======= ======= ======= ======= ======= ======= =======
    # Count          0       1
    # Exec time      3    82ms    82ms    82ms    82ms    82ms       0    82ms
    # Lock time      3    17us    17us    17us    17us    17us       0    17us
    # Rows sent     98   9.77k   9.77k   9.77k   9.77k   9.77k       0   9.77k
    # Rows examine   0  19.53k  19.53k  19.53k  19.53k  19.53k       0  19.53k
    # Query size     0      92      92      92      92      92       0      92
    # String:
    # Databases    isuconp
    # Hosts        webapp_app_1.webapp_default
    # Users        root
    # Query_time distribution
    #   1us
    #  10us
    # 100us
    #   1ms
    #  10ms  ################################################################
    # 100ms
    #    1s
    #  10s+
    # Tables
    #    SHOW TABLE STATUS FROM `isuconp` LIKE 'posts'\G
    #    SHOW CREATE TABLE `isuconp`.`posts`\G
    # EXPLAIN /*!50100 PARTITIONS*/
    SELECT `id`, `user_id`, `body`, `created_at`, `mime` FROM `posts` ORDER BY `created_at` DESC\G
    
    # Query 4: 37.50 QPS, 0.01x concurrency, ID 0x99AA0165670CE848 at byte 1926
    # This item is included in the report because it matches --limit.
    # Scores: V/M = 0.00
    # Time range: 2022-06-08T14:17:38 to 2022-06-08T14:17:42
    # Attribute    pct   total     min     max     avg     95%  stddev  median
    # ============ === ======= ======= ======= ======= ======= ======= =======
    # Count         32     150
    # Exec time      2    51ms   140us     5ms   341us   467us   419us   260us
    # Lock time      5    25us       0    16us       0       0     1us       0
    # Rows sent      0       0       0       0       0       0       0       0
    # Rows examine   0       0       0       0       0       0       0       0
    # Query size    26   4.39k      30      30      30      30       0      30
    # String:
    # Databases    isuconp
    # Hosts        webapp_app_1.webapp_default
    # Users        root
    # Query_time distribution
    #   1us
    #  10us
    # 100us  ################################################################
    #   1ms  #
    #  10ms
    # 100ms
    #    1s
    #  10s+
    administrator command: Prepare\G
    ```
    

- CPUä½¿ç”¨ç‡ã®å±¥æ­´ã‚’æ®‹ã—ãŸã„å ´åˆã¯ `$ dstat`

```bash
dstat --cpu
```

## 4. ã‚·ãƒŠãƒªã‚ªã‚’æŒã£ãŸè² è·è©¦é¨“

- k6
    - HTTP/1.1, 2, WebSocket, gRPCã§ã‚·ãƒŠãƒªã‚ªãƒ™ãƒ¼ã‚¹ã®è² è·è©¦é¨“ã‚’è¡Œãˆã‚‹ãƒ„ãƒ¼ãƒ«
    - MacOSãªã‚‰ `$ brew install k6`
    - ä»–OSãªã‚‰[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://k6.io/docs/getting-started/installation/)ã‚’å‚ç…§ã—ã¦
- ä¸¦åˆ—åº¦1ã§30ç§’é–“å®Ÿè¡Œã™ã‚‹å ´åˆ
    - `$ k6 run --vus 1 --duration 30s ab.js`
    - `vus` ã¯Virtual Usersã®ç•¥
- å˜ä¸€URLã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã‚·ãƒŠãƒªã‚ª
    
    ```bash
    % cat ab.js                                                                                                                                                        [~/work/private-isu/k6]+[master]
    import http from "k6/http"
    
    const BASE_URL = "http://localhost";
    
    export default function() {
      http.get(`${BASE_URL}/`);
    }
    % k6 run --vus 1 --duration 30s ab.js                                                                                                                              [~/work/private-isu/k6]+[master]
    
              /\      |â€¾â€¾| /â€¾â€¾/   /â€¾â€¾/   
         /\  /  \     |  |/  /   /  /    
        /  \/    \    |     (   /   â€¾â€¾\  
       /          \   |  |\  \ |  (â€¾)  | 
      / __________ \  |__| \__\ \_____/ .io
    
      execution: local
         script: ab.js
         output: -
    
      scenarios: (100.00%) 1 scenario, 1 max VUs, 1m0s max duration (incl. graceful stop):
               * default: 1 looping VUs for 30s (gracefulStop: 30s)
    
    running (0m31.5s), 0/1 VUs, 13 complete and 0 interrupted iterations
    default âœ“ [======================================] 1 VUs  30s
    
         data_received..................: 461 kB 15 kB/s
         data_sent......................: 975 B  31 B/s
         http_req_blocked...............: avg=51.46Âµs min=2Âµs   med=4Âµs   max=620Âµs  p(90)=6Âµs     p(95)=251.59Âµs
         http_req_connecting............: avg=13.15Âµs min=0s    med=0s    max=171Âµs  p(90)=0s      p(95)=68.39Âµs 
         http_req_duration..............: avg=2.42s   min=2.29s med=2.33s max=3.32s  p(90)=2.58s   p(95)=2.91s   
           { expected_response:true }...: avg=2.42s   min=2.29s med=2.33s max=3.32s  p(90)=2.58s   p(95)=2.91s   
         http_req_failed................: 0.00%  âœ“ 0        âœ— 13 
         http_req_receiving.............: avg=424.3Âµs min=89Âµs  med=129Âµs max=3.54ms p(90)=554.6Âµs p(95)=1.8ms   
         http_req_sending...............: avg=28.92Âµs min=13Âµs  med=16Âµs  max=173Âµs  p(90)=24.6Âµs  p(95)=84.19Âµs 
         http_req_tls_handshaking.......: avg=0s      min=0s    med=0s    max=0s     p(90)=0s      p(95)=0s      
         http_req_waiting...............: avg=2.42s   min=2.28s med=2.33s max=3.32s  p(90)=2.58s   p(95)=2.91s   
         http_reqs......................: 13     0.412203/s
         iteration_duration.............: avg=2.42s   min=2.29s med=2.33s max=3.32s  p(90)=2.58s   p(95)=2.91s   
         iterations.....................: 13     0.412203/s
         vus............................: 1      min=1      max=1
         vus_max........................: 1      min=1      max=1
    ```
    
- ISUCONã§ã¯åˆæœŸåŒ–ã®ãŸã‚ã« `GET /initialize` ã¨ã„ã†URLã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹
- æ–°ã—ã„ã‚·ãƒŠãƒªã‚ª
    1. Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
    2. ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹å‡¦ç†
    3. ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ç”»åƒã‚’æŠ•ç¨¿ã™ã‚‹å‡¦ç†
    
    - URLã®å…±æœ‰ç”¨JS
        
        ```jsx
        // config.js
        const BASE_URL = "http://localhost";
        
        export function url(path) {
        	return `${BASE_URL}${path}`;
        }
        ```
        
    - åˆæœŸåŒ–å‡¦ç†ç”¨JS
        
        ```jsx
        // initialize.js
        import http from "k6/http";
        import { sleep } from "k6";
        import { url } from "./config.js";
        
        export default function() {
          http.get(url("/initialize"), {
            timeout: "10s",
          });
          sleep(1);
        }
        ```
        
    - åˆæœŸåŒ–ã®è² è·å®Ÿè¡Œ
        
        ```bash
        % k6 run --vus 1 initialize.js                                                                                                               [~/work/private-isu/k6/scinario-base-request]+[master]
        
                  /\      |â€¾â€¾| /â€¾â€¾/   /â€¾â€¾/   
             /\  /  \     |  |/  /   /  /    
            /  \/    \    |     (   /   â€¾â€¾\  
           /          \   |  |\  \ |  (â€¾)  | 
          / __________ \  |__| \__\ \_____/ .io
        
          execution: local
             script: initialize.js
             output: -
        
          scenarios: (100.00%) 1 scenario, 1 max VUs, 10m30s max duration (incl. graceful stop):
                   * default: 1 iterations for each of 1 VUs (maxDuration: 10m0s, gracefulStop: 30s)
        
        running (00m01.1s), 0/1 VUs, 1 complete and 0 interrupted iterations
        default âœ“ [======================================] 1 VUs  00m01.1s/10m0s  1/1 iters, 1 per VU
        
             data_received..................: 255 B 241 B/s
             data_sent......................: 85 B  80 B/s
             http_req_blocked...............: avg=1.18ms  min=1.18ms  med=1.18ms  max=1.18ms  p(90)=1.18ms  p(95)=1.18ms 
             http_req_connecting............: avg=198Âµs   min=198Âµs   med=198Âµs   max=198Âµs   p(90)=198Âµs   p(95)=198Âµs  
             http_req_duration..............: avg=52.12ms min=52.12ms med=52.12ms max=52.12ms p(90)=52.12ms p(95)=52.12ms
               { expected_response:true }...: avg=52.12ms min=52.12ms med=52.12ms max=52.12ms p(90)=52.12ms p(95)=52.12ms
             http_req_failed................: 0.00% âœ“ 0        âœ— 1  
             http_req_receiving.............: avg=169Âµs   min=169Âµs   med=169Âµs   max=169Âµs   p(90)=169Âµs   p(95)=169Âµs  
             http_req_sending...............: avg=706Âµs   min=706Âµs   med=706Âµs   max=706Âµs   p(90)=706Âµs   p(95)=706Âµs  
             http_req_tls_handshaking.......: avg=0s      min=0s      med=0s      max=0s      p(90)=0s      p(95)=0s     
             http_req_waiting...............: avg=51.25ms min=51.25ms med=51.25ms max=51.25ms p(90)=51.25ms p(95)=51.25ms
             http_reqs......................: 1     0.945969/s
             iteration_duration.............: avg=1.05s   min=1.05s   med=1.05s   max=1.05s   p(90)=1.05s   p(95)=1.05s  
             iterations.....................: 1     0.945969/s
             vus............................: 1     min=1      max=1
             vus_max........................: 1     min=1      max=1
        ```
        
    - ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã™ã‚‹JS
        
        ```jsx
        // comment.js
        import http from "k6/http";
        import { check } from "k6";
        import { parseHTML } from "k6/html";
        import { url } from "./config.js";
        
        export default function() {
          // login
          const login_res = http.post(url("/login"), {
            account_name: "terra",
            password: "terraterra",
          });
        
          check(login_res, {
            "is status 200": (r) => r.status === 200,
          });
          const res = http.get(url("/@terra"));
          const doc = parseHTML(res.body);
        
          const token = doc.find('input[name="csrf_token"]').first().attr("value");
          const post_id = doc.find('input[name="post_id"]').first().attr("value");
        
          // comment
          const comment_res = http.post(url("/comment"), {
            post_id: post_id,
            csrf_token: token,
            comment: "Hello k6!",
          });
        
          check(comment_res, {
            "is status 200": (r) => r.status === 200,
          });
        }
        ```
        
    - ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã®è² è·å®Ÿè¡Œ
        
        ```bash
        % k6 run --vus 1 comment.js                                                                                                                  [~/work/private-isu/k6/scinario-base-request]+[master]
        
                  /\      |â€¾â€¾| /â€¾â€¾/   /â€¾â€¾/   
             /\  /  \     |  |/  /   /  /    
            /  \/    \    |     (   /   â€¾â€¾\  
           /          \   |  |\  \ |  (â€¾)  | 
          / __________ \  |__| \__\ \_____/ .io
        
          execution: local
             script: comment.js
             output: -
        
          scenarios: (100.00%) 1 scenario, 1 max VUs, 10m30s max duration (incl. graceful stop):
                   * default: 1 iterations for each of 1 VUs (maxDuration: 10m0s, gracefulStop: 30s)
        
        running at file:///Users/takashimima/work/private-isu/k6/scinario-base-request/comment.js:18:24(40)
        default at native  executor=per-vu-iterations scenario=default source=stacktrace
        
        running (00m06.8s), 0/1 VUs, 1 complete and 0 interrupted iterations
        default âœ“ [======================================] 1 VUs  00m06.8s/10m0s  1/1 iters, 1 per VU
        
             âœ“ is status 200
        
             checks.........................: 100.00% âœ“ 1        âœ— 0  
             data_received..................: 72 kB   11 kB/s
             data_sent......................: 600 B   89 B/s
             http_req_blocked...............: avg=568.66Âµs min=2Âµs     med=4Âµs   max=1.7ms p(90)=1.36ms  p(95)=1.53ms 
             http_req_connecting............: avg=62.33Âµs  min=0s      med=0s    max=187Âµs p(90)=149.6Âµs p(95)=168.3Âµs
             http_req_duration..............: avg=2.25s    min=44.9ms  med=2.88s max=3.84s p(90)=3.65s   p(95)=3.75s  
               { expected_response:true }...: avg=2.25s    min=44.9ms  med=2.88s max=3.84s p(90)=3.65s   p(95)=3.75s  
             http_req_failed................: 0.00%   âœ“ 0        âœ— 3  
             http_req_receiving.............: avg=260Âµs    min=175Âµs   med=213Âµs max=392Âµs p(90)=356.2Âµs p(95)=374.1Âµs
             http_req_sending...............: avg=148.66Âµs min=14Âµs    med=18Âµs  max=414Âµs p(90)=334.8Âµs p(95)=374.4Âµs
             http_req_tls_handshaking.......: avg=0s       min=0s      med=0s    max=0s    p(90)=0s      p(95)=0s     
             http_req_waiting...............: avg=2.25s    min=44.09ms med=2.87s max=3.84s p(90)=3.65s   p(95)=3.75s  
             http_reqs......................: 3       0.442368/s
             iteration_duration.............: avg=6.77s    min=6.77s   med=6.77s max=6.77s p(90)=6.77s   p(95)=6.77s  
             iterations.....................: 1       0.147456/s
             vus............................: 1       min=1      max=1
             vus_max........................: 1       min=1      max=1
        ```
        
    - ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹JS
        
        ```jsx
        // postimage.js
        import http from "k6/http";
        import { parseHTML } from "k6/html";
        import { url } from "./config.js";
        
        const testImage = open("testImage.jpg", "b");
        
        export default function() {
          // login
          const res = http.post(url("/login"), {
            account_name: "terra",
            password: "terraterra",
          });
          const doc = parseHTML(res.body);
          const token = doc.find('input[name="csrf_token"]').first().attr("value");
          
          // post image
          http.post(url("/"), {
            file: http.file(testImage, "testimage.jpg", "image/jpeg"),
            body: "Posted by k6",
            csrf_token: token,
          });
        }
        ```
        
    - JSONã‚’èª­ã¿è¾¼ã‚€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®JS
        
        ```json
        [
            {
                "account_name":"terra",
                "password":"terraterra"
            },
            {
                "account_name":"sheri",
                "password":"sherisheri"
            },
            {
                "account_name":"janelle",
                "password":"janellejanelle"
            },
            {
                "account_name":"chasity",
                "password":"chasitychasity"
            }
        ]
        ```
        
        ```jsx
        // account.js
        import { SharedArray } import "k6/data";
        
        const accounts = new SharedArray('accounts', function() {
          return JSON.parse(open('./account.json'));
        });
        
        export function getAccount() {
          return accounts[Math.floor(Math.random() * accounts.length)];
        
        ```
        
        ```jsx
        import { getAccount } from "./account.js";
        
        function commentScenario() {
          const account = getAccount();
          const login_res = http.post(url("/login"), {
            account_name: account_name,
            password: account.password,
          });
        }
        ```
        
    - è¤‡æ•°ã®ã‚·ãƒŠãƒªã‚ªã‚’çµ„ã¿åˆã‚ã›ãŸçµ±åˆã‚·ãƒŠãƒªã‚ªç”¨JS
        
        ```jsx
        // integrated.js
        import initialize from "./initialize.js";
        import comment from "./comment.js";
        import postimage from "./postimage.js";
        
        export {
            initialize,
            comment,
            postimage
        };
        
        // The scinario is 
        // 1.   initialize    (0[s] ~10[s])
        // 2-1. leave comments(12[s]~42[s])
        // 2-2. post images   (12[s]~42[s])
        export const options = {
            scenarios: {
                initialize: {
                    executor: "shared-iterations", // multiple virtual users
                    vus: 1,
                    iterations: 1,
                    exec: "initialize",
                    maxDuration: "10s",
                },
                comment: {
                    executor: "constant-vus",
                    vus: 4,
                    duration: "30s",
                    exec: "comment",
                    startTime: "12s",
                },
                postImage: {
                    executor: "constant-vus",
                    vus: 2,
                    duration: "30s",
                    exec: "postimage",
                    startTime: "12s",
                },
            },
        };
        
        export default function() {}
        ```
        
    - è¤‡æ•°ã®ã‚·ãƒŠãƒªã‚ªã‚’çµ„ã¿åˆã‚ã›ãŸçµ±åˆã‚·ãƒŠãƒªã‚ªã®è² è·å®Ÿè¡Œ
        
        ```bash
        % k6 run integrated.js                                                                                                                       [~/work/private-isu/k6/scinario-base-request]+[master]
        
                  /\      |â€¾â€¾| /â€¾â€¾/   /â€¾â€¾/   
             /\  /  \     |  |/  /   /  /    
            /  \/    \    |     (   /   â€¾â€¾\  
           /          \   |  |\  \ |  (â€¾)  | 
          / __________ \  |__| \__\ \_____/ .io
        
          execution: local
             script: integrated.js
             output: -
        
          scenarios: (100.00%) 3 scenarios, 7 max VUs, 1m12s max duration (incl. graceful stop):
                   * initialize: 1 iterations shared among 1 VUs (maxDuration: 10s, exec: initialize, gracefulStop: 30s)
                   * comment: 4 looping VUs for 30s (exec: comment, startTime: 12s, gracefulStop: 30s)
                   * postImage: 2 looping VUs for 30s (exec: postimage, startTime: 12s, gracefulStop: 30s)
        
        running (0m44.4s), 0/7 VUs, 7 complete and 0 interrupted iterations
        initialize âœ“ [======================================] 1 VUs  01.1s/10s  1/1 shared iters
        comment    âœ“ [======================================] 4 VUs  30s       
        postImage  âœ“ [======================================] 2 VUs  30s       
        
             âœ“ is status 200
        
             checks.........................: 100.00% âœ“ 8        âœ— 0  
             data_received..................: 382 kB  8.6 kB/s
             data_sent......................: 32 kB   716 B/s
             http_req_blocked...............: avg=374.06Âµs min=2Âµs     med=4Âµs    max=5.99ms p(90)=979Âµs    p(95)=1.01ms  
             http_req_connecting............: avg=141Âµs    min=0s      med=0s     max=878Âµs  p(90)=609.59Âµs p(95)=844.4Âµs 
             http_req_duration..............: avg=6.61s    min=35.72ms med=3.29s  max=21.16s p(90)=16.82s   p(95)=19.67s  
               { expected_response:true }...: avg=6.61s    min=35.72ms med=3.29s  max=21.16s p(90)=16.82s   p(95)=19.67s  
             http_req_failed................: 0.00%   âœ“ 0        âœ— 29 
             http_req_receiving.............: avg=224.86Âµs min=69Âµs    med=99Âµs   max=2.15ms p(90)=271.99Âµs p(95)=693.39Âµs
             http_req_sending...............: avg=57.79Âµs  min=14Âµs    med=22Âµs   max=194Âµs  p(90)=167.8Âµs  p(95)=183.59Âµs
             http_req_tls_handshaking.......: avg=0s       min=0s      med=0s     max=0s     p(90)=0s       p(95)=0s      
             http_req_waiting...............: avg=6.61s    min=35.52ms med=3.29s  max=21.16s p(90)=16.82s   p(95)=19.67s  
             http_reqs......................: 29      0.653619/s
             iteration_duration.............: avg=27.54s   min=1.1s    med=31.94s max=32.36s p(90)=32.25s   p(95)=32.3s   
             iterations.....................: 7       0.15777/s
             vus............................: 3       min=0      max=6
             vus_max........................: 7       min=7      max=7
        ```
        
    - alpã®å®Ÿè¡Œçµæœ
        
        ```bash
        % alp json --sort sum -r -m "/posts/[0-9]+,/@\w+" -o count,method,uri,min,avg,max,sum --file ./access.log.20220610-135211                           [~/work/private-isu/webapp/logs/nginx]+[master]
        +-------+--------+---------------+--------+--------+--------+---------+
        | COUNT | METHOD |      URI      |  MIN   |  AVG   |  MAX   |   SUM   |
        +-------+--------+---------------+--------+--------+--------+---------+
        |    12 | GET    | /             |  2.451 |  8.737 | 15.176 | 104.846 |
        |     8 | GET    | /@\w+         | 11.055 | 12.770 | 14.676 | 102.158 |
        |     4 | POST   | /             |  2.214 |  9.666 | 12.875 |  38.665 |
        |    12 | POST   | /login        |  0.047 |  1.971 |  7.830 |  23.649 |
        |     4 | GET    | /posts/[0-9]+ |  0.120 |  3.518 | 11.152 |  14.073 |
        |     1 | GET    | /initialize   |  0.027 |  0.027 |  0.027 |   0.027 |
        +-------+--------+---------------+--------+--------+--------+---------+
        ```
        
        â€»`-m` ã§çµã‚Šè¾¼ã‚ãªã„ã®ã¯ã€ãã‚‚ãã‚‚ãã®ãƒ­ã‚°ãŒæ®‹ã£ã¦ãªã„ã‹ã‚‰
        
        ```bash
        % alp json --sort sum -r -m "/posts/[0-9]+,/@\w+" -o count,method,uri,min,avg,max,sum --file ./access.log.20220610-125756                           [~/work/private-isu/webapp/logs/nginx]+[master]
        +-------+--------+----------------------+-------+-------+-------+--------+
        | COUNT | METHOD |         URI          |  MIN  |  AVG  |  MAX  |  SUM   |
        +-------+--------+----------------------+-------+-------+-------+--------+
        |    15 | GET    | /                    | 2.288 | 2.498 | 3.502 | 37.466 |
        |     2 | GET    | /js/timeago.min.js   | 0.473 | 1.472 | 2.471 |  2.944 |
        |     2 | GET    | /js/main.js          | 0.460 | 1.459 | 2.458 |  2.918 |
        |     2 | GET    | /image/9998.jpg      | 0.408 | 1.320 | 2.232 |  2.640 |
        |     2 | GET    | /image/9999.jpg      | 0.120 | 1.302 | 2.485 |  2.605 |
        |     1 | GET    | /css/style.css       | 2.454 | 2.454 | 2.454 |  2.454 |
        |     2 | GET    | /image/10000.png     | 0.205 | 0.258 | 0.311 |  0.516 |
        |     2 | GET    | /image/9997.jpg      | 0.013 | 0.238 | 0.462 |  0.475 |
        |     1 | GET    | /image/9987.jpg      | 0.431 | 0.431 | 0.431 |  0.431 |
        |     1 | GET    | /image/9986.jpg      | 0.425 | 0.425 | 0.425 |  0.425 |
        |     2 | GET    | /image/9996.jpg      | 0.422 | 0.211 | 0.422 |  0.422 |
        |     1 | GET    | /image/9981.jpg      | 0.367 | 0.367 | 0.367 |  0.367 |
        |     1 | GET    | /image/9991.jpg      | 0.366 | 0.366 | 0.366 |  0.366 |
        |     1 | GET    | /image/9982.jpg      | 0.365 | 0.365 | 0.365 |  0.365 |
        |     1 | GET    | /image/9983.jpg      | 0.357 | 0.357 | 0.357 |  0.357 |
        |     1 | GET    | /image/9990.jpg      | 0.346 | 0.346 | 0.346 |  0.346 |
        |     1 | GET    | /image/9988.jpg      | 0.342 | 0.342 | 0.342 |  0.342 |
        |     1 | GET    | /image/9989.jpg      | 0.340 | 0.340 | 0.340 |  0.340 |
        |     1 | GET    | /image/9985.jpg      | 0.323 | 0.323 | 0.323 |  0.323 |
        |     1 | GET    | /image/9995.jpg      | 0.306 | 0.306 | 0.306 |  0.306 |
        |     1 | GET    | /image/9993.jpg      | 0.267 | 0.267 | 0.267 |  0.267 |
        |     1 | GET    | /image/9980.jpg      | 0.267 | 0.267 | 0.267 |  0.267 |
        |     1 | GET    | /image/9994.jpg      | 0.255 | 0.255 | 0.255 |  0.255 |
        |     1 | GET    | /img/ajax-loader.gif | 0.253 | 0.253 | 0.253 |  0.253 |
        |     2 | GET    | /image/10001.png     | 0.023 | 0.056 | 0.090 |  0.113 |
        |     1 | GET    | /favicon.ico         | 0.004 | 0.004 | 0.004 |  0.004 |
        +-------+--------+----------------------+-------+-------+-------+--------+
        deadbeef(23:05:24) ~/work/private-isu/webapp/logs/nginx
        ```
        
    

## 5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

- RDBMS
    - å¼·ã„ä¸€è²«æ€§ã‚’æŒã¤
        - ä¸€è²«æ€§ã¨ã¯ã€ã„ãã¤ã‚‚ã®è¡¨ã«ã‚ãŸã‚Šå‡¦ç†ã‚’è¡Œã‚ãªã‘ã‚Œã°ãªã‚‰ãªã„å ´åˆã§ã‚‚ç”Ÿåˆæˆã‚’ä¿ã¤æ€§è³ª
    - MySQL, MariaDB, PostgreSQL, SQLite
- NoSQL
    - å¼·ã„ä¸€è²«æ€§ã‚’æŒãŸãªã„ä»£ã‚ã‚Šã«é«˜é€Ÿãªå‡¦ç†ã‚’å®Ÿç¾ã™ã‚‹
    - ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã«ã‚ˆã£ã¦ã¯ã€è¤‡æ•°ã®ã‚µãƒ¼ãƒã«åˆ†æ•£ã—ã¦é«˜ã„ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã‚’æŒã¤
    - memcached, Redis, DynamoDB, Firebase Realtime Database, Cloud Firestore
- NewSQL
    - å¼·ã„ä¸€è²«æ€§ã¨é«˜ã„ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ãŠã‚ˆã³å¯ç”¨æ€§ã‚’æŒã¤
    - ä»£ã‚ã‚Šã«ã‚µãƒ¼ãƒã‚³ã‚¹ãƒˆã‚„ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã®éƒ¨åˆ†ã§åŠ£ã‚‹
    - Cloud Spanner, TiDB, Cockroach DB
- ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªã®å¯è¦–åŒ–
    - pt-query-digest
        - Installation
            
            [Installing Percona Toolkit](https://www.percona.com/doc/percona-toolkit/LATEST/installation.html)
            
            ```bash
            // Debianç³»
            sudo apt update
            sudo apt install percona-toolkit
            ```
            
            Slow Log Queryã®æœ‰åŠ¹åŒ–
            
            ```bash
            // /etc/my.cnf
            slow_query_log = 1
            slow_query_log_file = /var/log/mysql/mysql-slow.log
            long_query_time = 0
            ```
            
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    - **ã‚ˆãæ¡ä»¶ã®çµã‚Šè¾¼ã¿ã«ä½¿ã‚ã‚Œã‚‹å ´åˆã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è²¼ã‚Œ**
        - åˆ¤æ–­ã™ã‚‹ã«ã¯EXPLAINã‚’å…ˆé ­ã«ã¤ã‘ã¦å®Ÿè¡Œã—ã‚
        - è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚‚å¯èƒ½ã ãŒã€å¯èƒ½ãªé™ã‚Šå˜ä¸€ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ã™ã¹ã
    - **ä½•ã§ã‚‚ã‹ã‚“ã§ã‚‚ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è²¼ã‚‹ãªï¼ï¼ï¼**
        - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¿½åŠ ã€å‰Šé™¤ã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹
        - ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ãƒ»æ›´æ–°ã«ã‚‚æ™‚é–“ãŒã‹ã‹ã‚‹
    - ãƒ—ãƒ©ã‚¤ãƒãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        - ä¸»ã‚­ãƒ¼(PRIMARY KEY)ã«è²¼ã‚‰ã‚Œã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        - 1ãƒ†ãƒ¼ãƒ–ãƒ«ã«1ã¤ã—ã‹å­˜åœ¨ã§ããªã„
    - ã‚»ã‚«ãƒ³ãƒ€ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        - ãƒ—ãƒ©ã‚¤ãƒãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä»¥å¤–ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        - ãƒ—ãƒ©ã‚¤ãƒãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å‚ç…§ã—ãªã„ã§çµæœãŒè¿”ã›ã‚‹é«˜é€ŸåŒ–ã‚’Covering Indexã¨å‘¼ã¶
        - ä»¥ä¸‹ã®ä¾‹ã¯ãƒ—ãƒ©ã‚¤ãƒãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å‚ç…§ã›ãšã«çµæœãŒè¿”ã›ã‚‹ãŸã‚ã€ `user_id`ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è²¼ã‚‹ã“ã¨ã§é«˜é€ŸåŒ–ãŒæœŸå¾…ã§ãã‚‹
    
    ```sql
    SELECT COUNT(*) FROM comments WH
    E user_id = 123;
    ```
    
    - LIKEå¥ã‚’ç”¨ã„ã¦ã„ã‚‹å ´åˆã¯å…¨æ–‡æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒä½¿ãˆã‚‹
        
        ```sql
        SELECT * FROM comments WHERE comment LIKE '%hoge%'
        ```
        
        - BTree Indexã®æ€§è³ªä¸Šã€å‰æ–¹ä¸€è‡´ã«ã—ã‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’åˆ©ç”¨ã§ããªã„
        - MySQLã§ã¯å…¨æ–‡æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é©ç”¨ã§ãã‚‹
        
        ```sql
        ALTER TABLE comments ADD FULLTEXT INDEX comments_full_idx (comment) WITH PARSER ngram;
        ```
        
- N+1å•é¡Œ
    - ã¨ã‚Šã‚ãˆãš `JOIN` å¥ã§æ›¸ãç›´ã™ã¨è§£æ¶ˆã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹
        - QueryãŒPreloadã•ã‚Œã‚‹ãŸã‚
    - Cacheã™ã‚‹
        - 1åº¦ç›®ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé…ããªã‚‹å•é¡Œã¯è§£æ¶ˆã•ã‚Œãªã„
        - èµ·å‹•æ™‚ã«Cacheã‚’ç™»éŒ²ã™ã‚‹ã“ã¨ã§N+1ã®å•é¡Œã‚’å°ã•ãã™ã‚‹
    - Index
        - `ORDER BY` ç‹™ã„ã®Indexã¯ `FORCE INDEX` ã«ã—ãªã„ã¨æ©Ÿèƒ½ã—ãªã„ã“ã¨ãŒã‚ã‚‹
    - `SELECT *` ç³»ã®ã‚¯ã‚¨ãƒªã¯ç„¡é§„ã«å¤šãã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã“ã¨ã«ç¹‹ãŒã‚‹å ´åˆã‚‚ã‚ã‚‹
        - Columnã®å®£è¨€æ™‚ã« `INVISIBLE` ã‚’ä»˜ä¸ã™ã‚‹
    - Prepared Statementã¯åŠ¹ç‡ãŒè½ã¡ãŒã¡
        - æº–å‚™ãŠã‚ˆã³é–‹æ”¾(CLOSE)æ™‚ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’è¦ã™ã‚‹ãŸã‚
        - Goãªã‚‰ `[sql.Open](http://sql.Open)` ã®æ™‚ã«ã€ `interpolateParams=true` ã«ã™ã‚‹
- DBã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã®TCPã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³
    - Client
        - MaxIdleConnection(default value: 2)
            - idleæ™‚ã«ä¿æŒã—ã¦ãŠãã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³æ•°
        - MaxOpenConnection(default value: 0: inf)
            - æœ€å¤§æ¥ç¶šæ•°
    - DB
        - max_connections
            - `my.cnf` ã§è¨­å®šã§ãã‚‹
    
    ```sql
    [mysqld]
    max_connections = 65535
    ```
    
- innodbã®è¨­å®š(P162)

## 6. ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã®åˆ©ç”¨

- é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Nginxã‚µãƒ¼ãƒã‹ã‚‰ã‚µãƒ¼ãƒ–ã™ã‚‹ã¨ã

```
server {
  listen 80;

  # (snip)
  
	# js, jpg, png, css ã®æ‹¡å¼µå­ã‚’æŒã¤ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¨ã¦Nginxã‹ã‚‰è¿”ã™
	root /home/isucon/webapp/public/;

  location ~ .*\.(htm|html|css|js|jpg|png|gif|ico) {
    expires 24h;
    add_header Cache-Control public;
      
    open_file_cache max=100  # file descriptor ãªã©ã‚’ cache

    gzip on;  # cpu ä½¿ã†ã®ã§ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆè¦‹æ¥µã‚ã‚‹å¿…è¦ã‚ã‚Šã€‚gzip_static ä½¿ãˆã‚‹ãªã‚‰äº‹å‰ã«gzipåœ§ç¸®ã—ãŸä¸Šã§ãã¡ã‚‰ã‚’ä½¿ã†ã€‚
    gzip_types text/css application/javascript application/json application/font-woff application/font-tff image/gif image/png image/jpeg image/svg+xml image/x-icon application/octet-stream;
    gzip_disable "msie6";
    gzip_static on;  # nginx configureæ™‚ã« --with-http_gzip_static_module å¿…è¦
    gzip_vary on;
    gzip_min_length 1k; # gzipåœ§ç¸®ã™ã‚‹ã¨å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚ˆã‚Šã‚‚å¤§ãããªã‚‹ã“ã¨ãŒã‚ã‚‹
  }

  location / {
    proxy_set_header Host $host;
    proxy_pass http://localhost:8080;
  }
}
```

- **applicationå´ã§ã‚‚gzipåœ§ç¸®ã—ãŸæ–¹ãŒè‰¯ã„**
    - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚³ã‚¹ãƒˆã¯ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çš„ã«ã‚‚é‡‘éŠ­çš„ã«ã‚‚é«˜ãã€é«˜ã„ç¢ºç‡ã§ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã«ãªã‚‹ãŸã‚
    - gzipåœ§ç¸®ã™ã‚‹å‰æã§ã‚µãƒ¼ãƒã®CPUã‚’è€ƒæ…®ã—ãŸæ–¹ãŒè‰¯ã„
- keepaliveã«ã™ã‚‹ãŸã‚ã«ã¯(P179)
    - ãƒ¡ãƒªãƒƒãƒˆã¯ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã®ä½œã‚Šç›´ã—ã«ã‚ˆã‚‹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹ã‚„è² è·ã®å¢—åŠ ãŒæ¸›ã‚‹ã“ã¨
    - ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã¯keepaliveã‚’ç„¡åŠ¹ã«ã—ã¦ã„ã‚‹ã¨ãã‚ˆã‚Šã‚‚ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³æ•°ãŒå¢—ãˆã‚Œã°å¢—ãˆã‚‹ã»ã©ã‚µãƒ¼ãƒå´ã«è² è·ãŒã‹ã‹ã‚‹ã“ã¨
    - HTTP/2ã®åˆ©ç”¨
        - Nginxã§ `listen 443 ssl http2` ã¨ã—ã¦ãŠã‘ã°è‰¯ã„

## 7. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ´»ç”¨

- Thundering herd problem
    - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„å ´åˆã€å¤§é‡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒappã«æ¥ãŸå ´åˆã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«Originã«å¤§é‡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã„ãã“ã¨

## 8. æŠ¼ã•ãˆã¦ãŠããŸã„é«˜é€ŸåŒ–æ‰‹æ³•

- **å¤–éƒ¨ã‚³ãƒãƒ³ãƒ‰ã§ã¯ãªããƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã™ã‚‹**
    - opensslã‚³ãƒãƒ³ãƒ‰ã‚’shã§å®Ÿè¡Œã™ã‚‹ã®ã§ã¯ãªãã€è¨€èªå´ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã—ãŸæ–¹ãŒã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒå°ã•ããªã‚‹
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§å†—é•·ãªãƒ­ã‚°ã‚’å‡ºåŠ›ã—ãªã„
    - ãƒ­ã‚°å‡ºåŠ›ã¯ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚¿ã‚’ãƒ­ãƒƒã‚¯ã™ã‚‹ä¸Šã«æ™‚é–“ãŒã‹ã‹ã‚‹
- Goã®HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã¤ã„ã¦
    - ****[Goã§net/httpã‚’ä½¿ã†æ™‚ã®ã“ã¾ã”ã¾ã¨ã—ãŸæ³¨æ„](https://qiita.com/ono_matope/items/60e96c01b43c64ed1d18)****
- é™çš„ãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡ã‚’ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‹ã‚‰ç›´æ¥é…ä¿¡ã™ã‚‹
    - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¸¯åŸŸãŒé€¼è¿«ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚
    - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒã®ãƒ¡ãƒ¢ãƒªã‚’é£Ÿã„æ½°ã•ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚
- HTTPãƒ˜ãƒƒãƒ€ã‚’ç”¨ã„ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã›ã‚‹
    - `Cache-Control: max-age=86400` ã®ã‚ˆã†ãªãƒ˜ãƒƒãƒ€
    - Nginxã§ã‚ã‚Œã° `expires` ã‚’è¨­å®šã—ã¦ãŠã‘ã° ğŸ†—
- CDNâ€¦â€¦ã¯ISUCONã«ãŠã„ã¦ã¯å¤šåˆ†æ°—ã«ã—ãªãã¦è‰¯ã•ãã†

## 9. OSã®åŸºç¤çŸ¥è­˜ã¨ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

- Linuxã¯OSã¨ã—ã¦ã®ã‚³ã‚¢æ©Ÿèƒ½ã‚’Linux Kernelã¨å‘¼ã°ã‚Œã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãŒæ‹…ã£ã¦ã„ã‚‹
- OSä¸Šã§å‹•ä½œã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã¨å‘¼ã°ã‚Œã‚‹å‘½ä»¤ã‚’ç”¨ã„ã¦Linux Kernelã®æ©Ÿèƒ½ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨OSã®ã‚³ã‚¢éƒ¨åˆ†ã®é–“ã«ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’è¨­ã‘ã¦å®Ÿè£…ã‚’åˆ†å‰²ã™ã‚‹ã“ã¨ã§ã€**æ§˜ã€…ãªãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã”ã¨ã®é•ã„ã‚’OSä¸Šã§å‹•ä½œã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒOSã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ãŠã‘ã‚‹é•ã„ã‚’æ„è­˜ã™ã‚‹ã“ã¨ãªãåˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹**
- èª­ã¿æ›¸ãã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã©ã®ã‚ˆã†ãªãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã§æ›¸ãè¾¼ã¾ã‚Œã¦ã„ã¦ã€ã©ã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ä¸Šã§èª­ã¿æ›¸ããŒè¡Œã‚ã‚Œã‚‹ã®ã‹ã‚’æŒ‡å®šã™ã‚‹ã‚‚ã®ã§ã¯ãªã„
    - ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚„OSãƒ¬ã‚¤ãƒ¤ã®ã‚·ã‚¹ãƒ†ãƒ ã‚’éš è”½ã—ã¦ã„ã‚‹ã“ã¨ã«ã‚ˆã‚‹æ©æµ
- open(2)ã®2ã¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ç•ªå·
    - [https://atmarkit.itmedia.co.jp/flinux/rensai/linuxtips/073mannum.html](https://t.co/RyLxxLmS6u)
- Linux Kernelå´ã‚’ã‚«ãƒ¼ãƒãƒ«ç©ºé–“
- ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã™ã‚‹LinuxOSä¸Šã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå‹•ä½œã™ã‚‹éƒ¨åˆ†ã‚’ãƒ¦ãƒ¼ã‚¶ç©ºé–“ã¨å‘¼ã¶
- ã‚«ãƒ¼ãƒãƒ«ç©ºé–“ã§å‡¦ç†ãŒå®Œçµã™ã‚‹å ´åˆã¯ã€ãƒ¦ãƒ¼ã‚¶ç©ºé–“ã¨æ¯”è¼ƒã—ã¦ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒå°‘ãªãã€ã‚ˆã‚Šé«˜é€Ÿã«å‹•ä½œã™ã‚‹å‚¾å‘ã«ã‚ã‚‹
- ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãªã©ã€é€Ÿåº¦ãŒè¦æ±‚ã•ã‚Œã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ç›´æ¥ã‚«ãƒ¼ãƒãƒ«ç©ºé–“ã§å‡¦ç†ã‚’è¡Œã†ã‚ˆã†å®Ÿè£…ã™ã‚‹ä¾‹ã‚‚ãŸãã•ã‚“ã‚ã‚‹
- ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ
    - ä¸€å®šæ™‚é–“ã§å‡¦ç†ã§ãã‚‹ãƒ‘ã‚±ãƒƒãƒˆã®é‡
- ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·
    - é€šä¿¡ã‚’é–‹å§‹ã—ã¦ã‹ã‚‰çµ‚äº†ã™ã‚‹ã¾ã§ã®æ‰€è¦æ™‚é–“
- HDD
    - ã‚·ãƒ¼ã‚±ãƒ³ã‚·ãƒ£ãƒ«ãƒªãƒ¼ãƒ‰/ãƒ©ã‚¤ãƒˆ > ãƒ©ãƒ³ãƒ€ãƒ ãƒªãƒ¼ãƒ‰/ãƒ©ã‚¤ãƒˆ
- ä»®æƒ³ãƒ‡ã‚£ã‚¹ã‚¯
    - ãƒ©ãƒ³ãƒ€ãƒ ãƒªãƒ¼ãƒ‰/ãƒ©ã‚¤ãƒˆ > ã‚·ãƒ¼ã‚±ãƒ³ã‚·ãƒ£ãƒ«ãƒªãƒ¼ãƒ‰/ãƒ©ã‚¤ãƒˆ

---

- Linuxã‚«ãƒ¼ãƒãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    - `net.core.somaxconn`
        - HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚Œã‚‹ã‚½ã‚±ãƒƒãƒˆã®æœ€å¤§æ•°
    - `net.ipv4.ip_local_port_range`
        - Ephemeral Portsã®å¹…

## private-isuã®æ”»ç•¥

1. commentsãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ã™ã‚‹
2. é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Nginxã§é…ä¿¡ã™ã‚‹
3. ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒã‚’é™çš„ãƒ•ã‚¡ã‚¤ãƒ«åŒ–ã™ã‚‹
4. N+1ã®è§£æ±º(JOINã‚’åˆ©ç”¨ã™ã‚‹)
5. prepared statementã‚’é™¤å»ã™ã‚‹
6. commentsãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ã™ã‚‹
7. N+1çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹
8. é©åˆ‡ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’åˆ©ç”¨ã§ããªã„ã‚¯ã‚¨ãƒªã‚’æ›¸ãæ›ãˆã‚‹
9. å¤–éƒ¨ã‚³ãƒãƒ³ãƒ‰ã®å‘¼ã³å‡ºã—ã‚’æ­¢ã‚ã‚‹
10. MySQLã®ãƒ­ã‚°ã‚’æ®‹ã•ãªã„ã‚ˆã†ã«ã™ã‚‹
11. memcachedã¸ã®N+1ã®ä¿®æ­£
