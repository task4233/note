(window.webpackJsonp=window.webpackJsonp||[]).push([[34],{396:function(e,t,a){"use strict";a.r(t);var r=a(28),_=Object(r.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"pe-portable-executable-ファイルフォーマットの基本構造-めも"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pe-portable-executable-ファイルフォーマットの基本構造-めも"}},[e._v("#")]),e._v(" PE(Portable Executable)ファイルフォーマットの基本構造 めも")]),e._v(" "),a("p",[e._v("ref: "),a("a",{attrs:{href:"http://hp.vector.co.jp/authors/VA050396/tech_06.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("PE(Portable Executable)ファイルフォーマット その1 ファイルの基本構造"),a("OutboundLink")],1)]),e._v(" "),a("h2",{attrs:{id:"pe-portable-executable-format"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pe-portable-executable-format"}},[e._v("#")]),e._v(" PE(Portable Executable) format")]),e._v(" "),a("ul",[a("li",[e._v("Windowsのローダが認識する実行可能ファイルのフォーマット")]),e._v(" "),a("li",[e._v(".binにしてCreateProcess()やLoadLibrary(), LoadLibraryEx()でロードできる")]),e._v(" "),a("li",[e._v("他にNE, LEフォーマットがある")])]),e._v(" "),a("h2",{attrs:{id:"ヘッダ"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ヘッダ"}},[e._v("#")]),e._v(" ヘッダ")]),e._v(" "),a("ul",[a("li",[e._v("先頭から順に3つのヘッダがある")]),e._v(" "),a("li",[e._v("MS-DOS用ヘッダおよびプログラム")]),e._v(" "),a("li",[e._v("NTヘッダ")]),e._v(" "),a("li",[e._v("セクションテーブルおよびセクションデータ")])]),e._v(" "),a("h3",{attrs:{id:"ms-dosヘッダおよびプログラム"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ms-dosヘッダおよびプログラム"}},[e._v("#")]),e._v(" MS-DOSヘッダおよびプログラム")]),e._v(" "),a("ul",[a("li",[e._v("MS-DOSヘッダ\n"),a("ul",[a("li",[e._v("最初のe_magicは"),a("code",[e._v("MZ")]),e._v(", "),a("code",[e._v("4D5A")])]),e._v(" "),a("li",[e._v("e_lfanewはMS-DOS領域の後にくるNTヘッダの位置を表している\n"),a("ul",[a("li",[e._v("NTヘッダの位置は"),a("a",{attrs:{href:"https://docs.microsoft.com/en-us/windows/win32/api/dbghelp/nf-dbghelp-imagentheader?redirectedfrom=MSDN",target:"_blank",rel:"noopener noreferrer"}},[e._v("ImageNtHeader"),a("OutboundLink")],1),e._v("という関数でも得られる")]),e._v(" "),a("li",[a("blockquote",[a("p",[e._v("Locates the IMAGE_NT_HEADERS structure in a PE image and returns a pointer to the data.")])])])])])])]),e._v(" "),a("li",[e._v("MS-DOS Real-Mode Stub Program\n"),a("ul",[a("li",[e._v("制限なし")]),e._v(" "),a("li",[e._v("これらのヘッダによって"),a("code",[e._v("This program cannnot be run in DOS mode.")]),e._v("を出力する")])])])]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("// WinNT.h\n// WINDOWS SDK winnt.h\ntypedef struct _IMAGE_DOS_HEADER {      // DOS .EXE header\n    WORD   e_magic;                     // Magic number\n    WORD   e_cblp;                      // Bytes on last page of file\n    WORD   e_cp;                        // Pages in file\n    WORD   e_crlc;                      // Relocations\n    WORD   e_cparhdr;                   // Size of header in paragraphs\n    WORD   e_minalloc;                  // Minimum extra paragraphs needed\n    WORD   e_maxalloc;                  // Maximum extra paragraphs needed\n    WORD   e_ss;                        // Initial (relative) SS value\n    WORD   e_sp;                        // Initial SP value\n    WORD   e_csum;                      // Checksum\n    WORD   e_ip;                        // Initial IP value\n    WORD   e_cs;                        // Initial (relative) CS value\n    WORD   e_lfarlc;                    // File address of relocation table\n    WORD   e_ovno;                      // Overlay number\n    WORD   e_res[4];                    // Reserved words\n    WORD   e_oemid;                     // OEM identifier (for e_oeminfo)\n    WORD   e_oeminfo;                   // OEM information; e_oemid specific\n    WORD   e_res2[10];                  // Reserved words\n    LONG   e_lfanew;                    // File address of new exe header\n  } IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;\n")])])]),a("h3",{attrs:{id:"ntヘッダ"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ntヘッダ"}},[e._v("#")]),e._v(" NTヘッダ")]),e._v(" "),a("ul",[a("li",[e._v("マジックナンバとヘッダのかたまり")]),e._v(" "),a("li",[e._v("以下の3つを持っている\n"),a("ul",[a("li",[e._v("Signature")]),e._v(" "),a("li",[e._v("FileHeader")]),e._v(" "),a("li",[e._v("OptionalHeader")])])])]),e._v(" "),a("h4",{attrs:{id:"signature"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#signature"}},[e._v("#")]),e._v(" Signature")]),e._v(" "),a("ul",[a("li",[e._v("ファイル形式を示すSignature")]),e._v(" "),a("li",[e._v("以下の通り定義されているDWORD(32bit)の値")])]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"center"}},[e._v("形式")]),e._v(" "),a("th",{staticStyle:{"text-align":"center"}},[e._v("値(hex)")]),e._v(" "),a("th",{staticStyle:{"text-align":"center"}},[e._v("値(ASCII)")])])]),e._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"center"}},[e._v("IMAGE_DOS_SIGNATURE")]),e._v(" "),a("td",{staticStyle:{"text-align":"center"}},[e._v("0x4D5A")]),e._v(" "),a("td",{staticStyle:{"text-align":"center"}},[e._v("MZ")])]),e._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[e._v("IMAGE_OS2_SIGNATURE")]),e._v(" "),a("td",{staticStyle:{"text-align":"center"}},[e._v("0x4E45")]),e._v(" "),a("td",{staticStyle:{"text-align":"center"}},[e._v("NE")])]),e._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[e._v("IMAGE_OS2_SIGNATURE_LE")]),e._v(" "),a("td",{staticStyle:{"text-align":"center"}},[e._v("0x4C45")]),e._v(" "),a("td",{staticStyle:{"text-align":"center"}},[e._v("LE")])]),e._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[e._v("IMAGE_NT_SIGNATURE")]),e._v(" "),a("td",{staticStyle:{"text-align":"center"}},[e._v("0x50450000")]),e._v(" "),a("td",{staticStyle:{"text-align":"center"}},[e._v("PE00")])])])]),e._v(" "),a("h4",{attrs:{id:"file-header"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#file-header"}},[e._v("#")]),e._v(" File Header")]),e._v(" "),a("ul",[a("li",[e._v("IMAGE_FILE_HEAD")])]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("typedef struct _IMAGE_FILE_HEADER {\n    WORD    Machine;\n    WORD    NumberOfSections;\n    DWORD   TimeDateStamp;\n    DWORD   PointerToSymbolTable; // 0\n    DWORD   NumberOfSymbols;      // 0\n    WORD    SizeOfOptionalHeader; // size of optional header continuing file header\n    WORD    Characteristics;      // flags\n} IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;\n\n#define IMAGE_SIZEOF_FILE_HEADER             20\n")])])]),a("ul",[a("li",[e._v("machine\n"),a("ul",[a("li",[e._v("ファイルの対象マシン")]),e._v(" "),a("li",[a("code",[e._v("IMAGE_FILE_MACHINE_XXX")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("IMAGE_FILE_MACHINE_I386(0x14c)")]),e._v(": x86")]),e._v(" "),a("li",[a("code",[e._v("IMAGE_FILE_MACHINE_UNKNOWN(0)")]),e._v(": x86")])])])])])]),e._v(" "),a("h4",{attrs:{id:"optional-header"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#optional-header"}},[e._v("#")]),e._v(" Optional Header")]),e._v(" "),a("ul",[a("li",[e._v("Magic\n"),a("ul",[a("li",[e._v("通常は0x10")]),e._v(" "),a("li",[e._v("PE+は64bit用")])])])]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"center"}},[e._v("形式")]),e._v(" "),a("th",{staticStyle:{"text-align":"center"}},[e._v("値(hex)")])])]),e._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"center"}},[e._v("PE32")]),e._v(" "),a("td",{staticStyle:{"text-align":"center"}},[e._v("0x10b")])]),e._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[e._v("PE+")]),e._v(" "),a("td",{staticStyle:{"text-align":"center"}},[e._v("0x20b")])]),e._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[e._v("ROM")]),e._v(" "),a("td",{staticStyle:{"text-align":"center"}},[e._v("0x107")])])])]),e._v(" "),a("ul",[a("li",[e._v("AddressOfEntryPoint\n"),a("ul",[a("li",[e._v("エントリポイント(実行開始位置)のアドレス")]),e._v(" "),a("li",[e._v("RVA(Relative Virtual Addres): 相対仮想アドレスが表されている\n"),a("ul",[a("li",[e._v("物理アドレスからイメージのロードアドレスを引いた値のこと")]),e._v(" "),a("li",[e._v("仮想アドレス + ロードアドレス = 物理アドレス")])])])])]),e._v(" "),a("li",[e._v("BaseOfCode\n"),a("ul",[a("li",[e._v("メモリにロードされるときにのコード開始セクションのRVA(相対仮想アドレス)")])])]),e._v(" "),a("li",[e._v("BaseOfCodeは実行可能なCodeSection(.text)の先頭アドレスで, AddressOfEntryPointはそのファイルが実行される際に呼び出されるentryアドレスであるという違いがある")]),e._v(" "),a("li",[e._v("基本的に, AddressOfEntryPointはBaseOfCodeと異なる\n"),a("ul",[a("li",[e._v("ref: "),a("a",{attrs:{href:"https://stackoverflow.com/questions/9613867/address-of-entry-point",target:"_blank",rel:"noopener noreferrer"}},[e._v("Address of entry point"),a("OutboundLink")],1)]),e._v(" "),a("li",[e._v("ref: "),a("a",{attrs:{href:"https://docs.microsoft.com/ja-jp/windows/win32/debug/pe-format#optional-header-standard-fields-image-only",target:"_blank",rel:"noopener noreferrer"}},[e._v("PE Format > Optional Header Standard Fields (Image Only)"),a("OutboundLink")],1)])])])])])}),[],!1,null,null,null);t.default=_.exports}}]);